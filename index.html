<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Aditya Fertilizers - Professional Accounting Ledger</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
:root {
  --primary: #0f766e;
  --primary-dark: #065f57;
  --secondary: #047857;
  --danger: #dc2626;
  --warning: #d97706;
  --success: #059669;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --text-muted: #64748b;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

.header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--primary);
  margin-bottom: 0.5rem;
}

.nav-links {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
  justify-content: center;
}

.nav-btn {
  padding: 0.5rem 0.75rem;
  border: none;
  border-radius: 0.5rem;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  font-size: 0.875rem;
}

.nav-btn:hover {
  background: var(--primary);
  color: white;
}

.nav-btn.active {
  background: var(--primary);
  color: white;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1rem;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: var(--card);
  padding: 1.25rem;
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.stat-title {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.stat-change {
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.positive { color: var(--success); }
.negative { color: var(--danger); }
.warning { color: var(--warning); }

.card {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 1.5rem;
}

.card-header {
  padding: 1.25rem 1.25rem 0;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.card-title {
  font-size: 1.125rem;
  font-weight: 600;
}

.card-content {
  padding: 1.25rem;
}

.table-container {
  overflow-x: auto;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

.table th,
.table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: var(--text-muted);
}

.table tr:hover {
  background: #f8fafc;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.875rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--border);
  color: var(--text);
}

.btn-secondary:hover {
  background: #cbd5e1;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
}

.form-group {
  margin-bottom: 1rem;
}

.label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.input,
.select,
.textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  font-size: 0.875rem;
  transition: border-color 0.2s;
}

.input:focus,
.select:focus,
.textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modal {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 1.25rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
}

.modal-content {
  padding: 1.25rem;
}

.modal-footer {
  padding: 1.25rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  display: inline-block;
}

.badge-success { background: #dcfce7; color: var(--success); }
.badge-danger { background: #fecaca; color: var(--danger); }
.badge-warning { background: #fef3c7; color: var(--warning); }
.badge-secondary { background: #f1f5f9; color: var(--text-muted); }

.search-bar {
  position: relative;
  margin-bottom: 1rem;
}

.search-input {
  padding-left: 2.5rem;
}

.search-icon {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.filters {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.loader {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.text-right { text-align: right; }
.text-center { text-align: center; }
.font-medium { font-weight: 500; }
.text-sm { font-size: 0.875rem; }
.text-xs { font-size: 0.75rem; }

.grid {
  display: grid;
  gap: 1rem;
}

.grid-cols-1 {
  grid-template-columns: 1fr;
}

.grid-cols-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-cols-3 {
  grid-template-columns: repeat(3, 1fr);
}

.hidden {
  display: none !important;
}

.flex {
  display: flex;
}

.justify-between {
  justify-content: space-between;
}

.items-center {
  align-items: center;
}

.py-3 {
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
}

.border-b {
  border-bottom: 1px solid var(--border);
}

.border-gray-100 {
  border-color: #f3f4f6;
}

.hover\:bg-gray-50:hover {
  background-color: #f9fafb;
}

.cursor-pointer {
  cursor: pointer;
}

.flex-1 {
  flex: 1;
}

.gap-2 {
  gap: 0.5rem;
}

.text-gray-500 {
  color: #6b7280;
}

.mb-4 {
  margin-bottom: 1rem;
}

.mt-6 {
  margin-top: 1.5rem;
}

.space-y-4 > * + * {
  margin-top: 1rem;
}

.pb-4 {
  padding-bottom: 1rem;
}

.text-lg {
  font-size: 1.125rem;
}

.text-xl {
  font-size: 1.25rem;
}

.font-bold {
  font-weight: 700;
}

.font-semibold {
  font-weight: 600;
}

.text-green-600 {
  color: #059669;
}

.text-red-600 {
  color: #dc2626;
}

.bg-gray-50 {
  background-color: #f9fafb;
}

.p-4 {
  padding: 1rem;
}

.rounded {
  border-radius: 0.5rem;
}

.border-t {
  border-top: 1px solid var(--border);
}

.pt-2 {
  padding-top: 0.5rem;
}

/* Responsive adjustments */
@media (min-width: 640px) {
  .header {
    flex-direction: row;
    padding: 1rem 1.5rem;
  }
  
  .logo {
    margin-bottom: 0;
  }
  
  .nav-links {
    gap: 1rem;
  }
  
  .nav-btn {
    padding: 0.5rem 1rem;
    font-size: 1rem;
  }
  
  .container {
    padding: 1.5rem;
  }
  
  .card-header {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
  }
  
  .filters {
    flex-direction: row;
  }
}

@media (min-width: 768px) {
  .dashboard-grid {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .stat-card {
    padding: 1.5rem;
  }
  
  .stat-value {
    font-size: 2rem;
  }
  
  .card-header {
    padding: 1.5rem 1.5rem 0;
  }
  
  .card-content {
    padding: 1.5rem;
  }
  
  .modal-header {
    padding: 1.5rem;
  }
  
  .modal-content {
    padding: 1.5rem;
  }
  
  .modal-footer {
    padding: 1.5rem;
  }
}

@media (min-width: 1024px) {
  .container {
    padding: 2rem;
  }
  
  .grid-cols-2 {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .grid-cols-3 {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 767px) {
  .grid-cols-2,
  .grid-cols-3 {
    grid-template-columns: 1fr;
  }
  
  .table {
    font-size: 0.75rem;
  }
  
  .table th,
  .table td {
    padding: 0.5rem;
  }
  
  .btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
  }
  
  .filters {
    flex-direction: column;
  }
  
  .filters .select,
  .filters .input {
    width: 100%;
  }
}

/* Print styles for reports */
@media print {
  .header,
  .nav-links,
  .modal-footer,
  .btn {
    display: none !important;
  }
  
  .container {
    padding: 0;
    max-width: 100%;
  }
  
  .card {
    box-shadow: none;
    border: none;
  }
}
</style>
</head>
<body>
<div class="loader" id="loader">
  <div class="spinner"></div>
</div>

<header class="header">
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
    </svg>
    Aditya Fertilizers - Accounting Ledger
  </div>
  <nav class="nav-links">
    <button class="nav-btn active" data-section="dashboard">Dashboard</button>
    <button class="nav-btn" data-section="accounts">Accounts</button>
    <button class="nav-btn" data-section="transactions">Transactions</button>
    <button class="nav-btn" data-section="reports">Reports</button>
    <button class="nav-btn" data-section="settings">Settings</button>
  </nav>
</header>

<main class="container">
  <!-- Dashboard Section -->
  <div id="dashboard-section" class="section">
    <div class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-title">Total Receivables</div>
        <div class="stat-value" id="totalReceivables">₹0</div>
        <div class="stat-change positive">
          <span>Outstanding from customers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Payables</div>
        <div class="stat-value" id="totalPayables">₹0</div>
        <div class="stat-change negative">
          <span>Outstanding to suppliers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Overall Balance</div>
        <div class="stat-value" id="netPosition">₹0</div>
        <div class="stat-change" id="netPositionChange">
          <span>Overall financial position</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">This Month Sales</div>
        <div class="stat-value" id="monthSales">₹0</div>
        <div class="stat-change positive">
          <span>Current month revenue</span>
        </div>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Financial Overview</h2>
        </div>
        <div class="card-content">
          <canvas id="financialChart" height="300"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Recent Transactions</h2>
          <button class="btn btn-primary btn-sm" id="addTransactionBtn">Add New</button>
        </div>
        <div class="card-content">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Account</th>
                  <th>Type</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="recentTransactions">
                <tr><td colspan="4" class="text-center">Loading transactions...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts Section -->
  <div id="accounts-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Account Management</h2>
        <div class="actions">
          <button class="btn btn-primary" id="addAccountBtn">Add Account</button>
        </div>
      </div>
      <div class="card-content">
        <div class="search-bar">
          <input type="text" class="input search-input" id="accountSearch" placeholder="Search accounts...">
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="accountsList">
              <tr><td colspan="5" class="text-center">Loading accounts...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions Section -->
  <div id="transactions-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Transaction History</h2>
        <div class="actions">
          <button class="btn btn-primary" id="addTransactionBtn2">Add Transaction</button>
        </div>
      </div>
      <div class="card-content">
        <div class="filters">
          <div class="form-group">
            <select class="select" id="transactionTypeFilter">
              <option value="">All Types</option>
              <option value="sale">Sale</option>
              <option value="purchase">Purchase</option>
              <option value="payment">Payment</option>
              <option value="receipt">Receipt</option>
              <option value="expense">Expense</option>
            </select>
          </div>
          <div class="form-group">
            <select class="select" id="accountFilter">
              <option value="">All Accounts</option>
            </select>
          </div>
          <div class="form-group">
            <input type="date" class="input" id="dateFromFilter">
          </div>
          <div class="form-group">
            <input type="date" class="input" id="dateToFilter">
          </div>
          <button class="btn btn-secondary" id="applyFiltersBtn">Apply</button>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Account</th>
                <th>Type</th>
                <th>Description</th>
                <th>Debit</th>
                <th>Credit</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="transactionsList">
              <tr><td colspan="8" class="text-center">Loading transactions...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Section -->
  <div id="reports-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Financial Reports</h2>
        <div class="actions">
          <button class="btn btn-primary" id="generateReportBtn">Generate Report</button>
        </div>
      </div>
      <div class="card-content">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="form-group">
            <label class="label">Report Type</label>
            <select class="select" id="reportType">
              <option value="profitLoss">Profit & Loss Statement</option>
              <option value="balanceSheet">Balance Sheet</option>
              <option value="cashFlow">Cash Flow Statement</option>
              <option value="trialBalance">Trial Balance</option>
            </select>
          </div>
          <div class="form-group">
            <label class="label">From Date</label>
            <input type="date" class="input" id="reportFromDate">
          </div>
          <div class="form-group">
            <label class="label">To Date</label>
            <input type="date" class="input" id="reportToDate">
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" id="reportTitle">Report Preview</h3>
          </div>
          <div class="card-content">
            <div id="reportContent">
              <p class="text-center text-gray-500">Select report parameters and generate to view</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Section -->
  <div id="settings-section" class="section hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">System Settings</h2>
        </div>
        <div class="card-content">
          <div class="form-group">
            <label class="label">Business Name</label>
            <input type="text" class="input" id="businessName" value="Aditya Fertilizers">
          </div>
          <div class="form-group">
            <label class="label">Currency</label>
            <select class="select" id="currency">
              <option value="INR" selected>Indian Rupee (₹)</option>
              <option value="USD">US Dollar ($)</option>
              <option value="EUR">Euro (€)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="label">Financial Year Start</label>
            <input type="date" class="input" id="financialYearStart" value="2024-04-01">
          </div>
          <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">System Maintenance</h2>
        </div>
        <div class="card-content">
          <div class="form-group">
            <label class="label">Admin Password</label>
            <input type="password" class="input" id="adminPassword" placeholder="Enter password to enable admin functions">
          </div>
          <div class="space-y-4">
            <button class="btn btn-secondary w-full" id="clearDuplicatesBtn" disabled>Clear Duplicate Entries</button>
            <button class="btn btn-secondary w-full" id="clearCacheBtn" disabled>Clear Cache</button>
            <button class="btn btn-danger w-full" id="resetSystemBtn" disabled>Reset System Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Add Account Modal -->
<div class="modal-backdrop hidden" id="accountModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Add New Account</h2>
      <button class="btn btn-secondary btn-sm" id="closeAccountModal">✕</button>
    </div>
    <div class="modal-content">
      <form id="accountForm">
        <div class="form-group">
          <label class="label">Account Name</label>
          <input type="text" class="input" id="accountName" required>
        </div>
        <div class="form-group">
          <label class="label">Account Type</label>
          <select class="select" id="accountType" required>
            <option value="">Select Type</option>
            <option value="customer">Customer (Receivable)</option>
            <option value="supplier">Supplier (Payable)</option>
            <option value="bank">Bank Account</option>
            <option value="cash">Cash Account</option>
            <option value="income">Income Account</option>
            <option value="expense">Expense Account</option>
            <option value="asset">Asset Account</option>
            <option value="liability">Liability Account</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label">Opening Balance</label>
          <input type="number" class="input" id="accountBalance" value="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="label">Contact Information</label>
          <textarea class="textarea" id="accountContact" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="cancelAccountBtn">Cancel</button>
      <button class="btn btn-primary" id="saveAccountBtn">Save Account</button>
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal-backdrop hidden" id="transactionModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Add New Transaction</h2>
      <button class="btn btn-secondary btn-sm" id="closeTransactionModal">✕</button>
    </div>
    <div class="modal-content">
      <form id="transactionForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label class="label">Date</label>
            <input type="date" class="input" id="transactionDate" required>
          </div>
          <div class="form-group">
            <label class="label">Transaction Type</label>
            <select class="select" id="transactionType" required>
              <option value="">Select Type</option>
              <option value="sale">Sale</option>
              <option value="purchase">Purchase</option>
              <option value="payment">Payment</option>
              <option value="receipt">Receipt</option>
              <option value="expense">Expense</option>
              <option value="adjustment">Adjustment</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="label">Account</label>
          <select class="select" id="transactionAccount" required>
            <option value="">Select Account</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label">Description</label>
          <input type="text" class="input" id="transactionDescription" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label class="label">Amount (₹)</label>
            <input type="number" class="input" id="transactionAmount" step="0.01" min="0" required>
          </div>
          <div class="form-group">
            <label class="label">Reference No.</label>
            <input type="text" class="input" id="transactionReference">
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="cancelTransactionBtn">Cancel</button>
      <button class="btn btn-primary" id="saveTransactionBtn">Save Transaction</button>
    </div>
  </div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC4mOkOzi0lO0LvV9p2dYqLd9J8N7Z8X7A",
  authDomain: "aditya-fertilizers-ledger.firebaseapp.com",
  projectId: "aditya-fertilizers-ledger",
  storageBucket: "aditya-fertilizers-ledger.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abcd1234567890ef"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global variables
let accounts = [];
let transactions = [];
let settings = {};
let financialChart = null;

// DOM Elements
const sectionButtons = document.querySelectorAll('.nav-btn');
const sections = document.querySelectorAll('.section');
const loader = document.getElementById('loader');

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Set current date for date inputs
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('transactionDate').value = today;
  
  // Set default date range for reports (current month)
  const firstDay = new Date();
  firstDay.setDate(1);
  document.getElementById('reportFromDate').value = firstDay.toISOString().split('T')[0];
  document.getElementById('reportToDate').value = today;
  
  // Load data from Firebase
  loadData();
  
  // Set up event listeners
  setupEventListeners();
});

// Setup all event listeners
function setupEventListeners() {
  // Navigation
  sectionButtons.forEach(button => {
    button.addEventListener('click', () => {
      const sectionId = button.getAttribute('data-section');
      switchSection(sectionId);
    });
  });
  
  // Account modal
  document.getElementById('addAccountBtn').addEventListener('click', () => openAccountModal());
  document.getElementById('closeAccountModal').addEventListener('click', () => closeAccountModal());
  document.getElementById('cancelAccountBtn').addEventListener('click', () => closeAccountModal());
  document.getElementById('saveAccountBtn').addEventListener('click', () => saveAccount());
  
  // Transaction modal
  document.getElementById('addTransactionBtn').addEventListener('click', () => openTransactionModal());
  document.getElementById('addTransactionBtn2').addEventListener('click', () => openTransactionModal());
  document.getElementById('closeTransactionModal').addEventListener('click', () => closeTransactionModal());
  document.getElementById('cancelTransactionBtn').addEventListener('click', () => closeTransactionModal());
  document.getElementById('saveTransactionBtn').addEventListener('click', () => saveTransaction());
  
  // Filters
  document.getElementById('applyFiltersBtn').addEventListener('click', () => filterTransactions());
  
  // Reports
  document.getElementById('generateReportBtn').addEventListener('click', () => generateReport());
  
  // Settings
  document.getElementById('saveSettingsBtn').addEventListener('click', () => saveSettings());
  
  // Admin password
  document.getElementById('adminPassword').addEventListener('input', (e) => {
    const password = e.target.value;
    const adminButtons = [
      document.getElementById('clearDuplicatesBtn'),
      document.getElementById('clearCacheBtn'),
      document.getElementById('resetSystemBtn')
    ];
    
    if (password === '1234') {
      adminButtons.forEach(btn => btn.disabled = false);
    } else {
      adminButtons.forEach(btn => btn.disabled = true);
    }
  });
  
  // Admin functions
  document.getElementById('clearDuplicatesBtn').addEventListener('click', () => clearDuplicates());
  document.getElementById('clearCacheBtn').addEventListener('click', () => clearCache());
  document.getElementById('resetSystemBtn').addEventListener('click', () => resetSystem());
}

// Switch between sections
function switchSection(sectionId) {
  // Update active button
  sectionButtons.forEach(button => {
    if (button.getAttribute('data-section') === sectionId) {
      button.classList.add('active');
    } else {
      button.classList.remove('active');
    }
  });
  
  // Show active section
  sections.forEach(section => {
    if (section.id === `${sectionId}-section`) {
      section.classList.remove('hidden');
      
      // Load section-specific data
      if (sectionId === 'accounts') {
        populateAccountsList();
      } else if (sectionId === 'transactions') {
        populateTransactionsList();
        populateAccountFilter();
      } else if (sectionId === 'reports') {
        // Nothing specific to load yet
      } else if (sectionId === 'settings') {
        // Nothing specific to load yet
      }
    } else {
      section.classList.add('hidden');
    }
  });
}

// Load all data from Firebase
async function loadData() {
  showLoader();
  
  try {
    // Load accounts
    const accountsSnapshot = await db.collection('accounts').get();
    accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Load transactions
    const transactionsSnapshot = await db.collection('transactions').orderBy('date', 'desc').get();
    transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Load settings
    const settingsDoc = await db.collection('settings').doc('appSettings').get();
    if (settingsDoc.exists) {
      settings = settingsDoc.data();
      applySettings();
    }
    
    // Update UI with loaded data
    updateDashboard();
    populateAccountsList();
    populateTransactionsList();
    populateAccountFilter();
    
    hideLoader();
  } catch (error) {
    console.error('Error loading data:', error);
    hideLoader();
    alert('Error loading data. Please check your internet connection.');
  }
}

// Show loader
function showLoader() {
  loader.style.display = 'flex';
}

// Hide loader
function hideLoader() {
  loader.style.display = 'none';
}

// Apply settings to UI
function applySettings() {
  if (settings.businessName) {
    document.getElementById('businessName').value = settings.businessName;
    document.title = `${settings.businessName} - Accounting Ledger`;
  }
  if (settings.currency) {
    document.getElementById('currency').value = settings.currency;
  }
  if (settings.financialYearStart) {
    document.getElementById('financialYearStart').value = settings.financialYearStart;
  }
}

// Update dashboard with current data
function updateDashboard() {
  // Calculate financial metrics
  const receivables = accounts
    .filter(acc => acc.type === 'customer')
    .reduce((sum, acc) => sum + (acc.balance || 0), 0);
  
  const payables = accounts
    .filter(acc => acc.type === 'supplier')
    .reduce((sum, acc) => sum + (acc.balance || 0), 0);
  
  const netPosition = receivables - payables;
  
  // Calculate current month sales
  const now = new Date();
  const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthSales = transactions
    .filter(t => t.type === 'sale' && new Date(t.date) >= firstDayOfMonth)
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  // Update dashboard elements
  document.getElementById('totalReceivables').textContent = formatCurrency(receivables);
  document.getElementById('totalPayables').textContent = formatCurrency(payables);
  document.getElementById('netPosition').textContent = formatCurrency(netPosition);
  document.getElementById('monthSales').textContent = formatCurrency(monthSales);
  
  // Update net position indicator
  const netPositionChange = document.getElementById('netPositionChange');
  if (netPosition > 0) {
    netPositionChange.className = 'stat-change positive';
    netPositionChange.innerHTML = '<span>Positive net position</span>';
  } else if (netPosition < 0) {
    netPositionChange.className = 'stat-change negative';
    netPositionChange.innerHTML = '<span>Negative net position</span>';
  } else {
    netPositionChange.className = 'stat-change';
    netPositionChange.innerHTML = '<span>Balanced position</span>';
  }
  
  // Update recent transactions
  updateRecentTransactions();
  
  // Update financial chart
  updateFinancialChart();
}

// Update recent transactions list
function updateRecentTransactions() {
  const recentTransactionsList = document.getElementById('recentTransactions');
  const recentTxns = transactions.slice(0, 5);
  
  if (recentTxns.length === 0) {
    recentTransactionsList.innerHTML = '<tr><td colspan="4" class="text-center">No transactions found</td></tr>';
    return;
  }
  
  recentTransactionsList.innerHTML = recentTxns.map(txn => `
    <tr>
      <td>${formatDate(txn.date)}</td>
      <td>${getAccountName(txn.accountId)}</td>
      <td><span class="badge ${getTransactionBadgeClass(txn.type)}">${txn.type}</span></td>
      <td class="text-right">${formatCurrency(txn.amount)}</td>
    </tr>
  `).join('');
}

// Update financial chart
function updateFinancialChart() {
  const ctx = document.getElementById('financialChart').getContext('2d');
  
  // Destroy previous chart if it exists
  if (financialChart) {
    financialChart.destroy();
  }
  
  // Prepare data for the chart (last 6 months)
  const months = [];
  const salesData = [];
  const expensesData = [];
  
  const now = new Date();
  for (let i = 5; i >= 0; i--) {
    const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const monthName = month.toLocaleString('default', { month: 'short' });
    months.push(monthName);
    
    // Calculate sales for this month
    const firstDay = new Date(month.getFullYear(), month.getMonth(), 1);
    const lastDay = new Date(month.getFullYear(), month.getMonth() + 1, 0);
    
    const sales = transactions
      .filter(t => t.type === 'sale' && 
                  new Date(t.date) >= firstDay && 
                  new Date(t.date) <= lastDay)
      .reduce((sum, t) => sum + (t.amount || 0), 0);
    
    salesData.push(sales);
    
    // Calculate expenses for this month
    const expenses = transactions
      .filter(t => (t.type === 'expense' || t.type === 'purchase') && 
                  new Date(t.date) >= firstDay && 
                  new Date(t.date) <= lastDay)
      .reduce((sum, t) => sum + (t.amount || 0), 0);
    
    expensesData.push(expenses);
  }
  
  // Create new chart
  financialChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        {
          label: 'Sales',
          data: salesData,
          backgroundColor: 'rgba(5, 150, 105, 0.5)',
          borderColor: 'rgb(5, 150, 105)',
          borderWidth: 1
        },
        {
          label: 'Expenses',
          data: expensesData,
          backgroundColor: 'rgba(220, 38, 38, 0.5)',
          borderColor: 'rgb(220, 38, 38)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '₹' + value.toLocaleString();
            }
          }
        }
      },
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ₹' + context.raw.toLocaleString();
            }
          }
        }
      }
    }
  });
}

// Populate accounts list
function populateAccountsList() {
  const accountsList = document.getElementById('accountsList');
  
  if (accounts.length === 0) {
    accountsList.innerHTML = '<tr><td colspan="5" class="text-center">No accounts found</td></tr>';
    return;
  }
  
  accountsList.innerHTML = accounts.map(account => `
    <tr>
      <td>${account.name}</td>
      <td><span class="badge ${getAccountBadgeClass(account.type)}">${account.type}</span></td>
      <td class="text-right">${formatCurrency(account.balance || 0)}</td>
      <td><span class="badge ${account.balance > 0 ? 'badge-warning' : 'badge-success'}">${account.balance > 0 ? 'Active' : 'Settled'}</span></td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="viewAccount('${account.id}')">View</button>
        <button class="btn btn-primary btn-sm" onclick="editAccount('${account.id}')">Edit</button>
      </td>
    </tr>
  `).join('');
}

// Populate transactions list
function populateTransactionsList() {
  const transactionsList = document.getElementById('transactionsList');
  
  if (transactions.length === 0) {
    transactionsList.innerHTML = '<tr><td colspan="8" class="text-center">No transactions found</td></tr>';
    return;
  }
  
  transactionsList.innerHTML = transactions.map(transaction => `
    <tr>
      <td>${formatDate(transaction.date)}</td>
      <td>${getAccountName(transaction.accountId)}</td>
      <td><span class="badge ${getTransactionBadgeClass(transaction.type)}">${transaction.type}</span></td>
      <td>${transaction.description || 'N/A'}</td>
      <td class="text-right">${transaction.type === 'sale' || transaction.type === 'receipt' ? formatCurrency(transaction.amount) : '-'}</td>
      <td class="text-right">${transaction.type === 'purchase' || transaction.type === 'payment' || transaction.type === 'expense' ? formatCurrency(transaction.amount) : '-'}</td>
      <td class="text-right">${formatCurrency(calculateAccountBalance(transaction.accountId, transaction.date))}</td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="viewTransaction('${transaction.id}')">View</button>
        <button class="btn btn-primary btn-sm" onclick="editTransaction('${transaction.id}')">Edit</button>
      </td>
    </tr>
  `).join('');
}

// Populate account filter dropdown
function populateAccountFilter() {
  const accountFilter = document.getElementById('accountFilter');
  const transactionAccount = document.getElementById('transactionAccount');
  
  // Clear existing options except the first one
  while (accountFilter.options.length > 1) {
    accountFilter.remove(1);
  }
  while (transactionAccount.options.length > 1) {
    transactionAccount.remove(1);
  }
  
  // Add account options
  accounts.forEach(account => {
    const option = document.createElement('option');
    option.value = account.id;
    option.textContent = account.name;
    
    accountFilter.appendChild(option.cloneNode(true));
    transactionAccount.appendChild(option);
  });
}

// Filter transactions based on selected filters
function filterTransactions() {
  const typeFilter = document.getElementById('transactionTypeFilter').value;
  const accountFilter = document.getElementById('accountFilter').value;
  const dateFrom = document.getElementById('dateFromFilter').value;
  const dateTo = document.getElementById('dateToFilter').value;
  
  let filteredTransactions = [...transactions];
  
  // Apply filters
  if (typeFilter) {
    filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
  }
  
  if (accountFilter) {
    filteredTransactions = filteredTransactions.filter(t => t.accountId === accountFilter);
  }
  
  if (dateFrom) {
    filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= new Date(dateFrom));
  }
  
  if (dateTo) {
    const toDate = new Date(dateTo);
    toDate.setHours(23, 59, 59); // Include the entire end date
    filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= toDate);
  }
  
  // Update transactions list with filtered data
  const transactionsList = document.getElementById('transactionsList');
  
  if (filteredTransactions.length === 0) {
    transactionsList.innerHTML = '<tr><td colspan="8" class="text-center">No matching transactions found</td></tr>';
    return;
  }
  
  transactionsList.innerHTML = filteredTransactions.map(transaction => `
    <tr>
      <td>${formatDate(transaction.date)}</td>
      <td>${getAccountName(transaction.accountId)}</td>
      <td><span class="badge ${getTransactionBadgeClass(transaction.type)}">${transaction.type}</span></td>
      <td>${transaction.description || 'N/A'}</td>
      <td class="text-right">${transaction.type === 'sale' || transaction.type === 'receipt' ? formatCurrency(transaction.amount) : '-'}</td>
      <td class="text-right">${transaction.type === 'purchase' || transaction.type === 'payment' || transaction.type === 'expense' ? formatCurrency(transaction.amount) : '-'}</td>
      <td class="text-right">${formatCurrency(calculateAccountBalance(transaction.accountId, transaction.date))}</td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="viewTransaction('${transaction.id}')">View</button>
        <button class="btn btn-primary btn-sm" onclick="editTransaction('${transaction.id}')">Edit</button>
      </td>
    </tr>
  `).join('');
}

// Generate report based on selected parameters
function generateReport() {
  const reportType = document.getElementById('reportType').value;
  const fromDate = document.getElementById('reportFromDate').value;
  const toDate = document.getElementById('reportToDate').value;
  
  if (!fromDate || !toDate) {
    alert('Please select both from and to dates');
    return;
  }
  
  let reportData = [];
  let reportTitle = '';
  
  // Filter transactions by date
  const from = new Date(fromDate);
  const to = new Date(toDate);
  to.setHours(23, 59, 59); // Include the entire end date
  
  const dateFilteredTransactions = transactions.filter(t => {
    const tDate = new Date(t.date);
    return tDate >= from && tDate <= to;
  });
  
  // Generate report based on type
  switch (reportType) {
    case 'profitLoss':
      reportTitle = 'Profit & Loss Statement';
      reportData = generateProfitLossReport(dateFilteredTransactions);
      break;
    case 'balanceSheet':
      reportTitle = 'Balance Sheet';
      reportData = generateBalanceSheetReport(dateFilteredTransactions);
      break;
    case 'cashFlow':
      reportTitle = 'Cash Flow Statement';
      reportData = generateCashFlowReport(dateFilteredTransactions);
      break;
    case 'trialBalance':
      reportTitle = 'Trial Balance';
      reportData = generateTrialBalanceReport(dateFilteredTransactions);
      break;
  }
  
  // Update report title
  document.getElementById('reportTitle').textContent = `${reportTitle} (${formatDate(fromDate)} to ${formatDate(toDate)})`;
  
  // Display report
  const reportContent = document.getElementById('reportContent');
  reportContent.innerHTML = reportData;
}

// Generate Profit & Loss Report
function generateProfitLossReport(transactions) {
  // Calculate total income
  const income = transactions
    .filter(t => t.type === 'sale')
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  // Calculate total expenses
  const expenses = transactions
    .filter(t => t.type === 'expense' || t.type === 'purchase')
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  // Calculate net profit
  const netProfit = income - expenses;
  
  return `
    <div class="space-y-4">
      <div class="flex justify-between border-b pb-2">
        <span class="font-semibold">Income:</span>
        <span class="font-semibold">${formatCurrency(income)}</span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span class="font-semibold">Expenses:</span>
        <span class="font-semibold">${formatCurrency(expenses)}</span>
      </div>
      <div class="flex justify-between border-b pb-2 ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
        <span class="font-bold">Net Profit:</span>
        <span class="font-bold">${formatCurrency(netProfit)}</span>
      </div>
    </div>
  `;
}

// Generate Balance Sheet Report
function generateBalanceSheetReport(transactions) {
  // Calculate total assets (cash + receivables)
  const cash = accounts
    .filter(acc => acc.type === 'cash' || acc.type === 'bank')
    .reduce((sum, acc) => sum + (acc.balance || 0), 0);
  
  const receivables = accounts
    .filter(acc => acc.type === 'customer')
    .reduce((sum, acc) => sum + (acc.balance || 0), 0);
  
  const totalAssets = cash + receivables;
  
  // Calculate total liabilities (payables)
  const payables = accounts
    .filter(acc => acc.type === 'supplier')
    .reduce((sum, acc) => sum + (acc.balance || 0), 0);
  
  const totalLiabilities = payables;
  
  // Calculate equity
  const equity = totalAssets - totalLiabilities;
  
  return `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="font-semibold mb-2">Assets</h3>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span>Cash & Bank:</span>
            <span>${formatCurrency(cash)}</span>
          </div>
          <div class="flex justify-between">
            <span>Accounts Receivable:</span>
            <span>${formatCurrency(receivables)}</span>
          </div>
          <div class="flex justify-between border-t pt-2 font-semibold">
            <span>Total Assets:</span>
            <span>${formatCurrency(totalAssets)}</span>
          </div>
        </div>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Liabilities & Equity</h3>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span>Accounts Payable:</span>
            <span>${formatCurrency(payables)}</span>
          </div>
          <div class="flex justify-between border-t pt-2">
            <span>Equity:</span>
            <span>${formatCurrency(equity)}</span>
          </div>
          <div class="flex justify-between border-t pt-2 font-semibold">
            <span>Total Liabilities & Equity:</span>
            <span>${formatCurrency(totalLiabilities + equity)}</span>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Generate Cash Flow Report
function generateCashFlowReport(transactions) {
  // Calculate cash from operations
  const cashReceipts = transactions
    .filter(t => t.type === 'receipt')
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  const cashPayments = transactions
    .filter(t => t.type === 'payment' || t.type === 'expense')
    .reduce((sum, t) => sum + (t.amount || 0), 0);
  
  const netCashFromOperations = cashReceipts - cashPayments;
  
  return `
    <div class="space-y-4">
      <div class="flex justify-between border-b pb-2">
        <span>Cash Receipts from Customers:</span>
        <span>${formatCurrency(cashReceipts)}</span>
      </div>
      <div class="flex justify-between border-b pb-2">
        <span>Cash Payments to Suppliers & Expenses:</span>
        <span>${formatCurrency(cashPayments)}</span>
      </div>
      <div class="flex justify-between border-b pb-2 font-semibold ${netCashFromOperations >= 0 ? 'text-green-600' : 'text-red-600'}">
        <span>Net Cash from Operations:</span>
        <span>${formatCurrency(netCashFromOperations)}</span>
      </div>
    </div>
  `;
}

// Generate Trial Balance Report
function generateTrialBalanceReport(transactions) {
  // Group transactions by account and calculate debits/credits
  const accountBalances = {};
  
  transactions.forEach(t => {
    if (!accountBalances[t.accountId]) {
      accountBalances[t.accountId] = {
        name: getAccountName(t.accountId),
        debit: 0,
        credit: 0
      };
    }
    
    if (t.type === 'sale' || t.type === 'receipt') {
      accountBalances[t.accountId].debit += t.amount || 0;
    } else if (t.type === 'purchase' || t.type === 'payment' || t.type === 'expense') {
      accountBalances[t.accountId].credit += t.amount || 0;
    }
  });
  
  // Create table rows
  let rows = '';
  let totalDebit = 0;
  let totalCredit = 0;
  
  for (const accountId in accountBalances) {
    const balance = accountBalances[accountId];
    rows += `
      <tr>
        <td>${balance.name}</td>
        <td class="text-right">${formatCurrency(balance.debit)}</td>
        <td class="text-right">${formatCurrency(balance.credit)}</td>
      </tr>
    `;
    
    totalDebit += balance.debit;
    totalCredit += balance.credit;
  }
  
  return `
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Account</th>
            <th class="text-right">Debit (₹)</th>
            <th class="text-right">Credit (₹)</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
        <tfoot>
          <tr class="font-semibold">
            <td>Total</td>
            <td class="text-right">${formatCurrency(totalDebit)}</td>
            <td class="text-right">${formatCurrency(totalCredit)}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;
}

// Open account modal
function openAccountModal(account = null) {
  const modal = document.getElementById('accountModal');
  const form = document.getElementById('accountForm');
  
  if (account) {
    // Edit mode
    document.getElementById('modalTitle').textContent = 'Edit Account';
    document.getElementById('accountName').value = account.name;
    document.getElementById('accountType').value = account.type;
    document.getElementById('accountBalance').value = account.balance || 0;
    document.getElementById('accountContact').value = account.contact || '';
    document.getElementById('saveAccountBtn').setAttribute('data-id', account.id);
  } else {
    // Add mode
    document.getElementById('modalTitle').textContent = 'Add New Account';
    form.reset();
    document.getElementById('accountBalance').value = 0;
    document.getElementById('saveAccountBtn').removeAttribute('data-id');
  }
  
  modal.classList.remove('hidden');
}

// Close account modal
function closeAccountModal() {
  document.getElementById('accountModal').classList.add('hidden');
}

// Save account
async function saveAccount() {
  const form = document.getElementById('accountForm');
  const accountId = document.getElementById('saveAccountBtn').getAttribute('data-id');
  const accountData = {
    name: document.getElementById('accountName').value,
    type: document.getElementById('accountType').value,
    balance: parseFloat(document.getElementById('accountBalance').value) || 0,
    contact: document.getElementById('accountContact').value,
    updatedAt: new Date()
  };
  
  if (!accountData.name || !accountData.type) {
    alert('Please fill in all required fields');
    return;
  }
  
  showLoader();
  
  try {
    if (accountId) {
      // Update existing account
      await db.collection('accounts').doc(accountId).update(accountData);
    } else {
      // Add new account
      accountData.createdAt = new Date();
      await db.collection('accounts').add(accountData);
    }
    
    // Reload data
    await loadData();
    closeAccountModal();
    hideLoader();
  } catch (error) {
    console.error('Error saving account:', error);
    hideLoader();
    alert('Error saving account. Please try again.');
  }
}

// Open transaction modal
function openTransactionModal(transaction = null) {
  const modal = document.getElementById('transactionModal');
  const form = document.getElementById('transactionForm');
  
  // Set today's date as default
  document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
  
  if (transaction) {
    // Edit mode
    document.getElementById('modalTitle').textContent = 'Edit Transaction';
    document.getElementById('transactionDate').value = transaction.date;
    document.getElementById('transactionType').value = transaction.type;
    document.getElementById('transactionAccount').value = transaction.accountId;
    document.getElementById('transactionDescription').value = transaction.description || '';
    document.getElementById('transactionAmount').value = transaction.amount || 0;
    document.getElementById('transactionReference').value = transaction.reference || '';
    document.getElementById('saveTransactionBtn').setAttribute('data-id', transaction.id);
  } else {
    // Add mode
    document.getElementById('modalTitle').textContent = 'Add New Transaction';
    form.reset();
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('saveTransactionBtn').removeAttribute('data-id');
  }
  
  modal.classList.remove('hidden');
}

// Close transaction modal
function closeTransactionModal() {
  document.getElementById('transactionModal').classList.add('hidden');
}

// Save transaction
async function saveTransaction() {
  const form = document.getElementById('transactionForm');
  const transactionId = document.getElementById('saveTransactionBtn').getAttribute('data-id');
  const transactionData = {
    date: document.getElementById('transactionDate').value,
    type: document.getElementById('transactionType').value,
    accountId: document.getElementById('transactionAccount').value,
    description: document.getElementById('transactionDescription').value,
    amount: parseFloat(document.getElementById('transactionAmount').value) || 0,
    reference: document.getElementById('transactionReference').value,
    updatedAt: new Date()
  };
  
  if (!transactionData.date || !transactionData.type || !transactionData.accountId || 
      !transactionData.description || !transactionData.amount) {
    alert('Please fill in all required fields');
    return;
  }
  
  showLoader();
  
  try {
    if (transactionId) {
      // Update existing transaction
      await db.collection('transactions').doc(transactionId).update(transactionData);
    } else {
      // Add new transaction
      transactionData.createdAt = new Date();
      await db.collection('transactions').add(transactionData);
      
      // Update account balance
      const account = accounts.find(acc => acc.id === transactionData.accountId);
      if (account) {
        let newBalance = account.balance || 0;
        
        if (transactionData.type === 'sale' || transactionData.type === 'receipt') {
          // Increase balance for sales and receipts
          newBalance += transactionData.amount;
        } else if (transactionData.type === 'purchase' || transactionData.type === 'payment' || transactionData.type === 'expense') {
          // Decrease balance for purchases, payments, and expenses
          newBalance -= transactionData.amount;
        }
        
        await db.collection('accounts').doc(transactionData.accountId).update({
          balance: newBalance,
          updatedAt: new Date()
        });
      }
    }
    
    // Reload data
    await loadData();
    closeTransactionModal();
    hideLoader();
  } catch (error) {
    console.error('Error saving transaction:', error);
    hideLoader();
    alert('Error saving transaction. Please try again.');
  }
}

// Save settings
async function saveSettings() {
  const settingsData = {
    businessName: document.getElementById('businessName').value,
    currency: document.getElementById('currency').value,
    financialYearStart: document.getElementById('financialYearStart').value,
    updatedAt: new Date()
  };
  
  showLoader();
  
  try {
    await db.collection('settings').doc('appSettings').set(settingsData, { merge: true });
    settings = settingsData;
    applySettings();
    hideLoader();
    alert('Settings saved successfully!');
  } catch (error) {
    console.error('Error saving settings:', error);
    hideLoader();
    alert('Error saving settings. Please try again.');
  }
}

// Clear duplicates
async function clearDuplicates() {
  if (!confirm('Are you sure you want to clear duplicate entries? This action cannot be undone.')) {
    return;
  }
  
  showLoader();
  
  try {
    // This is a placeholder - in a real application, you would implement
    // a proper duplicate detection and removal algorithm
    alert('Duplicate clearing functionality would be implemented here.');
    hideLoader();
  } catch (error) {
    console.error('Error clearing duplicates:', error);
    hideLoader();
    alert('Error clearing duplicates. Please try again.');
  }
}

// Clear cache
async function clearCache() {
  if (!confirm('Are you sure you want to clear the cache? This will force a reload of all data.')) {
    return;
  }
  
  showLoader();
  
  try {
    // Clear local data and reload
    accounts = [];
    transactions = [];
    await loadData();
    hideLoader();
    alert('Cache cleared successfully!');
  } catch (error) {
    console.error('Error clearing cache:', error);
    hideLoader();
    alert('Error clearing cache. Please try again.');
  }
}

// Reset system
async function resetSystem() {
  if (!confirm('WARNING: This will reset ALL data in the system. This action cannot be undone. Are you sure?')) {
    return;
  }
  
  const password = prompt('Please enter the admin password to confirm:');
  if (password !== '1234') {
    alert('Incorrect password. System reset cancelled.');
    return;
  }
  
  showLoader();
  
  try {
    // This is a placeholder - in a real application, you would implement
    // a proper reset mechanism with extreme caution
    alert('System reset functionality would be implemented here.');
    hideLoader();
  } catch (error) {
    console.error('Error resetting system:', error);
    hideLoader();
    alert('Error resetting system. Please try again.');
  }
}

// View account details
function viewAccount(accountId) {
  const account = accounts.find(acc => acc.id === accountId);
  if (account) {
    alert(`Account Details:\nName: ${account.name}\nType: ${account.type}\nBalance: ${formatCurrency(account.balance || 0)}`);
  }
}

// Edit account
function editAccount(accountId) {
  const account = accounts.find(acc => acc.id === accountId);
  if (account) {
    openAccountModal(account);
  }
}

// View transaction details
function viewTransaction(transactionId) {
  const transaction = transactions.find(t => t.id === transactionId);
  if (transaction) {
    alert(`Transaction Details:\nDate: ${formatDate(transaction.date)}\nAccount: ${getAccountName(transaction.accountId)}\nType: ${transaction.type}\nAmount: ${formatCurrency(transaction.amount || 0)}`);
  }
}

// Edit transaction
function editTransaction(transactionId) {
  const transaction = transactions.find(t => t.id === transactionId);
  if (transaction) {
    openTransactionModal(transaction);
  }
}

// Helper function to format currency
function formatCurrency(amount) {
  return '₹' + (amount || 0).toLocaleString('en-IN', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

// Helper function to format date
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-IN', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Helper function to get account name by ID
function getAccountName(accountId) {
  const account = accounts.find(acc => acc.id === accountId);
  return account ? account.name : 'Unknown Account';
}

// Helper function to get account badge class
function getAccountBadgeClass(type) {
  switch (type) {
    case 'customer': return 'badge-success';
    case 'supplier': return 'badge-warning';
    case 'bank': return 'badge-secondary';
    case 'cash': return 'badge-secondary';
    case 'income': return 'badge-success';
    case 'expense': return 'badge-danger';
    case 'asset': return 'badge-secondary';
    case 'liability': return 'badge-warning';
    default: return 'badge-secondary';
  }
}

// Helper function to get transaction badge class
function getTransactionBadgeClass(type) {
  switch (type) {
    case 'sale': return 'badge-success';
    case 'purchase': return 'badge-warning';
    case 'payment': return 'badge-danger';
    case 'receipt': return 'badge-success';
    case 'expense': return 'badge-danger';
    case 'adjustment': return 'badge-secondary';
    default: return 'badge-secondary';
  }
}

// Helper function to calculate account balance up to a specific date
function calculateAccountBalance(accountId, asOfDate) {
  const account = accounts.find(acc => acc.id === accountId);
  if (!account) return 0;
  
  // Get all transactions for this account up to the specified date
  const accountTransactions = transactions.filter(t => 
    t.accountId === accountId && new Date(t.date) <= new Date(asOfDate)
  );
  
  // Calculate balance based on transaction types
  let balance = account.balance || 0;
  
  accountTransactions.forEach(t => {
    if (t.type === 'sale' || t.type === 'receipt') {
      balance += t.amount || 0;
    } else if (t.type === 'purchase' || t.type === 'payment' || t.type === 'expense') {
      balance -= t.amount || 0;
    }
  });
  
  return balance;
}
</script>
</body>
</html>
