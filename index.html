<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Aditya Fertilizers - Professional Accounting Ledger</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
:root {
  --primary: #0f766e;
  --primary-dark: #065f57;
  --secondary: #047857;
  --danger: #dc2626;
  --warning: #d97706;
  --success: #059669;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --text-muted: #64748b;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

.header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 1rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--primary);
}

.nav-links {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.nav-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.nav-btn:hover {
  background: var(--primary);
  color: white;
}

.nav-btn.active {
  background: var(--primary);
  color: white;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--card);
  padding: 1.5rem;
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.stat-title {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.stat-change {
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.positive { color: var(--success); }
.negative { color: var(--danger); }
.warning { color: var(--warning); }

.card {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
}

.card-header {
  padding: 1.5rem 1.5rem 0;
  display: flex;
  justify-content: between;
  align-items: center;
}

.card-title {
  font-size: 1.125rem;
  font-weight: 600;
}

.card-content {
  padding: 1.5rem;
}

.table-container {
  overflow-x: auto;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

.table th,
.table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: var(--text-muted);
}

.table tr:hover {
  background: #f8fafc;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.875rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--border);
  color: var(--text);
}

.btn-secondary:hover {
  background: #cbd5e1;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.form-group {
  margin-bottom: 1rem;
}

.label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.input,
.select,
.textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  font-size: 0.875rem;
  transition: border-color 0.2s;
}

.input:focus,
.select:focus,
.textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modal {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
}

.modal-content {
  padding: 1.5rem;
}

.modal-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

.badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.badge-success { background: #dcfce7; color: var(--success); }
.badge-danger { background: #fecaca; color: var(--danger); }
.badge-warning { background: #fef3c7; color: var(--warning); }
.badge-secondary { background: #f1f5f9; color: var(--text-muted); }

.search-bar {
  position: relative;
  margin-bottom: 1.5rem;
}

.search-input {
  padding-left: 2.5rem;
}

.search-icon {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.filters {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.loader {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.actions {
  display: flex;
  gap: 0.5rem;
}

.text-right { text-align: right; }
.text-center { text-align: center; }
.font-medium { font-weight: 500; }
.text-sm { font-size: 0.875rem; }
.text-xs { font-size: 0.75rem; }

.grid {
  display: grid;
  gap: 1rem;
}

.grid-cols-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-cols-3 {
  grid-template-columns: repeat(3, 1fr);
}

.hidden {
  display: none !important;
}

@media (max-width: 768px) {
  .container {
    padding: 1rem;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .header {
    padding: 1rem;
  }
  
  .nav-links {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .filters {
    flex-direction: column;
  }
  
  .table-container {
    font-size: 0.75rem;
  }
}
</style>
</head>

<body>
  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>

  <header class="header">
    <div class="logo">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      Aditya Fertilizers - Accounting Ledger
    </div>
    <nav class="nav-links">
      <button class="nav-btn active" data-section="dashboard">Dashboard</button>
      <button class="nav-btn" data-section="accounts">Accounts</button>
      <button class="nav-btn" data-section="transactions">Transactions</button>
      <button class="nav-btn" data-section="reports">Reports</button>
      <button class="nav-btn" data-section="settings">Settings</button>
    </nav>
  </header>

  <main class="container">
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="section">
      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-title">Total Receivables</div>
          <div class="stat-value" id="totalReceivables">₹0</div>
          <div class="stat-change positive">
            <span>Outstanding from customers</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Total Payables</div>
          <div class="stat-value" id="totalPayables">₹0</div>
          <div class="stat-change negative">
            <span>Outstanding to suppliers</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Net Position</div>
          <div class="stat-value" id="netPosition">₹0</div>
          <div class="stat-change" id="netPositionChange">
            <span>Overall financial position</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">This Month Sales</div>
          <div class="stat-value" id="monthSales">₹0</div>
          <div class="stat-change positive">
            <span>Current month revenue</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Transactions</h3>
            <button class="btn btn-primary btn-sm" onclick="showAddTransactionModal()">Add Transaction</button>
          </div>
          <div class="card-content">
            <div id="recentTransactions">Loading...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Outstanding Payments</h3>
          </div>
          <div class="card-content">
            <div id="outstandingPayments">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Accounts Section -->
    <div id="accounts-section" class="section hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Company Accounts</h3>
          <button class="btn btn-primary" onclick="showAddAccountModal()">Add Account</button>
        </div>
        <div class="card-content">
          <div class="search-bar">
            <input type="text" class="input search-input" placeholder="Search accounts..." id="accountSearch">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="21 21l-4.35-4.35"></path>
            </svg>
          </div>
          <div class="table-container">
            <table class="table" id="accountsTable">
              <thead>
                <tr>
                  <th>Company Name</th>
                  <th>Type</th>
                  <th>Balance</th>
                  <th>Status</th>
                  <th>Last Transaction</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="accountsTableBody">
                <!-- Dynamic content -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Transactions Section -->
    <div id="transactions-section" class="section hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">All Transactions</h3>
          <button class="btn btn-primary" onclick="showAddTransactionModal()">Add Transaction</button>
        </div>
        <div class="card-content">
          <div class="filters">
            <select class="select" id="transactionTypeFilter">
              <option value="">All Types</option>
              <option value="purchase">Purchase</option>
              <option value="sale">Sale</option>
              <option value="payment">Payment</option>
              <option value="receipt">Receipt</option>
            </select>
            <select class="select" id="paymentStatusFilter">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="partial">Partial</option>
              <option value="paid">Paid</option>
            </select>
            <input type="date" class="input" id="fromDate">
            <input type="date" class="input" id="toDate">
            <button class="btn btn-secondary" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
          </div>
          <div class="search-bar">
            <input type="text" class="input search-input" placeholder="Search transactions..." id="transactionSearch">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="21 21l-4.35-4.35"></path>
            </svg>
          </div>
          <div class="table-container">
            <table class="table" id="transactionsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Company</th>
                  <th>Type</th>
                  <th>Material</th>
                  <th>Quantity</th>
                  <th>Amount</th>
                  <th>Payment Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transactionsTableBody">
                <!-- Dynamic content -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Section -->
    <div id="reports-section" class="section hidden">
      <div class="grid grid-cols-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Profit & Loss</h3>
          </div>
          <div class="card-content">
            <canvas id="profitLossChart" width="400" height="200"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Outstanding Analysis</h3>
          </div>
          <div class="card-content">
            <canvas id="outstandingChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">Generate Reports</h3>
        </div>
        <div class="card-content">
          <div class="grid grid-cols-3">
            <button class="btn btn-primary" onclick="generateReport('aging')">Aging Report</button>
            <button class="btn btn-primary" onclick="generateReport('pl')">P&L Statement</button>
            <button class="btn btn-primary" onclick="generateReport('ledger')">Ledger Summary</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Transaction Modal -->
  <div id="transactionModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Transaction</h3>
        <button onclick="hideModal('transactionModal')" class="btn btn-secondary btn-sm">✕</button>
      </div>
      <div class="modal-content">
        <form id="transactionForm">
          <div class="form-group">
            <label class="label">Transaction Type</label>
            <select class="select" id="transactionType" required>
              <option value="">Select Type</option>
              <option value="purchase">Purchase</option>
              <option value="sale">Sale</option>
              <option value="payment">Payment Made</option>
              <option value="receipt">Payment Received</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="label">Company</label>
            <select class="select" id="transactionCompany" required>
              <option value="">Select Company</option>
              <!-- Dynamic options -->
            </select>
          </div>
          
          <div class="form-group" id="materialGroup">
            <label class="label">Material</label>
            <select class="select" id="transactionMaterial">
              <option value="">Select Material</option>
              <!-- Dynamic options -->
            </select>
          </div>
          
          <div class="grid grid-cols-2">
            <div class="form-group" id="quantityGroup">
              <label class="label">Quantity (Bags)</label>
              <input type="number" class="input" id="transactionQuantity" step="0.01">
            </div>
            <div class="form-group" id="priceGroup">
              <label class="label">Price per Bag</label>
              <input type="number" class="input" id="transactionPrice" step="0.01">
            </div>
          </div>
          
          <div class="form-group">
            <label class="label">Total Amount</label>
            <input type="number" class="input" id="transactionAmount" step="0.01" required>
          </div>
          
          <div class="form-group">
            <label class="label">Payment Status</label>
            <select class="select" id="paymentStatus" required>
              <option value="pending">Pending</option>
              <option value="partial">Partial</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          
          <div class="form-group" id="paidAmountGroup" style="display: none;">
            <label class="label">Paid Amount</label>
            <input type="number" class="input" id="paidAmount" step="0.01">
          </div>
          
          <div class="form-group">
            <label class="label">Notes</label>
            <textarea class="textarea" id="transactionNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideModal('transactionModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTransaction()">Save Transaction</button>
      </div>
    </div>
  </div>

  <!-- Add Account Modal -->
  <div id="accountModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Company Account</h3>
        <button onclick="hideModal('accountModal')" class="btn btn-secondary btn-sm">✕</button>
      </div>
      <div class="modal-content">
        <form id="accountForm">
          <div class="form-group">
            <label class="label">Company Name</label>
            <input type="text" class="input" id="accountName" required>
          </div>
          
          <div class="form-group">
            <label class="label">Account Type</label>
            <select class="select" id="accountType" required>
              <option value="customer">Customer</option>
              <option value="supplier">Supplier</option>
              <option value="both">Both</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="label">Contact Person</label>
            <input type="text" class="input" id="contactPerson">
          </div>
          
          <div class="form-group">
            <label class="label">Phone</label>
            <input type="tel" class="input" id="accountPhone">
          </div>
          
          <div class="form-group">
            <label class="label">Address</label>
            <textarea class="textarea" id="accountAddress" rows="3"></textarea>
          </div>
          
          <div class="form-group">
            <label class="label">Opening Balance</label>
            <input type="number" class="input" id="openingBalance" step="0.01" placeholder="0.00">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideModal('accountModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveAccount()">Save Account</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration (from your existing system)
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBEybu3XKeK3QOeRIMs-fK2dDwHtpCTqgQ",
      authDomain: "aditya-supply-chain-b5f61.firebaseapp.com",
      projectId: "aditya-supply-chain-b5f61",
      storageBucket: "aditya-supply-chain-b5f61.firebasestorage.app",
      messagingSenderId: "662836162599",
      appId: "1:662836162599:web:2b49bde530e4b87924de02",
      measurementId: "G-DQH00BNH1L"
    };

    // Admin credentials
    const ADMIN_EMAIL = 'adityajainaas@gmail.com';
    const ADMIN_PWD = 'Aditya@1609';

    // Initialize Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Global state
    let currentSection = 'dashboard';
    let companies = [];
    let materials = [];
    let transactions = [];
    let accounts = [];

    // Utility functions
    function formatCurrency(amount) {
      return '₹' + Number(amount || 0).toLocaleString('en-IN', { maximumFractionDigits: 2 });
    }

    function formatDate(date) {
      if (!date) return '-';
      if (date.toDate) return date.toDate().toLocaleDateString('en-IN');
      if (date.seconds) return new Date(date.seconds * 1000).toLocaleDateString('en-IN');
      return new Date(date).toLocaleDateString('en-IN');
    }

    function showLoader() {
      document.getElementById('loader').style.display = 'flex';
    }

    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }

    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Authentication
    async function autoSignIn() {
      try {
        await auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PWD);
        console.log('Signed in successfully');
      } catch (err) {
        console.error('Auto sign-in failed:', err);
        alert('Authentication failed: ' + err.message);
      }
    }

    // Navigation
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(sectionName + '-section').classList.remove('hidden');
      
      // Add active class to clicked nav button
      document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
      
      currentSection = sectionName;
      
      // Load section-specific data
      if (sectionName === 'accounts') loadAccounts();
      if (sectionName === 'transactions') loadTransactions();
      if (sectionName === 'reports') loadReports();
      if (sectionName === 'dashboard') loadDashboard();
    }

    // Event listeners for navigation
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          showSection(btn.dataset.section);
        });
      });
    });

    // Load data from existing supply chain system
    async function loadExistingData() {
      showLoader();
      try {
        // Load companies from existing system
        const companiesSnapshot = await db.collection('companies').get();
        companies = [];
        
        for (const doc of companiesSnapshot.docs) {
          const companyData = doc.data();
          companies.push({
            id: doc.id,
            name: companyData.name,
            ...companyData
          });
          
          // Create or update account for this company
          await createAccountFromCompany(doc.id, companyData);
        }
        
        // Load all entries (transactions) from existing system
        for (const company of companies) {
          const entriesSnapshot = await db.collection('companies')
            .doc(company.id)
            .collection('entries')
            .orderBy('createdAt', 'desc')
            .get();
            
          for (const entryDoc of entriesSnapshot.docs) {
            const entry = entryDoc.data();
            await createTransactionFromEntry(company.id, entryDoc.id, entry);
          }
        }
        
        populateCompanyDropdowns();
        loadDashboard();
        
      } catch (err) {
        console.error('Error loading existing data:', err);
        alert('Error loading data: ' + err.message);
      } finally {
        hideLoader();
      }
    }

    // Create account from existing company data
    async function createAccountFromCompany(companyId, companyData) {
      try {
        const accountRef = db.collection('ledger_accounts').doc(companyId);
        const existingAccount = await accountRef.get();
        
        if (!existingAccount.exists) {
          await accountRef.set({
            name: companyData.name,
            type: 'both', // Assume both customer and supplier initially
            balance: 0,
            totalPurchases: 0,
            totalSales: 0,
            totalPayments: 0,
            totalReceipts: 0,
            outstandingReceivable: 0,
            outstandingPayable: 0,
            contactPerson: '',
            phone: '',
            address: '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      } catch (err) {
        console.error('Error creating account:', err);
      }
    }

    // Create transaction from existing entry
    async function createTransactionFromEntry(companyId, entryId, entryData) {
      try {
        const transactionRef = db.collection('ledger_transactions').doc();
        
        // Get material name
        let materialName = '';
        if (entryData.materialId) {
          try {
            const materialDoc = await db.collection('companies')
              .doc(companyId)
              .collection('materials')
              .doc(entryData.materialId)
              .get();
            if (materialDoc.exists) {
              materialName = materialDoc.data().name;
            }
          } catch (err) {
            console.warn('Could not fetch material name:', err);
          }
        }

        const transactionData = {
          companyId: companyId,
          originalEntryId: entryId,
          type: entryData.type, // 'purchase' or 'sale'
          materialId: entryData.materialId || null,
          materialName: materialName,
          quantity: entryData.bags || 0,
          unit: 'bags',
          pricePerUnit: entryData.pricePerBag || 0,
          totalAmount: entryData.totalValue || 0,
          paymentStatus: 'pending', // Default to pending, can be updated
          paidAmount: 0,
          pendingAmount: entryData.totalValue || 0,
          party: entryData.party || '',
          notes: entryData.note || '',
          createdAt: entryData.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          synced: true
        };

        await transactionRef.set(transactionData);
        
        // Update account balance
        await updateAccountBalance(companyId, entryData.type, entryData.totalValue || 0);
        
      } catch (err) {
        console.error('Error creating transaction from entry:', err);
      }
    }

    // Update account balance
    async function updateAccountBalance(companyId, transactionType, amount) {
      try {
        const accountRef = db.collection('ledger_accounts').doc(companyId);
        const increment = firebase.firestore.FieldValue.increment(amount);
        
        const updateData = {
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (transactionType === 'purchase') {
          updateData.totalPurchases = increment;
          updateData.outstandingPayable = increment;
        } else if (transactionType === 'sale') {
          updateData.totalSales = increment;
          updateData.outstandingReceivable = increment;
        } else if (transactionType === 'payment') {
          updateData.totalPayments = increment;
          updateData.outstandingPayable = firebase.firestore.FieldValue.increment(-amount);
        } else if (transactionType === 'receipt') {
          updateData.totalReceipts = increment;
          updateData.outstandingReceivable = firebase.firestore.FieldValue.increment(-amount);
        }
        
        await accountRef.update(updateData);
      } catch (err) {
        console.error('Error updating account balance:', err);
      }
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        const accountsSnapshot = await db.collection('ledger_accounts').get();
        let totalReceivables = 0;
        let totalPayables = 0;
        let monthSales = 0;
        
        accountsSnapshot.forEach(doc => {
          const account = doc.data();
          totalReceivables += account.outstandingReceivable || 0;
          totalPayables += account.outstandingPayable || 0;
        });
        
        // Calculate this month's sales
        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        startOfMonth.setHours(0, 0, 0, 0);
        
        const transactionsSnapshot = await db.collection('ledger_transactions')
          .where('type', '==', 'sale')
          .where('createdAt', '>=', startOfMonth)
          .get();
          
        transactionsSnapshot.forEach(doc => {
          const transaction = doc.data();
          monthSales += transaction.totalAmount || 0;
        });
        
        const netPosition = totalReceivables - totalPayables;
        
        // Update dashboard stats
        document.getElementById('totalReceivables').textContent = formatCurrency(totalReceivables);
        document.getElementById('totalPayables').textContent = formatCurrency(totalPayables);
        document.getElementById('netPosition').textContent = formatCurrency(netPosition);
        document.getElementById('monthSales').textContent = formatCurrency(monthSales);
        
        // Update net position styling
        const netPositionChange = document.getElementById('netPositionChange');
        if (netPosition > 0) {
          netPositionChange.className = 'stat-change positive';
        } else if (netPosition < 0) {
          netPositionChange.className = 'stat-change negative';
        } else {
          netPositionChange.className = 'stat-change';
        }
        
        await loadRecentTransactions();
        await loadOutstandingPayments();
        
      } catch (err) {
        console.error('Error loading dashboard:', err);
      }
    }

    // Load recent transactions
    async function loadRecentTransactions() {
      try {
        const transactionsSnapshot = await db.collection('ledger_transactions')
          .orderBy('createdAt', 'desc')
          .limit(5)
          .get();
          
        const container = document.getElementById('recentTransactions');
        if (transactionsSnapshot.empty) {
          container.innerHTML = '<p class="text-sm text-center">No transactions yet</p>';
          return;
        }
        
        let html = '';
        for (const doc of transactionsSnapshot.docs) {
          const transaction = doc.data();
          
          // Get company name
          let companyName = 'Unknown Company';
          try {
            const accountDoc = await db.collection('ledger_accounts').doc(transaction.companyId).get();
            if (accountDoc.exists) {
              companyName = accountDoc.data().name;
            }
          } catch (err) {
            console.warn('Could not fetch company name:', err);
          }
          
          const typeClass = transaction.type === 'sale' || transaction.type === 'receipt' ? 'positive' : 'negative';
          const typeIcon = transaction.type === 'sale' ? '↗' : transaction.type === 'purchase' ? '↙' : transaction.type === 'receipt' ? '💰' : '💸';
          
          html += `
            <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
              <div>
                <div class="font-medium text-sm">${typeIcon} ${companyName}</div>
                <div class="text-xs text-gray-500">${transaction.type.toUpperCase()} • ${formatDate(transaction.createdAt)}</div>
              </div>
              <div class="text-right">
                <div class="font-medium ${typeClass}">${formatCurrency(transaction.totalAmount)}</div>
                <div class="text-xs ${transaction.paymentStatus === 'paid' ? 'text-green-600' : 'text-orange-600'}">${transaction.paymentStatus}</div>
              </div>
            </div>
          `;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Error loading recent transactions:', err);
        document.getElementById('recentTransactions').innerHTML = '<p class="text-sm text-center text-red-500">Error loading transactions</p>';
      }
    }

    // Load outstanding payments
    async function loadOutstandingPayments() {
      try {
        const accountsSnapshot = await db.collection('ledger_accounts')
          .where('outstandingReceivable', '>', 0)
          .orderBy('outstandingReceivable', 'desc')
          .limit(5)
          .get();
          
        const container = document.getElementById('outstandingPayments');
        if (accountsSnapshot.empty) {
          container.innerHTML = '<p class="text-sm text-center">No outstanding payments</p>';
          return;
        }
        
        let html = '';
        accountsSnapshot.forEach(doc => {
          const account = doc.data();
          html += `
            <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
              <div>
                <div class="font-medium text-sm">${account.name}</div>
                <div class="text-xs text-gray-500">Receivable</div>
              </div>
              <div class="text-right">
                <div class="font-medium text-orange-600">${formatCurrency(account.outstandingReceivable)}</div>
                <button class="text-xs text-blue-600 hover:underline" onclick="recordPayment('${doc.id}')">Record Payment</button>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Error loading outstanding payments:', err);
        document.getElementById('outstandingPayments').innerHTML = '<p class="text-sm text-center text-red-500">Error loading payments</p>';
      }
    }

    // Load accounts
    async function loadAccounts() {
      try {
        const accountsSnapshot = await db.collection('ledger_accounts')
          .orderBy('name')
          .get();
          
        const tbody = document.getElementById('accountsTableBody');
        tbody.innerHTML = '';
        
        accountsSnapshot.forEach(doc => {
          const account = doc.data();
          const balance = (account.outstandingReceivable || 0) - (account.outstandingPayable || 0);
          const balanceClass = balance > 0 ? 'positive' : balance < 0 ? 'negative' : '';
          const status = balance === 0 ? 'Settled' : balance > 0 ? 'Receivable' : 'Payable';
          const statusClass = balance === 0 ? 'badge-success' : balance > 0 ? 'badge-warning' : 'badge-danger';
          
          const row = `
            <tr>
              <td class="font-medium">${account.name}</td>
              <td><span class="badge badge-secondary">${account.type}</span></td>
              <td class="${balanceClass}">${formatCurrency(Math.abs(balance))}</td>
              <td><span class="badge ${statusClass}">${status}</span></td>
              <td class="text-sm">${formatDate(account.updatedAt)}</td>
              <td>
                <div class="actions">
                  <button class="btn btn-secondary btn-sm" onclick="viewAccountLedger('${doc.id}')">Ledger</button>
                  <button class="btn btn-secondary btn-sm" onclick="editAccount('${doc.id}')">Edit</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteAccount('${doc.id}')">Delete</button>
                </div>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
        
      } catch (err) {
        console.error('Error loading accounts:', err);
      }
    }

    // Load transactions
    async function loadTransactions() {
      try {
        const transactionsSnapshot = await db.collection('ledger_transactions')
          .orderBy('createdAt', 'desc')
          .get();
          
        const tbody = document.getElementById('transactionsTableBody');
        tbody.innerHTML = '';
        
        for (const doc of transactionsSnapshot.docs) {
          const transaction = doc.data();
          
          // Get company name
          let companyName = 'Unknown Company';
          try {
            const accountDoc = await db.collection('ledger_accounts').doc(transaction.companyId).get();
            if (accountDoc.exists) {
              companyName = accountDoc.data().name;
            }
          } catch (err) {
            console.warn('Could not fetch company name:', err);
          }
          
          const statusClass = transaction.paymentStatus === 'paid' ? 'badge-success' : 
                             transaction.paymentStatus === 'partial' ? 'badge-warning' : 'badge-danger';
          
          const row = `
            <tr>
              <td class="text-sm">${formatDate(transaction.createdAt)}</td>
              <td class="font-medium">${companyName}</td>
              <td><span class="badge badge-secondary">${transaction.type}</span></td>
              <td>${transaction.materialName || '-'}</td>
              <td class="text-right">${transaction.quantity ? transaction.quantity + ' ' + transaction.unit : '-'}</td>
              <td class="text-right font-medium">${formatCurrency(transaction.totalAmount)}</td>
              <td><span class="badge ${statusClass}">${transaction.paymentStatus}</span></td>
              <td>
                <div class="actions">
                  <button class="btn btn-secondary btn-sm" onclick="editTransaction('${doc.id}')">Edit</button>
                  <button class="btn btn-success btn-sm" onclick="updatePaymentStatus('${doc.id}')">Payment</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${doc.id}')">Delete</button>
                </div>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        }
        
      } catch (err) {
        console.error('Error loading transactions:', err);
      }
    }

    // Populate company dropdowns
    async function populateCompanyDropdowns() {
      try {
        const accountsSnapshot = await db.collection('ledger_accounts').orderBy('name').get();
        
        const companySelects = ['transactionCompany'];
        companySelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">Select Company</option>';
            accountsSnapshot.forEach(doc => {
              const account = doc.data();
              select.innerHTML += `<option value="${doc.id}">${account.name}</option>`;
            });
          }
        });
      } catch (err) {
        console.error('Error populating dropdowns:', err);
      }
    }

    // Transaction form handlers
    document.addEventListener('DOMContentLoaded', function() {
      const transactionType = document.getElementById('transactionType');
      const paymentStatus = document.getElementById('paymentStatus');
      const transactionAmount = document.getElementById('transactionAmount');
      const transactionQuantity = document.getElementById('transactionQuantity');
      const transactionPrice = document.getElementById('transactionPrice');
      
      if (transactionType) {
        transactionType.addEventListener('change', function() {
          const type = this.value;
          const materialGroup = document.getElementById('materialGroup');
          const quantityGroup = document.getElementById('quantityGroup');
          const priceGroup = document.getElementById('priceGroup');
          
          if (type === 'payment' || type === 'receipt') {
            materialGroup.style.display = 'none';
            quantityGroup.style.display = 'none';
            priceGroup.style.display = 'none';
          } else {
            materialGroup.style.display = 'block';
            quantityGroup.style.display = 'block';
            priceGroup.style.display = 'block';
          }
        });
      }
      
      if (paymentStatus) {
        paymentStatus.addEventListener('change', function() {
          const paidAmountGroup = document.getElementById('paidAmountGroup');
          if (this.value === 'partial') {
            paidAmountGroup.style.display = 'block';
          } else {
            paidAmountGroup.style.display = 'none';
          }
        });
      }
      
      // Auto-calculate total amount
      if (transactionQuantity && transactionPrice && transactionAmount) {
        function calculateTotal() {
          const qty = parseFloat(transactionQuantity.value) || 0;
          const price = parseFloat(transactionPrice.value) || 0;
          transactionAmount.value = (qty * price).toFixed(2);
        }
        
        transactionQuantity.addEventListener('input', calculateTotal);
        transactionPrice.addEventListener('input', calculateTotal);
      }
    });

    // Modal functions
    function showAddTransactionModal() {
      populateCompanyDropdowns();
      showModal('transactionModal');
    }

    function showAddAccountModal() {
      showModal('accountModal');
    }

    // Save transaction
    async function saveTransaction() {
      const form = document.getElementById('transactionForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      showLoader();
      try {
        const transactionData = {
          companyId: document.getElementById('transactionCompany').value,
          type: document.getElementById('transactionType').value,
          materialId: document.getElementById('transactionMaterial').value || null,
          materialName: document.getElementById('transactionMaterial').selectedOptions[0]?.textContent || '',
          quantity: parseFloat(document.getElementById('transactionQuantity').value) || 0,
          unit: 'bags',
          pricePerUnit: parseFloat(document.getElementById('transactionPrice').value) || 0,
          totalAmount: parseFloat(document.getElementById('transactionAmount').value),
          paymentStatus: document.getElementById('paymentStatus').value,
          paidAmount: document.getElementById('paymentStatus').value === 'partial' ? 
                      parseFloat(document.getElementById('paidAmount').value) || 0 : 
                      document.getElementById('paymentStatus').value === 'paid' ? 
                      parseFloat(document.getElementById('transactionAmount').value) : 0,
          party: '',
          notes: document.getElementById('transactionNotes').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          synced: false
        };
        
        transactionData.pendingAmount = transactionData.totalAmount - transactionData.paidAmount;
        
        const transactionRef = await db.collection('ledger_transactions').add(transactionData);
        
        // Update account balance
        await updateAccountBalance(transactionData.companyId, transactionData.type, transactionData.totalAmount);
        
        hideModal('transactionModal');
        form.reset();
        loadDashboard();
        if (currentSection === 'transactions') loadTransactions();
        
        alert('Transaction saved successfully!');
        
      } catch (err) {
        console.error('Error saving transaction:', err);
        alert('Error saving transaction: ' + err.message);
      } finally {
        hideLoader();
      }
    }

    // Save account
    async function saveAccount() {
      const form = document.getElementById('accountForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      showLoader();
      try {
        const accountData = {
          name: document.getElementById('accountName').value,
          type: document.getElementById('accountType').value,
          contactPerson: document.getElementById('contactPerson').value,
          phone: document.getElementById('accountPhone').value,
          address: document.getElementById('accountAddress').value,
          balance: 0,
          totalPurchases: 0,
          totalSales: 0,
          totalPayments: 0,
          totalReceipts: 0,
          outstandingReceivable: 0,
          outstandingPayable: parseFloat(document.getElementById('openingBalance').value) || 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('ledger_accounts').add(accountData);
        
        hideModal('accountModal');
        form.reset();
        populateCompanyDropdowns();
        if (currentSection === 'accounts') loadAccounts();
        
        alert('Account created successfully!');
        
      } catch (err) {
        console.error('Error saving account:', err);
        alert('Error saving account: ' + err.message);
      } finally {
        hideLoader();
      }
    }

    // Update payment status
    async function updatePaymentStatus(transactionId) {
      const newStatus = prompt('Enter payment status (pending/partial/paid):', 'paid');
      if (!newStatus || !['pending', 'partial', 'paid'].includes(newStatus)) return;
      
      let paidAmount = 0;
      if (newStatus === 'partial') {
        paidAmount = parseFloat(prompt('Enter paid amount:')) || 0;
      } else if (newStatus === 'paid') {
        try {
          const doc = await db.collection('ledger_transactions').doc(transactionId).get();
          paidAmount = doc.data().totalAmount;
        } catch (err) {
          console.error('Error getting transaction:', err);
          return;
        }
      }
      
      showLoader();
      try {
        await db.collection('ledger_transactions').doc(transactionId).update({
          paymentStatus: newStatus,
          paidAmount: paidAmount,
          pendingAmount: firebase.firestore.FieldValue.increment(paidAmount),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        loadTransactions();
        loadDashboard();
        alert('Payment status updated successfully!');
        
      } catch (err) {
        console.error('Error updating payment status:', err);
        alert('Error updating payment status: ' + err.message);
      } finally {
        hideLoader();
      }
    }

    // Delete functions
    async function deleteTransaction(transactionId) {
      if (!confirm('Are you sure you want to delete this transaction?')) return;
      
      showLoader();
      try {
        await db.collection('ledger_transactions').doc(transactionId).delete();
        loadTransactions();
        loadDashboard();
        alert('Transaction deleted successfully!');
      } catch (err) {
        console.error('Error deleting transaction:', err);
        alert('Error deleting transaction: ' + err.message);
      } finally {
        hideLoader();
      }
    }

    async function deleteAccount(accountId) {
      if (!confirm('Are you sure you want to delete this account? This will also delete all related transactions.')) return;
      
      showLoader();
      try {
        // Delete all transactions for this account
        const transactionsSnapshot = await db.collection('ledger_transactions')
          .where('companyId', '==', accountId)
          .get();
          
        const batch = db.batch();
        transactionsSnapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        // Delete the account
        batch.delete(db.collection('ledger_accounts').doc(accountId));
        
        await batch.commit();
        
        loadAccounts();
        loadDashboard();
        alert('Account and related transactions deleted successfully!');
      } catch (err) {
        console.error('Error deleting account:', err);
        alert('Error deleting account: ' + err.message);
      } finally {
        hideLoader();
      }
    }

    // Search functionality
    document.addEventListener('DOMContentLoaded', function() {
      const accountSearch = document.getElementById('accountSearch');
      const transactionSearch = document.getElementById('transactionSearch');
      
      if (accountSearch) {
        accountSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll('#accountsTableBody tr');
          
          rows.forEach(row => {
            const companyName = row.cells[0].textContent.toLowerCase();
            if (companyName.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      }
      
      if (transactionSearch) {
        transactionSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const rows = document.querySelectorAll('#transactionsTableBody tr');
          
          rows.forEach(row => {
            const companyName = row.cells[1].textContent.toLowerCase();
            const materialName = row.cells[3].textContent.toLowerCase();
            
            if (companyName.includes(searchTerm) || materialName.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      }
    });

    // Filter functionality
    function applyFilters() {
      const typeFilter = document.getElementById('transactionTypeFilter').value;
      const statusFilter = document.getElementById('paymentStatusFilter').value;
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      
      const rows = document.querySelectorAll('#transactionsTableBody tr');
      
      rows.forEach(row => {
        let show = true;
        
        if (typeFilter && !row.cells[2].textContent.toLowerCase().includes(typeFilter)) {
          show = false;
        }
        
        if (statusFilter && !row.cells[6].textContent.toLowerCase().includes(statusFilter)) {
          show = false;
        }
        
        // Date filtering would require more complex logic
        // For now, we'll skip date filtering in the client-side implementation
        
        row.style.display = show ? '' : 'none';
      });
    }

    function clearFilters() {
      document.getElementById('transactionTypeFilter').value = '';
      document.getElementById('paymentStatusFilter').value = '';
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      
      const rows = document.querySelectorAll('#transactionsTableBody tr');
      rows.forEach(row => {
        row.style.display = '';
      });
    }

    // Placeholder functions for advanced features
    function viewAccountLedger(accountId) {
      alert('Account ledger view will be implemented. Account ID: ' + accountId);
    }

    function editAccount(accountId) {
      alert('Edit account functionality will be implemented. Account ID: ' + accountId);
    }

    function editTransaction(transactionId) {
      alert('Edit transaction functionality will be implemented. Transaction ID: ' + transactionId);
    }

    function recordPayment(accountId) {
      const amount = prompt('Enter payment amount received:');
      if (amount && !isNaN(amount)) {
        // This would create a new receipt transaction
        alert('Payment recording functionality will be implemented. Amount: ₹' + amount);
      }
    }

    function loadReports() {
      // Placeholder for reports
      console.log('Loading reports...');
    }

    function generateReport(type) {
      alert(`Generating ${type} report...`);
    }

    // Initialize the application
    async function initializeApp() {
      showLoader();
      try {
        await autoSignIn();
        await loadExistingData();
        console.log('Application initialized successfully');
      } catch (err) {
        console.error('Error initializing application:', err);
        alert('Error initializing application: ' + err.message);
      } finally {
        hideLoader();
      }
    }

    // Start the application
    initializeApp();
  </script>
</body>
</html>
