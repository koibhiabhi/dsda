<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Aditya Fertilizers - Professional Accounting Ledger</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
:root {
  --primary: #0f766e;
  --primary-dark: #065f57;
  --secondary: #047857;
  --danger: #dc2626;
  --warning: #d97706;
  --success: #059669;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --text-muted: #64748b;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

.header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 1rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--primary);
}

.nav-links {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.nav-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.nav-btn:hover {
  background: var(--primary);
  color: white;
}

.nav-btn.active {
  background: var(--primary);
  color: white;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--card);
  padding: 1.5rem;
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.stat-title {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.stat-change {
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.positive { color: var(--success); }
.negative { color: var(--danger); }
.warning { color: var(--warning); }

.card {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
}

.card-header {
  padding: 1.5rem 1.5rem 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-title {
  font-size: 1.125rem;
  font-weight: 600;
}

.card-content {
  padding: 1.5rem;
}

.table-container {
  overflow-x: auto;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

.table th,
.table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: var(--text-muted);
}

.table tr:hover {
  background: #f8fafc;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.875rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--border);
  color: var(--text);
}

.btn-secondary:hover {
  background: #cbd5e1;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.form-group {
  margin-bottom: 1rem;
}

.label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.input,
.select,
.textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  font-size: 0.875rem;
  transition: border-color 0.2s;
}

.input:focus,
.select:focus,
.textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modal {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
}

.modal-content {
  padding: 1.5rem;
}

.modal-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

.badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.badge-success { background: #dcfce7; color: var(--success); }
.badge-danger { background: #fecaca; color: var(--danger); }
.badge-warning { background: #fef3c7; color: var(--warning); }
.badge-secondary { background: #f1f5f9; color: var(--text-muted); }

.search-bar {
  position: relative;
  margin-bottom: 1.5rem;
}

.search-input {
  padding-left: 2.5rem;
}

.search-icon {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.filters {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.loader {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.actions {
  display: flex;
  gap: 0.5rem;
}

.text-right { text-align: right; }
.text-center { text-align: center; }
.font-medium { font-weight: 500; }
.text-sm { font-size: 0.875rem; }
.text-xs { font-size: 0.75rem; }

.grid {
  display: grid;
  gap: 1rem;
}

.grid-cols-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-cols-3 {
  grid-template-columns: repeat(3, 1fr);
}

.hidden {
  display: none !important;
}

@media (max-width: 768px) {
  .container {
    padding: 1rem;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .header {
    padding: 1rem;
  }
  
  .nav-links {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .filters {
    flex-direction: column;
  }
  
  .table-container {
    font-size: 0.75rem;
  }
}
</style>
</head>

<body>
  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>

  <header class="header">
    <div class="logo">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      Aditya Fertilizers - Accounting Ledger
    </div>
    <nav class="nav-links">
      <button class="nav-btn active" data-section="dashboard">Dashboard</button>
      <button class="nav-btn" data-section="accounts">Accounts</button>
      <button class="nav-btn" data-section="transactions">Transactions</button>
      <button class="nav-btn" data-section="reports">Reports</button>
      <button class="nav-btn" data-section="settings">Settings</button>
    </nav>
  </header>

  <main class="container">
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="section">
      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-title">Total Receivables</div>
          <div class="stat-value" id="totalReceivables">₹0</div>
          <div class="stat-change positive">
            <span>Outstanding from customers</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Total Payables</div>
          <div class="stat-value" id="totalPayables">₹0</div>
          <div class="stat-change negative">
            <span>Outstanding to suppliers</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">Net Position</div>
          <div class="stat-value" id="netPosition">₹0</div>
          <div class="stat-change" id="netPositionChange">
            <span>Overall financial position</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-title">This Month Sales</div>
          <div class="stat-value" id="monthSales">₹0</div>
          <div class="stat-change positive">
            <span>Current month revenue</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Transactions</h3>
            <button class="btn btn-primary btn-sm" onclick="showAddTransactionModal()">Add Transaction</button>
          </div>
          <div class="card-content">
            <div id="recentTransactions">Loading...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Outstanding Payments</h3>
          </div>
          <div class="card-content">
            <div id="outstandingPayments">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Accounts Section -->
    <div id="accounts-section" class="section hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Company Accounts</h3>
          <button class="btn btn-primary" onclick="showAddAccountModal()">Add Account</button>
        </div>
        <div class="card-content">
          <div class="search-bar">
            <input type="text" class="input search-input" placeholder="Search accounts..." id="accountSearch">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="21 21l-4.35-4.35"></path>
            </svg>
          </div>
          <div class="table-container">
            <table class="table" id="accountsTable">
              <thead>
                <tr>
                  <th>Company Name</th>
                  <th>Type</th>
                  <th>Balance</th>
                  <th>Status</th>
                  <th>Last Transaction</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="accountsTableBody">
                <!-- Dynamic content -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Transactions Section -->
    <div id="transactions-section" class="section hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">All Transactions</h3>
          <button class="btn btn-primary" onclick="showAddTransactionModal()">Add Transaction</button>
        </div>
        <div class="card-content">
          <div class="filters">
            <select class="select" id="transactionTypeFilter">
              <option value="">All Types</option>
              <option value="purchase">Purchase</option>
              <option value="sale">Sale</option>
              <option value="payment">Payment</option>
              <option value="receipt">Receipt</option>
            </select>
            <select class="select" id="paymentStatusFilter">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="partial">Partial</option>
              <option value="paid">Paid</option>
            </select>
            <input type="date" class="input" id="fromDate">
            <input type="date" class="input" id="toDate">
            <button class="btn btn-secondary" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
          </div>
          <div class="search-bar">
            <input type="text" class="input search-input" placeholder="Search transactions..." id="transactionSearch">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="21 21l-4.35-4.35"></path>
            </svg>
          </div>
          <div class="table-container">
            <table class="table" id="transactionsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Company</th>
                  <th>Type</th>
                  <th>Material</th>
                  <th>Quantity</th>
                  <th>Amount</th>
                  <th>Payment Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transactionsTableBody">
                <!-- Dynamic content -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Section -->
    <div id="reports-section" class="section hidden">
      <div class="grid grid-cols-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Profit & Loss</h3>
          </div>
          <div class="card-content">
            <canvas id="profitLossChart" width="400" height="200"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Outstanding Analysis</h3>
          </div>
          <div class="card-content">
            <canvas id="outstandingChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">Generate Reports</h3>
        </div>
        <div class="card-content">
          <div class="grid grid-cols-3">
            <button class="btn btn-primary" onclick="generateReport('aging')">Aging Report</button>
            <button class="btn btn-primary" onclick="generateReport('pl')">P&L Statement</button>
            <button class="btn btn-primary" onclick="generateReport('ledger')">Ledger Summary</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div id="settings-section" class="section hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">System Settings</h3>
        </div>
        <div class="card-content">
          <div class="grid grid-cols-2">
            <button class="btn btn-primary" onclick="syncWithSupplyChain()">Sync with Supply Chain</button>
            <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
            <button class="btn btn-warning" onclick="clearDuplicateTransactions()">Clear Duplicates</button>
            <button class="btn btn-warning" onclick="clearCache()">Clear Cache</button>
            <button class="btn btn-danger" onclick="resetSystem()">Reset System</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Transaction Modal -->
  <div id="transactionModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Transaction</h3>
        <button onclick="hideModal('transactionModal')" class="btn btn-secondary btn-sm">✕</button>
      </div>
      <div class="modal-content">
        <form id="transactionForm">
          <div class="form-group">
            <label class="label">Transaction Type</label>
            <select class="select" id="transactionType" required>
              <option value="">Select Type</option>
              <option value="purchase">Purchase</option>
              <option value="sale">Sale</option>
              <option value="payment">Payment Made</option>
              <option value="receipt">Payment Received</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="label">Company</label>
            <select class="select" id="transactionCompany" required>
              <option value="">Select Company</option>
              <!-- Dynamic options -->
            </select>
          </div>
          
          <div class="form-group" id="materialGroup">
            <label class="label">Material</label>
            <select class="select" id="transactionMaterial">
              <option value="">Select Material</option>
              <!-- Dynamic options -->
            </select>
          </div>
          
          <div class="grid grid-cols-2">
            <div class="form-group" id="quantityGroup">
              <label class="label">Quantity (Bags)</label>
              <input type="number" class="input" id="transactionQuantity" step="0.01">
            </div>
            <div class="form-group" id="priceGroup">
              <label class="label">Price per Bag</label>
              <input type="number" class="input" id="transactionPrice" step="0.01">
            </div>
          </div>
          
          <div class="form-group">
            <label class="label">Total Amount</label>
            <input type="number" class="input" id="transactionAmount" step="0.01" required>
          </div>
          
          <div class="form-group">
            <label class="label">Payment Status</label>
            <select class="select" id="paymentStatus" required>
              <option value="pending">Pending</option>
              <option value="partial">Partial</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          
          <div class="form-group" id="paidAmountGroup" style="display: none;">
            <label class="label">Paid Amount</label>
            <input type="number" class="input" id="paidAmount" step="0.01">
          </div>
          
          <div class="form-group">
            <label class="label">Notes</label>
            <textarea class="textarea" id="transactionNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideModal('transactionModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTransaction()">Save Transaction</button>
      </div>
    </div>
  </div>

  <!-- Add Account Modal -->
  <div id="accountModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Company Account</h3>
        <button onclick="hideModal('accountModal')" class="btn btn-secondary btn-sm">✕</button>
      </div>
      <div class="modal-content">
        <form id="accountForm">
          <div class="form-group">
            <label class="label">Company Name</label>
            <input type="text" class="input" id="accountName" required>
          </div>
          
          <div class="form-group">
            <label class="label">Account Type</label>
            <select class="select" id="accountType" required>
              <option value="customer">Customer</option>
              <option value="supplier">Supplier</option>
              <option value="both">Both</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="label">Contact Person</label>
            <input type="text" class="input" id="contactPerson">
          </div>
          
          <div class="form-group">
            <label class="label">Phone</label>
            <input type="tel" class="input" id="accountPhone">
          </div>
          
          <div class="form-group">
            <label class="label">Address</label>
            <textarea class="textarea" id="accountAddress" rows="3"></textarea>
          </div>
          
          <div class="form-group">
            <label class="label">Opening Balance</label>
            <input type="number" class="input" id="openingBalance" step="0.01" placeholder="0.00">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideModal('accountModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveAccount()">Save Account</button>
      </div>
    </div>
  </div>

  <script>
   // Firebase Configuration
   const firebaseConfig = {
       apiKey: "AIzaSyBEybu3XKeK3QOeRIMs-fK2dDwHtpCTqgQ",
       authDomain: "aditya-supply-chain-b5f61.firebaseapp.com",
       projectId: "aditya-supply-chain-b5f61",
       storageBucket: "aditya-supply-chain-b5f61.firebasestorage.app",
       messagingSenderId: "662836162599",
       appId: "1:662836162599:web:2b49bde530e4b87924de02",
       measurementId: "G-DQH00BNH1L"
   };

   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const db = firebase.firestore();
   const auth = firebase.auth();

   // Global state
   let currentSection = 'dashboard';
   let parties = new Map();
   let transactions = [];
   let editingPartyId = null;
   let editingTransactionId = null;

   // Authentication
   const ADMIN_EMAIL = 'adityajainaas@gmail.com';
   const ADMIN_PWD = 'Aditya@1609';

   async function authenticate() {
       try {
           await auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PWD);
           console.log('Authentication successful');
       } catch (error) {
           console.error('Authentication failed:', error);
           showNotification('Authentication failed', 'error');
       }
   }

   // Utility Functions
   function formatCurrency(amount) {
       return new Intl.NumberFormat('en-IN', {
           style: 'currency',
           currency: 'INR',
           minimumFractionDigits: 2
       }).format(amount || 0);
   }

   function formatDate(date) {
       if (!date) return '-';
       if (date.toDate) return date.toDate().toLocaleDateString('en-IN');
       if (date.seconds) return new Date(date.seconds * 1000).toLocaleDateString('en-IN');
       return new Date(date).toLocaleDateString('en-IN');
   }

   function showLoader() {
       document.getElementById('loader').classList.remove('hidden');
   }

   function hideLoader() {
       document.getElementById('loader').classList.add('hidden');
   }

   function showModal(modalId) {
       document.getElementById(modalId).classList.remove('hidden');
   }

   function hideModal(modalId) {
       document.getElementById(modalId).classList.add('hidden');
       if (modalId === 'partyModal') {
           document.getElementById('partyForm').reset();
           editingPartyId = null;
           document.getElementById('partyModalTitle').textContent = 'Add Party';
       }
       if (modalId === 'transactionModal') {
           document.getElementById('transactionForm').reset();
           editingTransactionId = null;
           document.getElementById('transactionModalTitle').textContent = 'Add Transaction';
       }
   }

   // Navigation
   function showSection(sectionName) {
       document.querySelectorAll('.section').forEach(section => {
           section.classList.remove('active');
       });
       
       document.querySelectorAll('.nav-btn').forEach(btn => {
           btn.classList.remove('active');
       });

       document.getElementById(sectionName).classList.add('active');
       event.target.classList.add('active');
       
       currentSection = sectionName;

       switch (sectionName) {
           case 'dashboard':
               loadDashboard();
               break;
           case 'parties':
               loadParties();
               break;
           case 'transactions':
               loadTransactions();
               break;
           case 'reports':
               break;
       }
   }

   // Party Management
   async function loadParties() {
       showLoader();
       try {
           const partiesRef = db.collection('ledger_parties');
           const snapshot = await partiesRef.orderBy('name').get();
           
           const tbody = document.getElementById('partiesTableBody');
           tbody.innerHTML = '';
           
           parties.clear();

           if (snapshot.empty) {
               tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No parties found. Add your first party to get started.</td></tr>';
               return;
           }

           for (const doc of snapshot.docs) {
               const party = { id: doc.id, ...doc.data() };
               parties.set(doc.id, party);

               const balance = party.currentBalance || 0;
               const balanceClass = balance > 0 ? 'positive' : balance < 0 ? 'negative' : '';
               const status = balance === 0 ? 'Settled' : balance > 0 ? 'Receivable' : 'Payable';
               const statusClass = balance === 0 ? 'badge-success' : balance > 0 ? 'badge-warning' : 'badge-danger';

               const row = `
                   <tr>
                       <td>
                           <div class="font-medium">${party.name}</div>
                           <div class="text-xs text-muted">${party.contactPerson || ''} ${party.phone || ''}</div>
                       </td>
                       <td><span class="badge badge-secondary">${party.type}</span></td>
                       <td class="text-right">
                           <div class="font-medium ${balanceClass}">${formatCurrency(Math.abs(balance))}</div>
                           <div class="text-xs text-muted">${balance > 0 ? 'They owe you' : balance < 0 ? 'You owe them' : 'Settled'}</div>
                       </td>
                       <td><span class="badge ${statusClass}">${status}</span></td>
                       <td class="text-sm">${formatDate(party.lastTransactionDate)}</td>
                       <td>
                           <div class="actions">
                               <button class="btn btn-primary btn-sm" onclick="viewPartyLedger('${doc.id}')">Ledger</button>
                               <button class="btn btn-secondary btn-sm" onclick="editParty('${doc.id}')">Edit</button>
                               <button class="btn btn-danger btn-sm" onclick="deleteParty('${doc.id}')">Delete</button>
                           </div>
                       </td>
                   </tr>
               `;

               tbody.innerHTML += row;
           }

           updatePartyDropdown();
       } catch (error) {
           console.error('Error loading parties:', error);
           showNotification('Error loading parties: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   function showAddPartyModal() {
       editingPartyId = null;
       document.getElementById('partyModalTitle').textContent = 'Add Party';
       document.getElementById('partyForm').reset();
       showModal('partyModal');
   }

   function editParty(partyId) {
       const party = parties.get(partyId);
       if (!party) return;

       editingPartyId = partyId;
       document.getElementById('partyModalTitle').textContent = 'Edit Party';
       
       document.getElementById('partyName').value = party.name || '';
       document.getElementById('partyType').value = party.type || '';
       document.getElementById('contactPerson').value = party.contactPerson || '';
       document.getElementById('partyPhone').value = party.phone || '';
       document.getElementById('partyEmail').value = party.email || '';
       document.getElementById('openingBalance').value = party.openingBalance || 0;
       document.getElementById('partyAddress').value = party.address || '';
       document.getElementById('partyNotes').value = party.notes || '';

       showModal('partyModal');
   }

   async function saveParty() {
       const form = document.getElementById('partyForm');
       if (!form.checkValidity()) {
           form.reportValidity();
           return;
       }

       showLoader();
       try {
           const partyData = {
               name: document.getElementById('partyName').value.trim(),
               type: document.getElementById('partyType').value,
               contactPerson: document.getElementById('contactPerson').value.trim(),
               phone: document.getElementById('partyPhone').value.trim(),
               email: document.getElementById('partyEmail').value.trim(),
               address: document.getElementById('partyAddress').value.trim(),
               notes: document.getElementById('partyNotes').value.trim(),
               openingBalance: parseFloat(document.getElementById('openingBalance').value) || 0,
               currentBalance: parseFloat(document.getElementById('openingBalance').value) || 0,
               lastTransactionDate: null,
               createdAt: new Date(),
               updatedAt: new Date()
           };

           if (editingPartyId) {
               const partyRef = db.collection('ledger_parties').doc(editingPartyId);
               partyData.updatedAt = new Date();
               await partyRef.update(partyData);
               showNotification('Party updated successfully!', 'success');
           } else {
               await db.collection('ledger_parties').add(partyData);
               showNotification('Party added successfully!', 'success');
           }

           hideModal('partyModal');
           await loadParties();
           if (currentSection === 'dashboard') {
               await loadDashboard();
           }
       } catch (error) {
           console.error('Error saving party:', error);
           showNotification('Error saving party: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   async function deleteParty(partyId) {
       const party = parties.get(partyId);
       if (!party) return;

       if (!confirm(`Are you sure you want to delete "${party.name}"? This will also delete all related transactions and cannot be undone.`)) {
           return;
       }

       showLoader();
       try {
           const transactionsRef = db.collection('ledger_transactions');
           const transactionQuery = transactionsRef.where('partyId', '==', partyId);
           const transactionSnapshot = await transactionQuery.get();

           for (const transactionDoc of transactionSnapshot.docs) {
               await transactionDoc.ref.delete();
           }

           await db.collection('ledger_parties').doc(partyId).delete();

           showNotification('Party and all related transactions deleted successfully!', 'success');
           await loadParties();
           if (currentSection === 'dashboard') {
               await loadDashboard();
           }
       } catch (error) {
           console.error('Error deleting party:', error);
           showNotification('Error deleting party: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   // Transaction Management
   async function loadTransactions() {
       showLoader();
       try {
           const transactionsRef = db.collection('ledger_transactions');
           const snapshot = await transactionsRef.orderBy('date', 'desc').get();
           
           const tbody = document.getElementById('transactionsTableBody');
           tbody.innerHTML = '';
           
           transactions = [];

           if (snapshot.empty) {
               tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transactions found. Add your first transaction to get started.</td></tr>';
               return;
           }

           for (const doc of snapshot.docs) {
               const transaction = { id: doc.id, ...doc.data() };
               transactions.push(transaction);

               const party = parties.get(transaction.partyId);
               const partyName = party ? party.name : 'Unknown Party';

               const typeIcons = {
                   sale: '💰',
                   purchase: '📦',
                   payment: '💸',
                   receipt: '💵'
               };

               const typeClasses = {
                   sale: 'positive',
                   receipt: 'positive',
                   purchase: 'negative',
                   payment: 'negative'
               };

               const row = `
                   <tr onclick="viewTransactionDetails('${doc.id}')" style="cursor: pointer;">
                       <td class="text-sm">${formatDate(transaction.date)}</td>
                       <td class="font-medium">${partyName}</td>
                       <td>
                           <span class="badge badge-secondary">
                               ${typeIcons[transaction.type]} ${transaction.type.toUpperCase()}
                           </span>
                       </td>
                       <td class="text-sm">${transaction.description || '-'}</td>
                       <td class="text-right">
                           <div class="font-medium ${typeClasses[transaction.type]}">${formatCurrency(transaction.amount)}</div>
                       </td>
                       <td>
                           <span class="badge badge-success">COMPLETED</span>
                       </td>
                       <td onclick="event.stopPropagation()">
                           <div class="actions">
                               <button class="btn btn-secondary btn-sm" onclick="editTransaction('${doc.id}')">Edit</button>
                               <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${doc.id}')">Delete</button>
                           </div>
                       </td>
                   </tr>
               `;

               tbody.innerHTML += row;
           }
       } catch (error) {
           console.error('Error loading transactions:', error);
           showNotification('Error loading transactions: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   function showAddTransactionModal() {
       editingTransactionId = null;
       document.getElementById('transactionModalTitle').textContent = 'Add Transaction';
       document.getElementById('transactionForm').reset();
       document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
       updatePartyDropdown();
       showModal('transactionModal');
   }

   function updatePartyDropdown() {
       const select = document.getElementById('transactionParty');
       if (!select) return;

       select.innerHTML = '<option value="">Select Party</option>';
       
       parties.forEach((party, id) => {
           const option = document.createElement('option');
           option.value = id;
           option.textContent = `${party.name} (${party.type})`;
           select.appendChild(option);
       });
   }

   function updateTransactionFields() {
       const type = document.getElementById('transactionType').value;
       const partySelect = document.getElementById('transactionParty');
       
       updatePartyDropdown();
       
       if (type === 'sale' || type === 'receipt') {
           Array.from(partySelect.options).forEach(option => {
               if (option.value) {
                   const party = parties.get(option.value);
                   if (party && party.type !== 'customer' && party.type !== 'both') {
                       option.style.display = 'none';
                   } else {
                       option.style.display = 'block';
                   }
               }
           });
       } else if (type === 'purchase' || type === 'payment') {
           Array.from(partySelect.options).forEach(option => {
               if (option.value) {
                   const party = parties.get(option.value);
                   if (party && party.type !== 'supplier' && party.type !== 'both') {
                       option.style.display = 'none';
                   } else {
                       option.style.display = 'block';
                   }
               }
           });
       } else {
           Array.from(partySelect.options).forEach(option => {
               option.style.display = 'block';
           });
       }
   }

   function editTransaction(transactionId) {
       const transaction = transactions.find(t => t.id === transactionId);
       if (!transaction) return;

       editingTransactionId = transactionId;
       document.getElementById('transactionModalTitle').textContent = 'Edit Transaction';
       
       document.getElementById('transactionType').value = transaction.type || '';
       document.getElementById('transactionParty').value = transaction.partyId || '';
       document.getElementById('transactionAmount').value = transaction.amount || '';
       document.getElementById('transactionDate').value = transaction.date ? new Date(transaction.date.seconds * 1000).toISOString().split('T')[0] : '';
       document.getElementById('transactionDescription').value = transaction.description || '';
       document.getElementById('transactionReference').value = transaction.reference || '';

       updateTransactionFields();
       showModal('transactionModal');
   }

   async function saveTransaction() {
       const form = document.getElementById('transactionForm');
       if (!form.checkValidity()) {
           form.reportValidity();
           return;
       }

       showLoader();
       try {
           const partyId = document.getElementById('transactionParty').value;
           const type = document.getElementById('transactionType').value;
           const amount = parseFloat(document.getElementById('transactionAmount').value);
           
           const transactionData = {
               partyId: partyId,
               type: type,
               amount: amount,
               date: new Date(document.getElementById('transactionDate').value),
               description: document.getElementById('transactionDescription').value.trim(),
               reference: document.getElementById('transactionReference').value.trim(),
               createdAt: new Date(),
               updatedAt: new Date()
           };

           let balanceChange = 0;
           switch (type) {
               case 'sale':
                   balanceChange = amount;
                   break;
               case 'purchase':
                   balanceChange = -amount;
                   break;
               case 'payment':
                   balanceChange = amount;
                   break;
               case 'receipt':
                   balanceChange = -amount;
                   break;
           }

           if (editingTransactionId) {
               const oldTransaction = transactions.find(t => t.id === editingTransactionId);
               
               let oldBalanceChange = 0;
               switch (oldTransaction.type) {
                   case 'sale':
                       oldBalanceChange = -oldTransaction.amount;
                       break;
                   case 'purchase':
                       oldBalanceChange = oldTransaction.amount;
                       break;
                   case 'payment':
                       oldBalanceChange = -oldTransaction.amount;
                       break;
                   case 'receipt':
                       oldBalanceChange = oldTransaction.amount;
                       break;
               }
               
               const netBalanceChange = balanceChange + oldBalanceChange;
               await updatePartyBalance(partyId, netBalanceChange);
               
               transactionData.updatedAt = new Date();
               await db.collection('ledger_transactions').doc(editingTransactionId).update(transactionData);
               showNotification('Transaction updated successfully!', 'success');
           } else {
               await db.collection('ledger_transactions').add(transactionData);
               await updatePartyBalance(partyId, balanceChange);
               showNotification('Transaction added successfully!', 'success');
           }

           hideModal('transactionModal');
           await loadTransactions();
           if (currentSection === 'dashboard') {
               await loadDashboard();
           }
           if (currentSection === 'parties') {
               await loadParties();
           }
       } catch (error) {
           console.error('Error saving transaction:', error);
           showNotification('Error saving transaction: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   async function updatePartyBalance(partyId, balanceChange) {
       const partyRef = db.collection('ledger_parties').doc(partyId);
       const party = parties.get(partyId);
       
       const newBalance = (party.currentBalance || 0) + balanceChange;
       
       await partyRef.update({
           currentBalance: newBalance,
           lastTransactionDate: new Date(),
           updatedAt: new Date()
       });
       
       party.currentBalance = newBalance;
       party.lastTransactionDate = new Date();
   }

   async function deleteTransaction(transactionId) {
       const transaction = transactions.find(t => t.id === transactionId);
       if (!transaction) return;

       if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
           return;
       }

       showLoader();
       try {
           let balanceChange = 0;
           switch (transaction.type) {
               case 'sale':
                   balanceChange = -transaction.amount;
                   break;
               case 'purchase':
                   balanceChange = transaction.amount;
                   break;
               case 'payment':
                   balanceChange = -transaction.amount;
                   break;
               case 'receipt':
                   balanceChange = transaction.amount;
                   break;
           }

           await updatePartyBalance(transaction.partyId, balanceChange);
           await db.collection('ledger_transactions').doc(transactionId).delete();

           showNotification('Transaction deleted successfully!', 'success');
           await loadTransactions();
           if (currentSection === 'dashboard') {
               await loadDashboard();
           }
           if (currentSection === 'parties') {
               await loadParties();
           }
       } catch (error) {
           console.error('Error deleting transaction:', error);
           showNotification('Error deleting transaction: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   // Dashboard
   async function loadDashboard() {
       showLoader();
       try {
           let totalReceivables = 0;
           let totalPayables = 0;
           let monthSales = 0;

           parties.forEach(party => {
               const balance = party.currentBalance || 0;
               if (balance > 0) {
                   totalReceivables += balance;
               } else if (balance < 0) {
                   totalPayables += Math.abs(balance);
               }
           });

           const startOfMonth = new Date();
           startOfMonth.setDate(1);
           startOfMonth.setHours(0, 0, 0, 0);

           transactions.forEach(transaction => {
               const transactionDate = transaction.date.seconds ? 
                   new Date(transaction.date.seconds * 1000) : 
                   new Date(transaction.date);
               
               if (transactionDate >= startOfMonth && transaction.type === 'sale') {
                   monthSales += transaction.amount || 0;
               }
           });

           const netPosition = totalReceivables - totalPayables;

           document.getElementById('totalReceivables').textContent = formatCurrency(totalReceivables);
           document.getElementById('totalPayables').textContent = formatCurrency(totalPayables);
           document.getElementById('netPosition').textContent = formatCurrency(netPosition);
           document.getElementById('monthSales').textContent = formatCurrency(monthSales);

           const netPositionElement = document.getElementById('netPosition');
           const netPositionText = document.getElementById('netPositionText');
           
           if (netPosition > 0) {
               netPositionElement.className = 'stat-value positive';
               netPositionText.textContent = 'You are owed money';
           } else if (netPosition < 0) {
               netPositionElement.className = 'stat-value negative';
               netPositionText.textContent = 'You owe money';
           } else {
               netPositionElement.className = 'stat-value';
               netPositionText.textContent = 'All settled';
           }

           await loadRecentTransactions();
           await loadOutstandingReceivables();

       } catch (error) {
           console.error('Error loading dashboard:', error);
           showNotification('Error loading dashboard: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   async function loadRecentTransactions() {
       const container = document.getElementById('recentTransactions');
       
       if (transactions.length === 0) {
           container.innerHTML = '<div class="text-center text-muted">No transactions yet</div>';
           return;
       }

       const recentTransactions = transactions.slice(0, 5);
       let html = '';

       recentTransactions.forEach(transaction => {
           const party = parties.get(transaction.partyId);
           const partyName = party ? party.name : 'Unknown Party';
           
           const typeIcons = {
               sale: '💰',
               purchase: '📦',
               payment: '💸',
               receipt: '💵'
           };

           const typeClasses = {
               sale: 'positive',
               receipt: 'positive',
               purchase: 'negative',
               payment: 'negative'
           };

           html += `
               <div class="recent-item" onclick="viewTransactionDetails('${transaction.id}')">
                   <div class="recent-info">
                       <h4>${typeIcons[transaction.type]} ${partyName}</h4>
                       <p>${transaction.type.toUpperCase()} • ${formatDate(transaction.date)}</p>
                   </div>
                   <div class="recent-amount">
                       <div class="amount ${typeClasses[transaction.type]}">${formatCurrency(transaction.amount)}</div>
                       <div class="status badge badge-success">COMPLETED</div>
                   </div>
               </div>
           `;
       });

       container.innerHTML = html;
   }

   async function loadOutstandingReceivables() {
       const container = document.getElementById('outstandingReceivables');
       
       const receivableParties = Array.from(parties.values())
           .filter(party => (party.currentBalance || 0) > 0)
           .sort((a, b) => (b.currentBalance || 0) - (a.currentBalance || 0))
           .slice(0, 5);

       if (receivableParties.length === 0) {
           container.innerHTML = '<div class="text-center text-muted">No outstanding amounts</div>';
           return;
       }

       let html = '';

       receivableParties.forEach(party => {
           const urgencyClass = party.currentBalance > 50000 ? 'negative' : 
                              party.currentBalance > 20000 ? 'warning' : 'positive';

           html += `
               <div class="recent-item" onclick="viewPartyLedger('${party.id}')">
                   <div class="recent-info">
                       <h4>${party.name}</h4>
                       <p>Outstanding Receivable • ${party.type}</p>
                   </div>
                   <div class="recent-amount">
                       <div class="amount ${urgencyClass}">${formatCurrency(party.currentBalance)}</div>
                   </div>
               </div>
           `;
       });

       container.innerHTML = html;
   }

   // Reports and Views
   function viewTransactionDetails(transactionId) {
       const transaction = transactions.find(t => t.id === transactionId);
       if (!transaction) return;

       const party = parties.get(transaction.partyId);
       const partyName = party ? party.name : 'Unknown Party';

       const typeDescriptions = {
           sale: 'Customer owes you money',
           purchase: 'You owe supplier money',
           payment: 'You paid supplier',
           receipt: 'Customer paid you'
       };

       showNotification(`${typeDescriptions[transaction.type]}: ${formatCurrency(transaction.amount)} - ${partyName}`, 'info');
   }

   function viewPartyLedger(partyId) {
       const party = parties.get(partyId);
       if (!party) return;

       const partyTransactions = transactions.filter(t => t.partyId === partyId);
       
       if (partyTransactions.length === 0) {
           showNotification(`No transactions found for ${party.name}`, 'info');
           return;
       }

       showNotification(`${party.name} has ${partyTransactions.length} transactions. Balance: ${formatCurrency(party.currentBalance || 0)}`, 'info');
   }

   // Report Generation Functions
   function generatePartyLedger() {
       showNotification('Party Ledger Report - This feature will show detailed transaction history for each party', 'info');
   }

   function generateProfitLoss() {
       let totalSales = 0;
       let totalPurchases = 0;
       
       transactions.forEach(transaction => {
           if (transaction.type === 'sale') {
               totalSales += transaction.amount || 0;
           } else if (transaction.type === 'purchase') {
               totalPurchases += transaction.amount || 0;
           }
       });
       
       const profit = totalSales - totalPurchases;
       showNotification(`Profit & Loss: Sales ${formatCurrency(totalSales)} - Purchases ${formatCurrency(totalPurchases)} = ${formatCurrency(profit)}`, profit >= 0 ? 'success' : 'warning');
   }

   function generateOutstandingReport() {
       let totalReceivables = 0;
       let totalPayables = 0;
       
       parties.forEach(party => {
           const balance = party.currentBalance || 0;
           if (balance > 0) {
               totalReceivables += balance;
           } else if (balance < 0) {
               totalPayables += Math.abs(balance);
           }
       });
       
       showNotification(`Outstanding Report: Receivables ${formatCurrency(totalReceivables)} - Payables ${formatCurrency(totalPayables)}`, 'info');
   }

   function generateCashFlow() {
       let totalReceipts = 0;
       let totalPayments = 0;
       
       transactions.forEach(transaction => {
           if (transaction.type === 'receipt') {
               totalReceipts += transaction.amount || 0;
           } else if (transaction.type === 'payment') {
               totalPayments += transaction.amount || 0;
           }
       });
       
       const netCashFlow = totalReceipts - totalPayments;
       showNotification(`Cash Flow: Receipts ${formatCurrency(totalReceipts)} - Payments ${formatCurrency(totalPayments)} = ${formatCurrency(netCashFlow)}`, 'info');
   }

   // Notification System
   function showNotification(message, type = 'info') {
       const notification = document.createElement('div');
       notification.style.cssText = `
           position: fixed;
           top: 20px;
           right: 20px;
           background: ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : type === 'warning' ? '#d97706' : '#2563eb'};
           color: white;
           padding: 1rem 1.5rem;
           border-radius: 0.5rem;
           box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
           z-index: 10000;
           max-width: 400px;
           animation: slideIn 0.3s ease-out;
       `;

       notification.textContent = message;
       document.body.appendChild(notification);

       setTimeout(() => {
           notification.style.animation = 'slideOut 0.3s ease-in forwards';
           setTimeout(() => notification.remove(), 300);
       }, 5000);
   }

   // Search functionality
   function initializeSearch() {
       const partiesSearch = document.getElementById('partiesSearch');
       const transactionsSearch = document.getElementById('transactionsSearch');

       if (partiesSearch) {
           partiesSearch.addEventListener('input', function() {
               const searchTerm = this.value.toLowerCase();
               const rows = document.querySelectorAll('#partiesTableBody tr');
               
               rows.forEach(row => {
                   const text = row.textContent.toLowerCase();
                   row.style.display = text.includes(searchTerm) ? '' : 'none';
               });
           });
       }

       if (transactionsSearch) {
           transactionsSearch.addEventListener('input', function() {
               const searchTerm = this.value.toLowerCase();
               const rows = document.querySelectorAll('#transactionsTableBody tr');
               
               rows.forEach(row => {
                   const text = row.textContent.toLowerCase();
                   row.style.display = text.includes(searchTerm) ? '' : 'none';
               });
           });
       }
   }

   // Initialize Application
   async function initializeApp() {
       showLoader();
       try {
           console.log('Initializing Professional Ledger System...');
           
           await authenticate();
           
           // Load data
           await loadParties();
           await loadTransactions();
           await loadDashboard();
           
           // Initialize search
           initializeSearch();
           
           console.log('Application initialized successfully');
           showNotification('Ledger system loaded successfully!', 'success');
           
       } catch (error) {
           console.error('Error initializing app:', error);
           showNotification('Error initializing application: ' + error.message, 'error');
       } finally {
           hideLoader();
       }
   }

   // Start the application
   document.addEventListener('DOMContentLoaded', initializeApp);

   // Add CSS animations
   const style = document.createElement('style');
   style.textContent = `
       @keyframes slideIn {
           from { transform: translateX(100%); opacity: 0; }
           to { transform: translateX(0); opacity: 1; }
       }
       @keyframes slideOut {
           from { transform: translateX(0); opacity: 1; }
           to { transform: translateX(100%); opacity: 0; }
       }
   `;
   document.head.appendChild(style);

   // Global error handling
   window.addEventListener('error', function(e) {
       console.error('Global error:', e.error);
       showNotification('An unexpected error occurred. Please refresh the page.', 'error');
   });

   window.addEventListener('unhandledrejection', function(e) {
       console.error('Unhandled promise rejection:', e.reason);
       showNotification('An unexpected error occurred. Please try again.', 'error');
   });

   // Global function exports for onclick handlers
   window.showSection = showSection;
   window.showAddPartyModal = showAddPartyModal;
   window.showAddTransactionModal = showAddTransactionModal;
   window.saveParty = saveParty;
   window.saveTransaction = saveTransaction;
   window.hideModal = hideModal;
   window.editParty = editParty;
   window.editTransaction = editTransaction;
   window.deleteParty = deleteParty;
   window.deleteTransaction = deleteTransaction;
   window.updateTransactionFields = updateTransactionFields;
   window.viewTransactionDetails = viewTransactionDetails;
   window.viewPartyLedger = viewPartyLedger;
   window.generatePartyLedger = generatePartyLedger;
   window.generateProfitLoss = generateProfitLoss;
   window.generateOutstandingReport = generateOutstandingReport;
   window.generateCashFlow = generateCashFlow;
</script>
</body>
</html>
