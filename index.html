<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Aditya Fertilizers - Professional Accounting Ledger</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
:root {
  --primary: #0f766e;
  --primary-dark: #065f57;
  --secondary: #047857;
  --danger: #dc2626;
  --warning: #d97706;
  --success: #059669;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --text-muted: #64748b;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  font-size: 14px;
}

.header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
  gap: 1rem;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--primary);
  text-align: center;
}

.nav-links {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
  justify-content: center;
}

.nav-btn {
  padding: 0.5rem 0.75rem;
  border: none;
  border-radius: 0.5rem;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  font-size: 0.85rem;
  white-space: nowrap;
}

.nav-btn:hover {
  background: var(--primary);
  color: white;
}

.nav-btn.active {
  background: var(--primary);
  color: white;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1rem;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: var(--card);
  padding: 1.25rem;
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.stat-title {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.stat-change {
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.positive { color: var(--success); }
.negative { color: var(--danger); }
.warning { color: var(--warning); }

.card {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 1.5rem;
}

.card-header {
  padding: 1.25rem 1.25rem 0;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  justify-content: space-between;
  align-items: flex-start;
}

.card-title {
  font-size: 1.1rem;
  font-weight: 600;
}

.card-content {
  padding: 1.25rem;
}

.table-container {
  overflow-x: auto;
  width: 100%;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
  min-width: 600px;
}

.table th,
.table td {
  padding: 0.6rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: var(--text-muted);
}

.table tr:hover {
  background: #f8fafc;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.8rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--border);
  color: var(--text);
}

.btn-secondary:hover {
  background: #cbd5e1;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.form-group {
  margin-bottom: 1rem;
}

.label {
  display: block;
  font-size: 0.8rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.input,
.select,
.textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  font-size: 0.85rem;
  transition: border-color 0.2s;
}

.input:focus,
.select:focus,
.textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modal {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 1.25rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.1rem;
  font-weight: 600;
}

.modal-content {
  padding: 1.25rem;
}

.modal-footer {
  padding: 1.25rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.badge {
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.7rem;
  font-weight: 500;
  white-space: nowrap;
}

.badge-success { background: #dcfce7; color: var(--success); }
.badge-danger { background: #fecaca; color: var(--danger); }
.badge-warning { background: #fef3c7; color: var(--warning); }
.badge-secondary { background: #f1f5f9; color: var(--text-muted); }

.search-bar {
  position: relative;
  margin-bottom: 1rem;
}

.search-input {
  padding-left: 2.5rem;
}

.search-icon {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.filters {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.loader {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.text-right { text-align: right; }
.text-center { text-align: center; }
.font-medium { font-weight: 500; }
.text-sm { font-size: 0.8rem; }
.text-xs { font-size: 0.7rem; }

.grid {
  display: grid;
  gap: 1rem;
}

.grid-cols-1 {
  grid-template-columns: 1fr;
}

.grid-cols-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-cols-3 {
  grid-template-columns: repeat(3, 1fr);
}

.hidden {
  display: none !important;
}

/* Password modal styles */
.password-modal-content {
  padding: 1.5rem;
  text-align: center;
}

.password-input {
  margin: 1rem 0;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  width: 100%;
  font-size: 1rem;
}

/* Responsive adjustments */
@media (min-width: 768px) {
  .header {
    flex-direction: row;
    padding: 1rem 2rem;
  }
  
  .card-header {
    flex-direction: row;
    align-items: center;
  }
  
  .container {
    padding: 2rem;
  }
  
  .dashboard-grid {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .nav-links {
    gap: 1rem;
  }
  
  .nav-btn {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
  }
  
  body {
    font-size: 16px;
  }
}

@media (max-width: 640px) {
  .grid-cols-2,
  .grid-cols-3 {
    grid-template-columns: 1fr;
  }
  
  .filters {
    flex-direction: column;
  }
  
  .filters .select,
  .filters .input {
    width: 100%;
  }
  
  .modal-footer {
    flex-direction: column;
  }
  
  .modal-footer .btn {
    width: 100%;
  }
  
  .actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .table {
    font-size: 0.75rem;
  }
  
  .table th,
  .table td {
    padding: 0.4rem;
  }
}

/* Print styles for reports */
@media print {
  .header,
  .nav-links,
  .btn,
  .modal-footer {
    display: none !important;
  }
  
  .container {
    padding: 0;
    margin: 0;
    width: 100%;
  }
  
  .card {
    box-shadow: none;
    border: none;
    margin: 0;
  }
}
</style>
</head>
<body>
<div class="loader" id="loader">
  <div class="spinner"></div>
</div>

<header class="header">
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
    </svg>
    Aditya Fertilizers - Accounting Ledger
  </div>
  <nav class="nav-links">
    <button class="nav-btn active" data-section="dashboard">Dashboard</button>
    <button class="nav-btn" data-section="accounts">Accounts</button>
    <button class="nav-btn" data-section="transactions">Transactions</button>
    <button class="nav-btn" data-section="reports">Reports</button>
    <button class="nav-btn" data-section="settings">Settings</button>
  </nav>
</header>

<main class="container">
  <!-- Dashboard Section -->
  <div id="dashboard-section" class="section">
    <div class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-title">Total Receivables</div>
        <div class="stat-value" id="totalReceivables">Loading...</div>
        <div class="stat-change positive">
          <span>Outstanding from customers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Payables</div>
        <div class="stat-value" id="totalPayables">Loading...</div>
        <div class="stat-change negative">
          <span>Outstanding to suppliers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Overall Balance</div>
        <div class="stat-value" id="netPosition">Loading...</div>
        <div class="stat-change" id="netPositionChange">
          <span>Overall financial position</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">This Month Sales</div>
        <div class="stat-value" id="monthSales">Loading...</div>
        <div class="stat-change positive">
          <span>Current month revenue</span>
        </div>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Recent Transactions</h3>
          <button class="btn btn-primary btn-sm" onclick="showAddTransactionModal()">Add Transaction</button>
        </div>
        <div class="card-content">
          <div id="recentTransactions">Loading...</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Outstanding Payments</h3>
        </div>
        <div class="card-content">
          <div id="outstandingPayments">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts Section -->
  <div id="accounts-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Company Accounts</h3>
        <button class="btn btn-primary" onclick="showAddAccountModal()">Add Account</button>
      </div>
      <div class="card-content">
        <div class="search-bar">
          <input type="text" class="input search-input" placeholder="Search accounts..." id="accountSearch">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
        </div>
        <div class="table-container">
          <table class="table" id="accountsTable">
            <thead>
              <tr>
                <th>Company Name</th>
                <th>Type</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="accountsList">
              <tr><td colspan="5" class="text-center">Loading accounts...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions Section -->
  <div id="transactions-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">All Transactions</h3>
        <button class="btn btn-primary" onclick="showAddTransactionModal()">Add Transaction</button>
      </div>
      <div class="card-content">
        <div class="filters">
          <select class="select" id="transactionTypeFilter">
            <option value="all">All Types</option>
            <option value="sale">Sales</option>
            <option value="purchase">Purchases</option>
            <option value="payment">Payments</option>
            <option value="receipt">Receipts</option>
          </select>
          <select class="select" id="transactionStatusFilter">
            <option value="all">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="partial">Partial</option>
            <option value="paid">Paid</option>
          </select>
          <input type="date" class="input" id="startDateFilter">
          <input type="date" class="input" id="endDateFilter">
          <button class="btn btn-secondary" onclick="filterTransactions()">Apply Filters</button>
        </div>
        <div class="table-container">
          <table class="table" id="transactionsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Account</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="transactionsList">
              <tr><td colspan="6" class="text-center">Loading transactions...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Section -->
  <div id="reports-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Financial Reports</h3>
        <div class="actions">
          <button class="btn btn-secondary" onclick="generateSalesReport()">Sales Report</button>
          <button class="btn btn-secondary" onclick="generatePurchaseReport()">Purchase Report</button>
          <button class="btn btn-secondary" onclick="generateLedgerReport()">Ledger Report</button>
        </div>
      </div>
      <div class="card-content">
        <div id="reportContainer">
          <p class="text-center">Select a report to generate from the options above.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Section -->
  <div id="settings-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">System Settings</h3>
      </div>
      <div class="card-content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h4 class="font-medium mb-2">System Management</h4>
            <p class="text-sm text-muted mb-4">Administrative functions requiring password confirmation</p>
            
            <button class="btn btn-warning mb-2" onclick="showPasswordModal('clearDuplicates')">Clear Duplicates</button>
            <button class="btn btn-warning mb-2" onclick="showPasswordModal('clearCache')">Clear Cache</button>
            <button class="btn btn-danger mb-2" onclick="showPasswordModal('resetSystem')">Reset System</button>
          </div>
          <div>
            <h4 class="font-medium mb-2">Data Backup</h4>
            <p class="text-sm text-muted mb-4">Manage your data backups and restores</p>
            
            <button class="btn btn-secondary mb-2" onclick="backupData()">Backup Data</button>
            <button class="btn btn-secondary" onclick="restoreData()">Restore Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Password Modal -->
<div class="modal-backdrop hidden" id="passwordModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h3 class="modal-title">Admin Authentication</h3>
      <button class="btn btn-secondary btn-sm" onclick="closePasswordModal()">×</button>
    </div>
    <div class="password-modal-content">
      <p>Please enter the admin password to continue:</p>
      <input type="password" class="password-input" id="adminPassword" placeholder="Enter password">
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
        <button class="btn btn-primary" onclick="verifyPassword()">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Account Modal -->
<div class="modal-backdrop hidden" id="addAccountModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Add New Account</h3>
      <button class="btn btn-secondary btn-sm" onclick="closeModal('addAccountModal')">×</button>
    </div>
    <div class="modal-content">
      <form id="addAccountForm">
        <div class="form-group">
          <label class="label" for="companyName">Company Name</label>
          <input type="text" class="input" id="companyName" required>
        </div>
        <div class="form-group">
          <label class="label" for="accountType">Account Type</label>
          <select class="select" id="accountType" required>
            <option value="customer">Customer</option>
            <option value="supplier">Supplier</option>
            <option value="bank">Bank</option>
            <option value="cash">Cash</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label" for="openingBalance">Opening Balance</label>
          <input type="number" class="input" id="openingBalance" value="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="label" for="accountNotes">Notes</label>
          <textarea class="textarea" id="accountNotes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addAccountModal')">Cancel</button>
      <button class="btn btn-primary" onclick="addAccount()">Save Account</button>
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal-backdrop hidden" id="addTransactionModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Add New Transaction</h3>
      <button class="btn btn-secondary btn-sm" onclick="closeModal('addTransactionModal')">×</button>
    </div>
    <div class="modal-content">
      <form id="addTransactionForm">
        <div class="form-group">
          <label class="label" for="transactionType">Transaction Type</label>
          <select class="select" id="transactionType" required onchange="toggleTransactionFields()">
            <option value="sale">Sale</option>
            <option value="purchase">Purchase</option>
            <option value="payment">Payment</option>
            <option value="receipt">Receipt</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label" for="transactionAccount">Account</label>
          <select class="select" id="transactionAccount" required></select>
        </div>
        <div class="form-group">
          <label class="label" for="transactionAmount">Amount (₹)</label>
          <input type="number" class="input" id="transactionAmount" required step="0.01" min="0">
        </div>
        <div class="form-group" id="paymentAmountGroup">
          <label class="label" for="paymentAmount">Payment Amount (₹)</label>
          <input type="number" class="input" id="paymentAmount" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label class="label" for="transactionDate">Date</label>
          <input type="date" class="input" id="transactionDate" required>
        </div>
        <div class="form-group">
          <label class="label" for="transactionNotes">Notes</label>
          <textarea class="textarea" id="transactionNotes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addTransactionModal')">Cancel</button>
      <button class="btn btn-primary" onclick="addTransaction()">Save Transaction</button>
    </div>
  </div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDummyAPIKeyForAdityaFertilizers",
  authDomain: "aditya-fertilizers-ledger.firebaseapp.com",
  projectId: "aditya-fertilizers-ledger",
  storageBucket: "aditya-fertilizers-ledger.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:dummyappidforadityafertilizers"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global variables
let accounts = [];
let transactions = [];
let currentAction = null;

// Initialize the application
function initApp() {
  showLoader();
  
  // Set current date as default for date inputs
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('transactionDate').value = today;
  
  // Set date filters to current month
  const firstDay = new Date();
  firstDay.setDate(1);
  document.getElementById('startDateFilter').value = firstDay.toISOString().split('T')[0];
  document.getElementById('endDateFilter').value = today;
  
  // Load data from Firebase
  loadAccounts();
  loadTransactions();
  
  // Set up event listeners
  setupEventListeners();
}

// Set up event listeners
function setupEventListeners() {
  // Navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const section = btn.getAttribute('data-section');
      showSection(section);
    });
  });
  
  // Search functionality
  document.getElementById('accountSearch').addEventListener('input', filterAccounts);
  
  // Close modals when clicking outside
  document.querySelectorAll('.modal-backdrop').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  });
}

// Show section
function showSection(section) {
  // Update active nav button
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('data-section') === section) {
      btn.classList.add('active');
    }
  });
  
  // Show selected section
  document.querySelectorAll('.section').forEach(sec => {
    sec.classList.add('hidden');
  });
  document.getElementById(`${section}-section`).classList.remove('hidden');
}

// Show loader
function showLoader() {
  document.getElementById('loader').style.display = 'flex';
}

// Hide loader
function hideLoader() {
  document.getElementById('loader').style.display = 'none';
}

// Close modal
function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// Show add account modal
function showAddAccountModal() {
  document.getElementById('addAccountModal').classList.remove('hidden');
}

// Show add transaction modal
function showAddTransactionModal() {
  // Load accounts into dropdown
  const accountSelect = document.getElementById('transactionAccount');
  accountSelect.innerHTML = '';
  
  accounts.forEach(account => {
    const option = document.createElement('option');
    option.value = account.id;
    option.textContent = account.companyName;
    accountSelect.appendChild(option);
  });
  
  document.getElementById('addTransactionModal').classList.remove('hidden');
}

// Toggle transaction fields based on type
function toggleTransactionFields() {
  const type = document.getElementById('transactionType').value;
  const paymentAmountGroup = document.getElementById('paymentAmountGroup');
  
  if (type === 'sale' || type === 'purchase') {
    paymentAmountGroup.style.display = 'block';
  } else {
    paymentAmountGroup.style.display = 'none';
  }
}

// Load accounts from Firebase
function loadAccounts() {
  showLoader();
  db.collection('accounts').orderBy('companyName').onSnapshot(snapshot => {
    accounts = [];
    snapshot.forEach(doc => {
      accounts.push({ id: doc.id, ...doc.data() });
    });
    
    renderAccounts();
    updateDashboard();
    hideLoader();
  }, error => {
    console.error('Error loading accounts:', error);
    hideLoader();
  });
}

// Load transactions from Firebase
function loadTransactions() {
  showLoader();
  db.collection('transactions').orderBy('date', 'desc').onSnapshot(snapshot => {
    transactions = [];
    snapshot.forEach(doc => {
      transactions.push({ id: doc.id, ...doc.data() });
    });
    
    renderTransactions();
    renderRecentTransactions();
    updateDashboard();
    hideLoader();
  }, error => {
    console.error('Error loading transactions:', error);
    hideLoader();
  });
}

// Render accounts to the table
function renderAccounts() {
  const accountsList = document.getElementById('accountsList');
  const searchTerm = document.getElementById('accountSearch').value.toLowerCase();
  
  if (accounts.length === 0) {
    accountsList.innerHTML = '<tr><td colspan="5" class="text-center">No accounts found</td></tr>';
    return;
  }
  
  let filteredAccounts = accounts;
  if (searchTerm) {
    filteredAccounts = accounts.filter(account => 
      account.companyName.toLowerCase().includes(searchTerm)
    );
  }
  
  accountsList.innerHTML = '';
  filteredAccounts.forEach(account => {
    const row = document.createElement('tr');
    
    // Calculate balance
    const balance = calculateAccountBalance(account.id);
    
    // Determine status
    let status = 'Inactive';
    let statusClass = 'badge-secondary';
    
    if (balance > 0) {
      status = 'Creditor';
      statusClass = 'badge-success';
    } else if (balance < 0) {
      status = 'Debtor';
      statusClass = 'badge-danger';
    }
    
    row.innerHTML = `
      <td>${account.companyName}</td>
      <td>${account.accountType}</td>
      <td class="text-right">₹${Math.abs(balance).toFixed(2)}</td>
      <td><span class="badge ${statusClass}">${status}</span></td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="viewAccount('${account.id}')">View</button>
        <button class="btn btn-primary btn-sm" onclick="editAccount('${account.id}')">Edit</button>
      </td>
    `;
    
    accountsList.appendChild(row);
  });
}

// Render transactions to the table
function renderTransactions() {
  const transactionsList = document.getElementById('transactionsList');
  
  if (transactions.length === 0) {
    transactionsList.innerHTML = '<tr><td colspan="6" class="text-center">No transactions found</td></tr>';
    return;
  }
  
  // Apply filters
  const typeFilter = document.getElementById('transactionTypeFilter').value;
  const statusFilter = document.getElementById('transactionStatusFilter').value;
  const startDate = document.getElementById('startDateFilter').value;
  const endDate = document.getElementById('endDateFilter').value;
  
  let filteredTransactions = transactions;
  
  if (typeFilter !== 'all') {
    filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
  }
  
  if (statusFilter !== 'all') {
    filteredTransactions = filteredTransactions.filter(t => t.status === statusFilter);
  }
  
  if (startDate) {
    filteredTransactions = filteredTransactions.filter(t => t.date >= startDate);
  }
  
  if (endDate) {
    filteredTransactions = filteredTransactions.filter(t => t.date <= endDate);
  }
  
  transactionsList.innerHTML = '';
  filteredTransactions.forEach(transaction => {
    const account = accounts.find(a => a.id === transaction.accountId);
    const accountName = account ? account.companyName : 'Unknown Account';
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDate(transaction.date)}</td>
      <td><span class="badge ${getTransactionBadgeClass(transaction.type)}">${transaction.type}</span></td>
      <td>${accountName}</td>
      <td class="text-right">₹${transaction.amount.toFixed(2)}</td>
      <td><span class="badge ${getStatusBadgeClass(transaction.status)}">${transaction.status}</span></td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="viewTransaction('${transaction.id}')">View</button>
        <button class="btn btn-primary btn-sm" onclick="editTransaction('${transaction.id}')">Edit</button>
      </td>
    `;
    
    transactionsList.appendChild(row);
  });
}

// Render recent transactions for dashboard
function renderRecentTransactions() {
  const recentTransactions = document.getElementById('recentTransactions');
  const recent = transactions.slice(0, 5);
  
  if (recent.length === 0) {
    recentTransactions.innerHTML = '<p class="text-center">No recent transactions</p>';
    return;
  }
  
  let html = '<div class="table-container"><table class="table"><thead><tr><th>Date</th><th>Type</th><th>Account</th><th>Amount</th></tr></thead><tbody>';
  
  recent.forEach(transaction => {
    const account = accounts.find(a => a.id === transaction.accountId);
    const accountName = account ? account.companyName : 'Unknown Account';
    
    html += `
      <tr>
        <td>${formatDate(transaction.date)}</td>
        <td><span class="badge ${getTransactionBadgeClass(transaction.type)}">${transaction.type}</span></td>
        <td>${accountName}</td>
        <td class="text-right">₹${transaction.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  recentTransactions.innerHTML = html;
}

// Update dashboard with current data
function updateDashboard() {
  // Calculate totals
  const receivables = calculateTotalReceivables();
  const payables = calculateTotalPayables();
  const netPosition = receivables - payables;
  const monthSales = calculateMonthSales();
  
  // Update DOM elements
  document.getElementById('totalReceivables').textContent = `₹${receivables.toFixed(2)}`;
  document.getElementById('totalPayables').textContent = `₹${payables.toFixed(2)}`;
  document.getElementById('netPosition').textContent = `₹${Math.abs(netPosition).toFixed(2)}`;
  document.getElementById('monthSales').textContent = `₹${monthSales.toFixed(2)}`;
  
  // Set net position color
  const netPositionChange = document.getElementById('netPositionChange');
  if (netPosition > 0) {
    netPositionChange.className = 'stat-change positive';
    netPositionChange.innerHTML = '<span>Net positive position</span>';
  } else if (netPosition < 0) {
    netPositionChange.className = 'stat-change negative';
    netPositionChange.innerHTML = '<span>Net negative position</span>';
  } else {
    netPositionChange.className = 'stat-change';
    netPositionChange.innerHTML = '<span>Balanced position</span>';
  }
  
  // Update outstanding payments
  updateOutstandingPayments();
}

// Calculate total receivables
function calculateTotalReceivables() {
  let total = 0;
  
  transactions.forEach(transaction => {
    if (transaction.type === 'sale' && transaction.status !== 'paid') {
      const paidAmount = transaction.paidAmount || 0;
      total += (transaction.amount - paidAmount);
    }
  });
  
  return total;
}

// Calculate total payables
function calculateTotalPayables() {
  let total = 0;
  
  transactions.forEach(transaction => {
    if (transaction.type === 'purchase' && transaction.status !== 'paid') {
      const paidAmount = transaction.paidAmount || 0;
      total += (transaction.amount - paidAmount);
    }
  });
  
  return total;
}

// Calculate sales for current month
function calculateMonthSales() {
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
  
  let total = 0;
  
  transactions.forEach(transaction => {
    if (transaction.type === 'sale' && transaction.date >= firstDay && transaction.date <= lastDay) {
      total += transaction.amount;
    }
  });
  
  return total;
}

// Update outstanding payments section
function updateOutstandingPayments() {
  const outstandingPayments = document.getElementById('outstandingPayments');
  let overdue = [];
  let dueSoon = [];
  
  const today = new Date().toISOString().split('T')[0];
  
  transactions.forEach(transaction => {
    if ((transaction.type === 'sale' || transaction.type === 'purchase') && 
        transaction.status !== 'paid') {
      
      const dueDate = transaction.dueDate || transaction.date;
      const daysDiff = Math.floor((new Date(dueDate) - new Date(today)) / (1000 * 60 * 60 * 24));
      
      const payment = {
        id: transaction.id,
        type: transaction.type,
        accountId: transaction.accountId,
        amount: transaction.amount,
        paidAmount: transaction.paidAmount || 0,
        dueDate: dueDate,
        daysDiff: daysDiff
      };
      
      if (daysDiff < 0) {
        overdue.push(payment);
      } else if (daysDiff <= 7) {
        dueSoon.push(payment);
      }
    }
  });
  
  let html = '';
  
  if (overdue.length === 0 && dueSoon.length === 0) {
    html = '<p class="text-center">No outstanding payments</p>';
  } else {
    if (overdue.length > 0) {
      html += '<h4 class="font-medium mb-2 negative">Overdue Payments</h4>';
      html += '<div class="table-container"><table class="table"><thead><tr><th>Account</th><th>Amount</th><th>Due Date</th><th>Status</th></tr></thead><tbody>';
      
      overdue.forEach(payment => {
        const account = accounts.find(a => a.id === payment.accountId);
        const accountName = account ? account.companyName : 'Unknown Account';
        const amountDue = payment.amount - payment.paidAmount;
        
        html += `
          <tr>
            <td>${accountName}</td>
            <td class="text-right">₹${amountDue.toFixed(2)}</td>
            <td>${formatDate(payment.dueDate)}</td>
            <td><span class="badge badge-danger">Overdue</span></td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
    }
    
    if (dueSoon.length > 0) {
      html += '<h4 class="font-medium mb-2 warning">Due Soon</h4>';
      html += '<div class="table-container"><table class="table"><thead><tr><th>Account</th><th>Amount</th><th>Due Date</th><th>Status</th></tr></thead><tbody>';
      
      dueSoon.forEach(payment => {
        const account = accounts.find(a => a.id === payment.accountId);
        const accountName = account ? account.companyName : 'Unknown Account';
        const amountDue = payment.amount - payment.paidAmount;
        
        html += `
          <tr>
            <td>${accountName}</td>
            <td class="text-right">₹${amountDue.toFixed(2)}</td>
            <td>${formatDate(payment.dueDate)}</td>
            <td><span class="badge badge-warning">Due in ${payment.daysDiff} days</span></td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
    }
  }
  
  outstandingPayments.innerHTML = html;
}

// Calculate account balance
function calculateAccountBalance(accountId) {
  let balance = 0;
  
  transactions.forEach(transaction => {
    if (transaction.accountId === accountId) {
      if (transaction.type === 'sale' || transaction.type === 'receipt') {
        balance += transaction.amount;
      } else if (transaction.type === 'purchase' || transaction.type === 'payment') {
        balance -= transaction.amount;
      }
    }
  });
  
  return balance;
}

// Filter accounts based on search term
function filterAccounts() {
  renderAccounts();
}

// Filter transactions based on selected filters
function filterTransactions() {
  renderTransactions();
}

// Add new account
function addAccount() {
  const companyName = document.getElementById('companyName').value;
  const accountType = document.getElementById('accountType').value;
  const openingBalance = parseFloat(document.getElementById('openingBalance').value) || 0;
  const accountNotes = document.getElementById('accountNotes').value;
  
  if (!companyName) {
    alert('Please enter a company name');
    return;
  }
  
  const accountData = {
    companyName: companyName,
    accountType: accountType,
    openingBalance: openingBalance,
    notes: accountNotes,
    createdAt: new Date().toISOString()
  };
  
  showLoader();
  
  db.collection('accounts').add(accountData)
    .then(() => {
      closeModal('addAccountModal');
      document.getElementById('addAccountForm').reset();
      hideLoader();
    })
    .catch(error => {
      console.error('Error adding account:', error);
      alert('Error adding account. Please try again.');
      hideLoader();
    });
}

// Add new transaction
function addTransaction() {
  const type = document.getElementById('transactionType').value;
  const accountId = document.getElementById('transactionAccount').value;
  const amount = parseFloat(document.getElementById('transactionAmount').value);
  const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
  const date = document.getElementById('transactionDate').value;
  const notes = document.getElementById('transactionNotes').value;
  
  if (!accountId || !amount || !date) {
    alert('Please fill in all required fields');
    return;
  }
  
  if (amount <= 0) {
    alert('Amount must be greater than 0');
    return;
  }
  
  // Determine status based on payment
  let status = 'pending';
  if (paymentAmount >= amount) {
    status = 'paid';
  } else if (paymentAmount > 0) {
    status = 'partial';
  }
  
  const transactionData = {
    type: type,
    accountId: accountId,
    amount: amount,
    paidAmount: paymentAmount,
    date: date,
    notes: notes,
    status: status,
    createdAt: new Date().toISOString()
  };
  
  // Set due date for sales and purchases (30 days from transaction date)
  if (type === 'sale' || type === 'purchase') {
    const dueDate = new Date(date);
    dueDate.setDate(dueDate.getDate() + 30);
    transactionData.dueDate = dueDate.toISOString().split('T')[0];
  }
  
  showLoader();
  
  db.collection('transactions').add(transactionData)
    .then(() => {
      closeModal('addTransactionModal');
      document.getElementById('addTransactionForm').reset();
      hideLoader();
    })
    .catch(error => {
      console.error('Error adding transaction:', error);
      alert('Error adding transaction. Please try again.');
      hideLoader();
    });
}

// View account details
function viewAccount(accountId) {
  // Implementation for viewing account details
  alert('View account details for: ' + accountId);
}

// Edit account
function editAccount(accountId) {
  // Implementation for editing account
  alert('Edit account: ' + accountId);
}

// View transaction details
function viewTransaction(transactionId) {
  // Implementation for viewing transaction details
  alert('View transaction details for: ' + transactionId);
}

// Edit transaction
function editTransaction(transactionId) {
  // Implementation for editing transaction
  alert('Edit transaction: ' + transactionId);
}

// Generate sales report
function generateSalesReport() {
  const reportContainer = document.getElementById('reportContainer');
  const sales = transactions.filter(t => t.type === 'sale');
  
  if (sales.length === 0) {
    reportContainer.innerHTML = '<p class="text-center">No sales data available</p>';
    return;
  }
  
  let totalSales = 0;
  let html = `
    <h3 class="text-center mb-4">Sales Report</h3>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Account</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  sales.forEach(sale => {
    const account = accounts.find(a => a.id === sale.accountId);
    const accountName = account ? account.companyName : 'Unknown Account';
    totalSales += sale.amount;
    
    html += `
      <tr>
        <td>${formatDate(sale.date)}</td>
        <td>${accountName}</td>
        <td class="text-right">₹${sale.amount.toFixed(2)}</td>
        <td><span class="badge ${getStatusBadgeClass(sale.status)}">${sale.status}</span></td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2" class="text-right font-medium">Total Sales:</td>
            <td class="text-right font-medium">₹${totalSales.toFixed(2)}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="text-center mt-4">
      <button class="btn btn-primary" onclick="window.print()">Print Report</button>
    </div>
  `;
  
  reportContainer.innerHTML = html;
}

// Generate purchase report
function generatePurchaseReport() {
  const reportContainer = document.getElementById('reportContainer');
  const purchases = transactions.filter(t => t.type === 'purchase');
  
  if (purchases.length === 0) {
    reportContainer.innerHTML = '<p class="text-center">No purchase data available</p>';
    return;
  }
  
  let totalPurchases = 0;
  let html = `
    <h3 class="text-center mb-4">Purchase Report</h3>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Account</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  purchases.forEach(purchase => {
    const account = accounts.find(a => a.id === purchase.accountId);
    const accountName = account ? account.companyName : 'Unknown Account';
    totalPurchases += purchase.amount;
    
    html += `
      <tr>
        <td>${formatDate(purchase.date)}</td>
        <td>${accountName}</td>
        <td class="text-right">₹${purchase.amount.toFixed(2)}</td>
        <td><span class="badge ${getStatusBadgeClass(purchase.status)}">${purchase.status}</span></td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2" class="text-right font-medium">Total Purchases:</td>
            <td class="text-right font-medium">₹${totalPurchases.toFixed(2)}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="text-center mt-4">
      <button class="btn btn-primary" onclick="window.print()">Print Report</button>
    </div>
  `;
  
  reportContainer.innerHTML = html;
}

// Generate ledger report
function generateLedgerReport() {
  const reportContainer = document.getElementById('reportContainer');
  
  let html = `
    <h3 class="text-center mb-4">General Ledger Report</h3>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Account</th>
            <th>Type</th>
            <th>Balance</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  accounts.forEach(account => {
    const balance = calculateAccountBalance(account.id);
    let status = 'Inactive';
    let statusClass = 'badge-secondary';
    
    if (balance > 0) {
      status = 'Creditor';
      statusClass = 'badge-success';
    } else if (balance < 0) {
      status = 'Debtor';
      statusClass = 'badge-danger';
    }
    
    html += `
      <tr>
        <td>${account.companyName}</td>
        <td>${account.accountType}</td>
        <td class="text-right">₹${Math.abs(balance).toFixed(2)}</td>
        <td><span class="badge ${statusClass}">${status}</span></td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    <div class="text-center mt-4">
      <button class="btn btn-primary" onclick="window.print()">Print Report</button>
    </div>
  `;
  
  reportContainer.innerHTML = html;
}

// Backup data
function backupData() {
  const data = {
    accounts: accounts,
    transactions: transactions,
    backupDate: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `aditya-fertilizers-backup-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  alert('Data backup completed successfully!');
}

// Restore data
function restoreData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);
        
        if (!data.accounts || !data.transactions) {
          throw new Error('Invalid backup file format');
        }
        
        if (confirm('This will replace all current data. Are you sure?')) {
          showLoader();
          
          // First delete all existing data
          const deletePromises = [];
          
          // Delete all transactions
          transactions.forEach(transaction => {
            deletePromises.push(db.collection('transactions').doc(transaction.id).delete());
          });
          
          // Delete all accounts
          accounts.forEach(account => {
            deletePromises.push(db.collection('accounts').doc(account.id).delete());
          });
          
          Promise.all(deletePromises)
            .then(() => {
              // Add restored accounts
              const accountPromises = data.accounts.map(account => {
                const { id, ...accountData } = account;
                return db.collection('accounts').add(accountData);
              });
              
              // Add restored transactions
              const transactionPromises = data.transactions.map(transaction => {
                const { id, ...transactionData } = transaction;
                return db.collection('transactions').add(transactionData);
              });
              
              return Promise.all([...accountPromises, ...transactionPromises]);
            })
            .then(() => {
              alert('Data restored successfully!');
              hideLoader();
            })
            .catch(error => {
              console.error('Error restoring data:', error);
              alert('Error restoring data. Please try again.');
              hideLoader();
            });
        }
      } catch (error) {
        console.error('Error parsing backup file:', error);
        alert('Error parsing backup file. Please make sure you selected a valid backup file.');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

// Show password modal for admin functions
function showPasswordModal(action) {
  currentAction = action;
  document.getElementById('adminPassword').value = '';
  document.getElementById('passwordModal').classList.remove('hidden');
}

// Close password modal
function closePasswordModal() {
  document.getElementById('passwordModal').classList.add('hidden');
  currentAction = null;
}

// Verify password for admin functions
function verifyPassword() {
  const password = document.getElementById('adminPassword').value;
  
  if (password === '1234') {
    closePasswordModal();
    
    switch(currentAction) {
      case 'clearDuplicates':
        clearDuplicates();
        break;
      case 'clearCache':
        clearCache();
        break;
      case 'resetSystem':
        resetSystem();
        break;
    }
  } else {
    alert('Incorrect password. Please try again.');
  }
}

// Clear duplicates (placeholder implementation)
function clearDuplicates() {
  if (confirm('Are you sure you want to clear duplicate entries? This action cannot be undone.')) {
    showLoader();
    // Implementation would go here
    setTimeout(() => {
      alert('Duplicate entries cleared successfully!');
      hideLoader();
    }, 1500);
  }
}

// Clear cache (placeholder implementation)
function clearCache() {
  if (confirm('Are you sure you want to clear the cache? This will not affect your data.')) {
    showLoader();
    // Implementation would go here
    setTimeout(() => {
      alert('Cache cleared successfully!');
      hideLoader();
    }, 1500);
  }
}

// Reset system (placeholder implementation)
function resetSystem() {
  if (confirm('WARNING: This will delete ALL data and reset the system to its initial state. This action cannot be undone. Are you sure?')) {
    showLoader();
    // Implementation would go here
    setTimeout(() => {
      alert('System reset successfully!');
      hideLoader();
    }, 1500);
  }
}

// Helper function to format date
function formatDate(dateString) {
  const options = { year: 'numeric', month: 'short', day: 'numeric' };
  return new Date(dateString).toLocaleDateString(undefined, options);
}

// Helper function to get transaction badge class
function getTransactionBadgeClass(type) {
  switch(type) {
    case 'sale': return 'badge-success';
    case 'purchase': return 'badge-warning';
    case 'payment': return 'badge-secondary';
    case 'receipt': return 'badge-success';
    default: return 'badge-secondary';
  }
}

// Helper function to get status badge class
function getStatusBadgeClass(status) {
  switch(status) {
    case 'paid': return 'badge-success';
    case 'partial': return 'badge-warning';
    case 'pending': return 'badge-danger';
    default: return 'badge-secondary';
  }
}

// Initialize the app when the page loads
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
