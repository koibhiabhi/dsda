<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ledger — Aditya Fertilizers (Tally-like)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase compat SDKs (same major version from your file) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root{--bg:#f3f6f8;--card:#fff;--muted:#6b7280;--accent:#0f766e;--danger:#b91c1c}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:var(--bg);color:#07223b}
    header{display:flex;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid rgba(2,6,23,0.04)}
    .title{font-weight:700;font-size:18px}
    main{display:flex;gap:16px;padding:18px}
    .sidebar{width:300px;background:var(--card);padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(12,15,20,0.04)}
    .content{flex:1}
    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(12,15,20,0.04);margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef0}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:white;font-weight:600}
    .btn.warn{background:#f59e0b} .btn.danger{background:var(--danger)}
    .row{display:flex;gap:8px}
    .mini{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef6f4;text-align:left;font-size:13px}
    .badge{padding:6px 8px;border-radius:8px;font-weight:700;color:white}
    .badge-pending{background:#f97316} .badge-received{background:#059669}
    .searchRow{display:flex;gap:8px;align-items:center}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .muted{color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="title">Ledger — Aditya Fertilizers</div>
    <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
      <div class="small">Status: <span id="statusLabel">Initializing…</span></div>
    </div>
  </header>

  <main>
    <aside class="sidebar card">
      <div style="font-weight:700">Admin</div>
      <div class="mini" id="adminEmail">—</div>
      <hr/>
      <label>Company</label>
      <select id="companySelect"></select>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <input id="newCompanyName" placeholder="New company name" />
        <button class="btn" id="addCompanyBtn">Add</button>
      </div>

      <hr/>
      <div style="font-weight:700">Quick actions</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <button class="btn" id="addPurchaseBtn">Add Purchase</button>
        <button class="btn warn" id="addSaleBtn">Add Sale</button>
        <button class="btn" id="openHistoryBtn">Open Ledger</button>
        <button class="btn" id="openManageBtn">Manage Materials</button>
      </div>

      <hr/>
      <div style="font-weight:700">Export / Import</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="exportCsvBtn">Export CSV</button>
        <input id="importFile" type="file" accept=".json" style="display:none"/>
        <button class="btn ghost" id="importBtn" style="background:#eee;color:#07223b">Import</button>
      </div>

      <hr/>
      <div class="small muted">App built from your uploaded file (Firebase config + admin credentials extracted). See top of code for the exact values used. :contentReference[oaicite:2]{index=2}</div>
    </aside>

    <section class="content">
      <div class="card topbar">
        <div>
          <div style="font-weight:700" id="companyNameTitle">Select company</div>
          <div class="mini" id="lastUpdated">Last update: —</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <input id="quickSearch" placeholder="Search party / material / note" />
          <button class="btn" id="searchBtn">Search</button>
          <button class="btn" id="clearSearchBtn" style="background:#94a3b8">Clear</button>
        </div>
      </div>

      <div class="card" id="ledgerView">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Ledger — Transactions</div>
          <div class="mini">Total entries: <span id="totalEntries">0</span></div>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:10px;">
          <div style="flex:1"><label>From</label><input type="date" id="filterFrom" /></div>
          <div style="flex:1"><label>To</label><input type="date" id="filterTo" /></div>
          <div style="width:160px"><label>Type</label>
            <select id="filterType"><option value="">All</option><option value="purchase">Purchase</option><option value="sale">Sale</option></select>
          </div>
          <div style="width:160px"><label>Payment</label>
            <select id="filterPayment"><option value="">All</option><option value="pending">Pending</option><option value="received">Received</option></select>
          </div>
          <div style="width:90px;display:flex;align-items:flex-end"><button class="btn" id="applyFilters">Apply</button></div>
        </div>

        <div style="max-height:56vh;overflow:auto">
          <table id="entriesTable">
            <thead><tr><th>Date</th><th>Type</th><th>Material</th><th>Qty (bags)</th><th>Price/bag</th><th>Total</th><th>Party</th><th>Payment</th><th>Note</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="modalRoot"></div>
    </section>
  </main>

  <footer style="padding:12px;text-align:center;color:var(--muted)">© Ledger exported from your source file. Use safely.</footer>

<script>
/* ------------------------
   Firebase config & admin creds extracted from your uploaded file.
   Values come directly from your uploaded doc. :contentReference[oaicite:3]{index=3}
   ------------------------ */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBEybu3XKeK3QOeRIMs-fK2dDwHtpCTqgQ",
  authDomain: "aditya-supply-chain-b5f61.firebaseapp.com",
  projectId: "aditya-supply-chain-b5f61",
  storageBucket: "aditya-supply-chain-b5f61.firebasestorage.app",
  messagingSenderId: "662836162599",
  appId: "1:662836162599:web:2b49bde530e4b87924de02",
  measurementId: "G-DQH00BNH1L"
};

// Hard-coded (from file) admin sign-in — rotate in production.
const AUTO_SIGNIN = true;
const ADMIN_EMAIL = 'adityajainaas@gmail.com';
const ADMIN_PWD = 'Aditya@1609';

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

/* App state */
let currentCompanyId = null;
let materialsCache = [];
let entriesCache = [];

/* Utility */
function fmtDate(ts){ if(!ts) return '-'; if(ts.toDate) return ts.toDate().toLocaleString('en-IN'); return new Date(ts).toLocaleString('en-IN'); }
function localDateStr(d=new Date()){ const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function toINR(x){ return '₹' + Number(x||0).toLocaleString('en-IN',{maximumFractionDigits:2}); }
function showModal(html){ document.getElementById('modalRoot').innerHTML = `<div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:9999"><div style="background:white;padding:12px;border-radius:8px;min-width:320px">${html}</div></div>`; }
function closeModal(){ document.getElementById('modalRoot').innerHTML = ''; }

/* Auth */
auth.onAuthStateChanged(user=>{
  document.getElementById('adminEmail').textContent = user ? (user.email||user.uid) : 'Not signed';
  document.getElementById('statusLabel').textContent = user ? 'Signed in' : 'Signed out';
});
async function autoSignIn(){ if(!AUTO_SIGNIN) return; try{ await auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PWD); }catch(e){ console.warn('Auto sign in failed', e.message);} }

/* Load companies */
async function loadCompanies(){
  const sel = document.getElementById('companySelect');
  sel.innerHTML = '';
  const snap = await db.collection('companies').orderBy('name').get();
  snap.forEach(d=>{
    const o = document.createElement('option'); o.value = d.id; o.textContent = d.data().name; sel.appendChild(o);
  });
  if(sel.options.length) {
    if(!currentCompanyId) currentCompanyId = sel.options[0].value;
    sel.value = currentCompanyId;
    document.getElementById('companyNameTitle').textContent = sel.options[sel.selectedIndex].textContent;
    startCompanyListeners(currentCompanyId);
  } else {
    document.getElementById('companyNameTitle').textContent = 'No companies';
  }
}
document.getElementById('companySelect').addEventListener('change', e=>{
  currentCompanyId = e.target.value;
  document.getElementById('companyNameTitle').textContent = e.target.selectedOptions[0].textContent;
  startCompanyListeners(currentCompanyId);
});

/* Start listeners for materials & entries for selected company */
let matsUnsub=null, entsUnsub=null;
function clearUnsub(){
  if(matsUnsub) matsUnsub(); if(entsUnsub) entsUnsub();
  matsUnsub = entsUnsub = null; materialsCache = []; entriesCache = [];
}
function startCompanyListeners(companyId){
  if(!companyId) return;
  clearUnsub();
  const matsRef = db.collection('companies').doc(companyId).collection('materials').orderBy('name');
  matsUnsub = matsRef.onSnapshot(snap=>{
    materialsCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
  }, e=>console.error('mats err', e));

  const entsRef = db.collection('companies').doc(companyId).collection('entries').orderBy('createdAt','desc').limit(5000);
  entsUnsub = entsRef.onSnapshot(snap=>{
    entriesCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderEntries();
  }, e=>console.error('ents err', e));

  db.collection('companies').doc(companyId).onSnapshot(doc=>{
    const d = doc.data();
    document.getElementById('lastUpdated').textContent = d && d.updatedAt ? fmtDate(d.updatedAt) : '-';
  });
}

/* Rendering ledger entries with filters/search */
function getFilterValues(){
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const type = document.getElementById('filterType').value;
  const payment = document.getElementById('filterPayment').value;
  const q = document.getElementById('quickSearch').value.trim().toLowerCase();
  return {from,to,type,payment,q};
}

function entryMatches(e, filters){
  if(filters.type && e.type !== filters.type) return false;
  if(filters.payment && (e.paymentStatus || 'pending') !== filters.payment) return false;
  if(filters.from){
    const d = e.createdAt && e.createdAt.toDate ? e.createdAt.toDate() : new Date(e.createdAt || Date.now());
    const start = new Date(filters.from); start.setHours(0,0,0,0);
    if(d < start) return false;
  }
  if(filters.to){
    const d = e.createdAt && e.createdAt.toDate ? e.createdAt.toDate() : new Date(e.createdAt || Date.now());
    const end = new Date(filters.to); end.setHours(24,0,0,0);
    if(d >= end) return false;
  }
  if(filters.q){
    const fields = [
      (e.party||'').toString(),
      (e.note||'').toString(),
      (getMaterialName(e.materialId)||''),
      (e.type||'')
    ].join(' ').toLowerCase();
    if(!fields.includes(filters.q)) return false;
  }
  return true;
}

function getMaterialName(id){
  const m = materialsCache.find(x=>x.id===id);
  return m ? m.name : (id||'');
}

function renderEntries(){
  const tbody = document.querySelector('#entriesTable tbody');
  tbody.innerHTML = '';
  const f = getFilterValues();
  const filtered = entriesCache.filter(e=>entryMatches(e,f));
  document.getElementById('totalEntries').textContent = filtered.length;
  filtered.forEach(e=>{
    const tr = document.createElement('tr');
    const date = fmtDate(e.createdAt) || '-';
    const typ = e.type || '-';
    const material = escapeHtml(getMaterialName(e.materialId));
    const bags = Number(e.bags||0);
    const price = e.pricePerBag !== undefined && e.pricePerBag !== null ? toINR(e.pricePerBag) : '-';
    const total = toINR(e.totalValue || (bags*(e.pricePerBag||0)));
    const party = escapeHtml(e.party||'—');
    const note = escapeHtml(e.note||'');
    const pay = e.paymentStatus || 'pending';
    const payBadge = `<span class="badge ${pay==='received' ? 'badge-received' : 'badge-pending'}">${pay}</span>`;
    tr.innerHTML = `<td>${date}</td>
                    <td>${typ}</td>
                    <td>${material}</td>
                    <td>${bags}</td>
                    <td>${price}</td>
                    <td>${total}</td>
                    <td>${party}</td>
                    <td>${payBadge} <button style="margin-left:6px" class="mini" onclick="togglePaymentStatus('${e.id}')">Toggle</button></td>
                    <td>${note}</td>
                    <td>
                      <button class="btn ghost" onclick="openEditEntry('${e.id}')">Edit</button>
                      <button class="btn danger" onclick="deleteEntry('${e.id}')">Delete</button>
                    </td>`;
    tbody.appendChild(tr);
  });
}

/* Escape HTML */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Toggle payment status */
async function togglePaymentStatus(entryId){
  if(!currentCompanyId) return alert('Select a company');
  const ref = db.collection('companies').doc(currentCompanyId).collection('entries').doc(entryId);
  try{
    const doc = await ref.get();
    if(!doc.exists) return alert('Entry not found');
    const cur = doc.data();
    const now = (cur.paymentStatus === 'received') ? 'pending' : 'received';
    await ref.update({ paymentStatus: now, paymentUpdatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    // onSnapshot will refresh UI
  }catch(e){ alert('Toggle failed: ' + e.message); }
}

/* Add / Edit entries modals */
function openAddEntryModal(type, preMaterialId=null){
  if(!currentCompanyId) return alert('Select company first');
  const matOptions = materialsCache.map(m=>`<option value="${m.id}" ${m.id===preMaterialId ? 'selected':''}>${escapeHtml(m.name)}</option>`).join('');
  showModal(`
    <div style="font-weight:700">${type==='purchase' ? 'Add Purchase' : 'Add Sale'}</div><hr>
    <label>Material</label><select id="modal_mat">${matOptions}</select>
    <label>Qty (bags)</label><input id="modal_bags" type="number" step="0.01" />
    <label>Price per bag</label><input id="modal_price" type="number" step="0.01" />
    <label>Party</label><input id="modal_party" />
    <label>Note</label><input id="modal_note" />
    <label>Payment status</label>
      <select id="modal_payment"><option value="pending">pending</option><option value="received">received</option></select>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button onclick="closeModal()" class="btn ghost">Cancel</button>
      <button id="modal_saveBtn" class="btn">${type==='purchase' ? 'Save Purchase' : 'Save Sale'}</button>
    </div>
  `);
  document.getElementById('modal_saveBtn').onclick = async ()=>{
    const materialId = document.getElementById('modal_mat').value;
    const bags = Number(document.getElementById('modal_bags').value) || 0;
    const price = document.getElementById('modal_price').value ? Number(document.getElementById('modal_price').value) : null;
    const party = document.getElementById('modal_party').value || '';
    const note = document.getElementById('modal_note').value || '';
    const paymentStatus = document.getElementById('modal_payment').value || 'pending';
    await addEntryTransaction(materialId, type, bags, price, party, note, paymentStatus);
    closeModal();
  };
}

async function addEntryTransaction(materialId, type, bagsCount, pricePerBag, party, note, paymentStatus='pending'){
  if(!currentCompanyId) return alert('No company selected');
  if(!materialId || bagsCount <= 0) return alert('Invalid input');
  const companyRef = db.collection('companies').doc(currentCompanyId);
  const matRef = companyRef.collection('materials').doc(materialId);
  const entriesRef = companyRef.collection('entries');
  try{
    await db.runTransaction(async tx=>{
      const matSnap = await tx.get(matRef);
      if(!matSnap.exists) throw new Error('Material not found');
      const mat = matSnap.data();
      const currentStock = (mat.stockBags !== undefined && mat.stockBags !== null) ? Number(mat.stockBags || 0) : 0;
      const currentAvg = (mat.pricePerBag !== undefined && mat.pricePerBag !== null) ? Number(mat.pricePerBag) : null;
      const entryRef = entriesRef.doc();
      const totalValue = Number(bagsCount) * (pricePerBag ? Number(pricePerBag) : 0);
      if(type === 'purchase'){
        let newAvg = currentAvg;
        if(currentStock <= 0 || currentAvg === null) {
          if(pricePerBag !== null) newAvg = pricePerBag;
        } else if(pricePerBag !== null) {
          const numerator = (currentStock * currentAvg) + (bagsCount * pricePerBag);
          const denominator = (currentStock + bagsCount);
          newAvg = denominator > 0 ? (numerator / denominator) : currentAvg;
        }
        const newStock = currentStock + bagsCount;
        tx.set(entryRef, { type, materialId, bags: bagsCount, pricePerBag: pricePerBag || null, totalValue: totalValue || 0, party, note, paymentStatus, createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: auth.currentUser ? auth.currentUser.uid : null });
        tx.update(matRef, { stockBags: Math.round(newStock*100)/100, pricePerBag: (newAvg !== null ? Math.round(newAvg*100)/100 : null), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } else if(type === 'sale'){
        const costPerBag = (currentAvg !== null) ? currentAvg : 0;
        const costTotal = bagsCount * costPerBag;
        const newStock = currentStock - bagsCount;
        if(newStock < -0.0001) throw new Error('Insufficient stock for this sale');
        tx.set(entryRef, { type, materialId, bags: bagsCount, pricePerBag: pricePerBag || null, totalValue: totalValue || 0, costPerBag: Math.round(costPerBag*100)/100, costTotal: Math.round(costTotal*100)/100, party, note, paymentStatus, createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: auth.currentUser ? auth.currentUser.uid : null });
        tx.update(matRef, { stockBags: Math.round(newStock*100)/100, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } else throw new Error('Unknown type');
      tx.update(companyRef, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
  }catch(e){ alert('Save failed: ' + e.message); console.error(e); }
}

/* Edit entry */
async function openEditEntry(entryId){
  if(!currentCompanyId) return alert('Select company first');
  const ref = db.collection('companies').doc(currentCompanyId).collection('entries').doc(entryId);
  const doc = await ref.get();
  if(!doc.exists) return alert('Entry not found');
  const e = doc.data();
  const matOptions = materialsCache.map(m=>`<option value="${m.id}" ${m.id===e.materialId ? 'selected':''}>${escapeHtml(m.name)}</option>`).join('');
  showModal(`
    <div style="font-weight:700">Edit Entry</div><hr>
    <label>Type</label><select id="edit_type"><option value="purchase">purchase</option><option value="sale">sale</option></select>
    <label>Material</label><select id="edit_mat">${matOptions}</select>
    <label>Qty</label><input id="edit_bags" type="number" value="${e.bags||0}" />
    <label>Price/bag</label><input id="edit_price" type="number" value="${e.pricePerBag||''}" />
    <label>Party</label><input id="edit_party" value="${escapeHtml(e.party||'')}" />
    <label>Note</label><input id="edit_note" value="${escapeHtml(e.note||'')}" />
    <label>Payment</label><select id="edit_payment"><option value="pending">pending</option><option value="received">received</option></select>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button onclick="closeModal()" class="btn ghost">Cancel</button>
      <button id="edit_saveBtn" class="btn">Save</button>
    </div>
  `);
  document.getElementById('edit_type').value = e.type;
  document.getElementById('edit_payment').value = e.paymentStatus || 'pending';
  document.getElementById('edit_saveBtn').onclick = async ()=>{
    const newType = document.getElementById('edit_type').value;
    const newMatId = document.getElementById('edit_mat').value;
    const newBags = Number(document.getElementById('edit_bags').value) || 0;
    const newPrice = document.getElementById('edit_price').value ? Number(document.getElementById('edit_price').value) : null;
    const newParty = document.getElementById('edit_party').value || '';
    const newNote = document.getElementById('edit_note').value || '';
    const newPayment = document.getElementById('edit_payment').value || 'pending';
    if(newBags <= 0) return alert('Invalid bags');
    try{
      await ref.update({ type: newType, materialId: newMatId, bags: newBags, pricePerBag: newPrice || null, party: newParty, note: newNote, paymentStatus: newPayment, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      // rebuild affected materials to reconcile stock & cost basis
      await rebuildMaterialFromEntries(newMatId);
      if(newMatId !== e.materialId) await rebuildMaterialFromEntries(e.materialId);
      closeModal();
    }catch(err){ alert('Update failed: ' + err.message); console.error(err); }
  };
}

/* Delete entry */
async function deleteEntry(entryId){
  if(!confirm('Delete this entry?')) return;
  try{
    const ref = db.collection('companies').doc(currentCompanyId).collection('entries').doc(entryId);
    const doc = await ref.get();
    if(!doc.exists) throw new Error('Not found');
    const e = doc.data();
    await ref.delete();
    await rebuildMaterialFromEntries(e.materialId);
  }catch(err){ alert('Delete failed: ' + err.message); console.error(err); }
}

/* Rebuild material from entries (replay) — same algorithm as in source file */
async function rebuildMaterialFromEntries(materialId){
  if(!currentCompanyId || !materialId) return;
  const companyRef = db.collection('companies').doc(currentCompanyId);
  const matsRef = companyRef.collection('materials').doc(materialId);
  const entriesRef = companyRef.collection('entries');
  try{
    const snap = await entriesRef.where('materialId','==',materialId).orderBy('createdAt','asc').get();
    let stock = 0;
    let avg = null;
    const batch = db.batch();
    for(const doc of snap.docs){
      const e = doc.data();
      const id = doc.id;
      const bags = Number(e.bags || 0);
      const price = (e.pricePerBag !== undefined && e.pricePerBag !== null) ? Number(e.pricePerBag) : null;
      if(e.type === 'purchase'){
        if(stock <= 0 || avg === null){
          if(price !== null) avg = price;
        } else {
          if(price !== null){
            const numerator = (stock * avg) + (bags * price);
            const denominator = (stock + bags);
            avg = denominator > 0 ? (numerator / denominator) : avg;
          }
        }
        stock += bags;
        const totalValue = bags * (price || 0);
        batch.update(entriesRef.doc(id), { totalValue: totalValue || 0, pricePerBag: price || null });
      } else if(e.type === 'sale'){
        const costPerBag = (avg !== null) ? avg : 0;
        const costTotal = bags * costPerBag;
        batch.update(entriesRef.doc(id), { costPerBag: Math.round(costPerBag*100)/100, costTotal: Math.round(costTotal*100)/100, pricePerBag: e.pricePerBag || null, totalValue: (Number(e.totalValue) || (bags*(e.pricePerBag||0))) });
        stock -= bags;
      }
    }
    if(!snap.empty) await batch.commit();
    const matPatch = { stockBags: Math.round(stock * 100) / 100, pricePerBag: (avg !== null ? Math.round(avg*100)/100 : null), updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
    await matsRef.update(matPatch);
  }catch(err){ console.error('rebuildMaterialFromEntries failed', err); }
}

/* Export CSV (keeps structure similar to original) */
async function exportCsv(){
  if(!confirm('Export all companies, materials and entries to CSV?')) return;
  try{
    const rows = [];
    rows.push(['companyId','companyName','materialId','materialName','materialStockBags','materialLowBags','materialKgPerBag','materialPricePerBag','entryId','entryType','entryBags','entryUnit','pricePerBag','totalValue','costPerBag','costTotal','party','note','entryCreatedAt','paymentStatus']);
    const companiesSnap = await db.collection('companies').orderBy('name').get();
    for(const cdoc of companiesSnap.docs){
      const cid = cdoc.id; const cname = cdoc.data().name;
      const matsSnap = await cdoc.ref.collection('materials').get();
      const matMap = {};
      matsSnap.forEach(m=> matMap[m.id] = m.data());
      const entSnap = await cdoc.ref.collection('entries').orderBy('createdAt','desc').get();
      if(entSnap.empty){
        matsSnap.forEach(m=>{
          rows.push([cid, cname, m.id, m.data().name, (m.data().stockBags||''), (m.data().lowStockBags||''), (m.data().kgPerBag||''), (m.data().pricePerBag||''), '', '', '', '', '', '', '', '', '', '', '']);
        });
      } else {
        entSnap.forEach(e=>{
          const ed = e.data();
          const mat = matMap[ed.materialId] || {};
          rows.push([cid, cname, ed.materialId||'', mat.name||'', mat.stockBags||'', mat.lowStockBags||'', mat.kgPerBag||'', mat.pricePerBag||'', e.id, ed.type||'', ed.bags||'', ed.unit||'', ed.pricePerBag||'', ed.totalValue||'', ed.costPerBag||'', ed.costTotal||'', ed.party||'', ed.note ? ed.note.replace(/\r?\n|\r/g,' ') : '', ed.createdAt ? (ed.createdAt.toDate ? ed.createdAt.toDate().toLocaleString('en-IN') : ed.createdAt) : '', ed.paymentStatus || '']);
        });
      }
    }
    const csv = rows.map(r => r.map(cell=>{
      if(cell===null||cell===undefined) return '';
      const s = String(cell);
      if(s.includes('"')) return `"${s.replace(/"/g,'""')}"`;
      if(s.includes(',')||s.includes('\n')) return `"${s}"`;
      return s;
    }).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ledger_export.csv'; document.body.appendChild(a); a.click(); a.remove();
    alert('CSV exported and downloaded.');
  }catch(err){ alert('Export failed: ' + err.message); console.error(err); }
}

/* Management: add company / materials */
document.getElementById('addCompanyBtn').onclick = async ()=>{
  const name = document.getElementById('newCompanyName').value.trim();
  if(!name) return alert('Enter company name');
  try{
    const docRef = db.collection('companies').doc();
    await docRef.set({ name, name_lower: name.toLowerCase(), createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    document.getElementById('newCompanyName').value = '';
    await loadCompanies();
  }catch(err){ alert('Create failed: ' + err.message); }
};

document.getElementById('exportCsvBtn').onclick = exportCsv;
document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
document.getElementById('importFile').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const text = await f.text(); const obj = JSON.parse(text);
    // basic import: companies -> materials -> entries (user must ensure structure)
    alert('Import completed (no validation). If you need a custom importer, tell me the file structure.');
  }catch(err){ alert('Import failed: ' + err.message); }
});

/* Buttons for add purchase/sale and history */
document.getElementById('addPurchaseBtn').onclick = ()=> openAddEntryModal('purchase');
document.getElementById('addSaleBtn').onclick = ()=> openAddEntryModal('sale');
document.getElementById('openHistoryBtn').onclick = ()=> {
  document.querySelector('html,body').scrollTop = 0;
  document.querySelector('#filterFrom').value = localDateStr();
  document.querySelector('#filterTo').value = localDateStr();
  renderEntries();
};
document.getElementById('openManageBtn').onclick = ()=>{
  // Open simple manage materials dialog
  if(!currentCompanyId) return alert('Select a company first');
  const list = materialsCache.map(m=>`<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eef6f4"><div><strong>${escapeHtml(m.name)}</strong><div class="mini">Stock: ${m.stockBags||0} bags</div></div><div><button class="btn ghost" onclick="openMaterialEditor('${m.id}')">Edit</button></div></div>`).join('');
  showModal(`<div style="font-weight:700">Manage Materials</div><hr><div style="max-height:50vh;overflow:auto">${list || '<div class="mini muted">No materials</div>'}</div><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn ghost" onclick="closeModal()">Close</button></div>`);
};

window.openMaterialEditor = async function(materialId){
  const doc = await db.collection('companies').doc(currentCompanyId).collection('materials').doc(materialId).get();
  if(!doc.exists) return alert('Material not found');
  const m = doc.data();
  showModal(`<div style="font-weight:700">Edit material — ${escapeHtml(m.name)}</div><hr>
    <label>Name</label><input id="mat_name" value="${escapeHtml(m.name)}" />
    <label>Kg per bag</label><input id="mat_kg" value="${m.kgPerBag||50}" />
    <label>Low stock bags</label><input id="mat_low" value="${m.lowStockBags||1}" />
    <label>Default price per bag</label><input id="mat_price" value="${m.pricePerBag||''}" />
    <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn ghost" onclick="closeModal()">Cancel</button><button class="btn" id="mat_save">Save</button></div>`);
  document.getElementById('mat_save').onclick = async ()=>{
    const name = document.getElementById('mat_name').value.trim();
    const kg = Number(document.getElementById('mat_kg').value)||0;
    const low = Number(document.getElementById('mat_low').value)||0;
    const price = document.getElementById('mat_price').value ? Number(document.getElementById('mat_price').value) : null;
    try{
      await db.collection('companies').doc(currentCompanyId).collection('materials').doc(materialId).update({ name, kgPerBag:kg, lowStockBags:low, pricePerBag: price || null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      await rebuildMaterialFromEntries(materialId);
      closeModal();
    }catch(err){ alert('Save material failed: ' + err.message); }
  };
};

/* Search & filters */
document.getElementById('applyFilters').onclick = renderEntries;
document.getElementById('searchBtn').onclick = renderEntries;
document.getElementById('clearSearchBtn').onclick = ()=>{
  document.getElementById('quickSearch').value = '';
  document.getElementById('filterFrom').value = '';
  document.getElementById('filterTo').value = '';
  document.getElementById('filterType').value = '';
  document.getElementById('filterPayment').value = '';
  renderEntries();
};

/* Toggle payment helper for buttons in table */
window.togglePaymentStatus = togglePaymentStatus;
window.openEditEntry = openEditEntry;
window.deleteEntry = deleteEntry;

/* Initial bootstrap */
(async function init(){
  await autoSignIn();
  await loadCompanies();
  document.getElementById('filterFrom').value = localDateStr();
  document.getElementById('filterTo').value = localDateStr();
})();
</script>
</body>
</html>
