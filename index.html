<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Aditya Fertilizers - Professional Accounting Ledger</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
:root {
  --primary: #0f766e;
  --primary-dark: #065f57;
  --secondary: #047857;
  --danger: #dc2626;
  --warning: #d97706;
  --success: #059669;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --text: #1e293b;
  --text-muted: #64748b;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

.header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: space-between;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--primary);
  margin-bottom: 1rem;
}

.nav-links {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
  width: 100%;
  justify-content: center;
}

.nav-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  font-size: 0.875rem;
}

.nav-btn:hover {
  background: var(--primary);
  color: white;
}

.nav-btn.active {
  background: var(--primary);
  color: white;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1rem;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: var(--card);
  padding: 1.25rem;
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.stat-title {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.stat-change {
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.positive { color: var(--success); }
.negative { color: var(--danger); }
.warning { color: var(--warning); }

.card {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 1.5rem;
}

.card-header {
  padding: 1.25rem 1.25rem 0;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  justify-content: space-between;
  align-items: flex-start;
}

.card-title {
  font-size: 1.125rem;
  font-weight: 600;
}

.card-content {
  padding: 1.25rem;
}

.table-container {
  overflow-x: auto;
  width: 100%;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
  min-width: 600px;
}

.table th,
.table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.table th {
  background: #f8fafc;
  font-weight: 600;
  color: var(--text-muted);
}

.table tr:hover {
  background: #f8fafc;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.875rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--border);
  color: var(--text);
}

.btn-secondary:hover {
  background: #cbd5e1;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
}

.form-group {
  margin-bottom: 1rem;
}

.label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.input,
.select,
.textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  font-size: 0.875rem;
  transition: border-color 0.2s;
}

.input:focus,
.select:focus,
.textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 1rem;
}

.modal {
  background: var(--card);
  border-radius: 0.75rem;
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 1.25rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
}

.modal-content {
  padding: 1.25rem;
}

.modal-footer {
  padding: 1.25rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  display: inline-block;
}

.badge-success { background: #dcfce7; color: var(--success); }
.badge-danger { background: #fecaca; color: var(--danger); }
.badge-warning { background: #fef3c7; color: var(--warning); }
.badge-secondary { background: #f1f5f9; color: var(--text-muted); }

.search-bar {
  position: relative;
  margin-bottom: 1rem;
}

.search-input {
  padding-left: 2.5rem;
}

.search-icon {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.filters {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.loader {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.text-right { text-align: right; }
.text-center { text-align: center; }
.font-medium { font-weight: 500; }
.text-sm { font-size: 0.875rem; }
.text-xs { font-size: 0.75rem; }

.grid {
  display: grid;
  gap: 1rem;
}

.grid-cols-1 {
  grid-template-columns: 1fr;
}

.grid-cols-2 {
  grid-template-columns: repeat(2, 1fr);
}

.grid-cols-3 {
  grid-template-columns: repeat(3, 1fr);
}

.hidden {
  display: none !important;
}

.flex {
  display: flex;
}

.flex-col {
  flex-direction: column;
}

.items-center {
  align-items: center;
}

.justify-between {
  justify-content: space-between;
}

.mb-4 {
  margin-bottom: 1rem;
}

/* Mobile Responsive Styles */
@media (min-width: 768px) {
  .header {
    flex-direction: row;
    align-items: center;
    padding: 1rem 2rem;
  }
  
  .logo {
    margin-bottom: 0;
  }
  
  .nav-links {
    justify-content: flex-end;
    width: auto;
  }
  
  .card-header {
    flex-direction: row;
    align-items: center;
  }
  
  .container {
    padding: 2rem;
  }
  
  .dashboard-grid {
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .stat-card {
    padding: 1.5rem;
  }
  
  .stat-value {
    font-size: 2rem;
  }
  
  .card-header {
    padding: 1.5rem 1.5rem 0;
  }
  
  .card-content {
    padding: 1.5rem;
  }
  
  .modal-header {
    padding: 1.5rem;
  }
  
  .modal-content {
    padding: 1.5rem;
  }
  
  .modal-footer {
    padding: 1.5rem;
  }
  
  .filters {
    margin-bottom: 1.5rem;
  }
  
  .search-bar {
    margin-bottom: 1.5rem;
  }
}

@media (max-width: 1024px) {
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }
  
  .grid-cols-3 {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 640px) {
  .grid-cols-3 {
    grid-template-columns: 1fr;
  }
  
  .filters {
    flex-direction: column;
  }
  
  .filters .select,
  .filters .input {
    width: 100%;
  }
  
  .actions {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .table {
    font-size: 0.75rem;
  }
  
  .table th,
  .table td {
    padding: 0.5rem;
  }
}

/* Print styles for reports */
@media print {
  .header,
  .nav-links,
  .btn,
  .actions {
    display: none !important;
  }
  
  .container {
    padding: 0;
    max-width: 100%;
  }
  
  .card {
    box-shadow: none;
    border: none;
    margin-bottom: 1rem;
  }
}
</style>
</head>
<body>
<div class="loader" id="loader">
  <div class="spinner"></div>
</div>

<header class="header">
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
    </svg>
    Aditya Fertilizers - Accounting Ledger
  </div>
  <nav class="nav-links">
    <button class="nav-btn active" data-section="dashboard">Dashboard</button>
    <button class="nav-btn" data-section="accounts">Accounts</button>
    <button class="nav-btn" data-section="transactions">Transactions</button>
    <button class="nav-btn" data-section="reports">Reports</button>
    <button class="nav-btn" data-section="settings">Settings</button>
  </nav>
</header>

<main class="container">
  <!-- Dashboard Section -->
  <div id="dashboard-section" class="section">
    <div class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-title">Total Receivables</div>
        <div class="stat-value" id="totalReceivables">₹0</div>
        <div class="stat-change positive">
          <span>Outstanding from customers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Payables</div>
        <div class="stat-value" id="totalPayables">₹0</div>
        <div class="stat-change negative">
          <span>Outstanding to suppliers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Overall Balance</div>
        <div class="stat-value" id="netPosition">₹0</div>
        <div class="stat-change" id="netPositionChange">
          <span>Overall financial position</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-title">This Month Sales</div>
        <div class="stat-value" id="monthSales">₹0</div>
        <div class="stat-change positive">
          <span>Current month revenue</span>
        </div>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Recent Transactions</h3>
          <button class="btn btn-primary btn-sm" onclick="showAddTransactionModal()">Add Transaction</button>
        </div>
        <div class="card-content">
          <div id="recentTransactions">Loading...</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Outstanding Payments</h3>
        </div>
        <div class="card-content">
          <div id="outstandingPayments">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts Section -->
  <div id="accounts-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Company Accounts</h3>
        <button class="btn btn-primary" onclick="showAddAccountModal()">Add Account</button>
      </div>
      <div class="card-content">
        <div class="search-bar">
          <input type="text" class="input search-input" placeholder="Search accounts..." id="accountSearch">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Account Name</th>
                <th>Type</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="accountsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions Section -->
  <div id="transactions-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">All Transactions</h3>
        <button class="btn btn-primary" onclick="showAddTransactionModal()">Add Transaction</button>
      </div>
      <div class="card-content">
        <div class="filters">
          <select class="select" id="transactionTypeFilter">
            <option value="all">All Types</option>
            <option value="sale">Sales</option>
            <option value="purchase">Purchases</option>
            <option value="payment">Payments</option>
            <option value="receipt">Receipts</option>
          </select>
          <input type="date" class="input" id="startDateFilter">
          <input type="date" class="input" id="endDateFilter">
          <button class="btn btn-secondary" onclick="filterTransactions()">Apply Filters</button>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Account</th>
                <th>Type</th>
                <th>Description</th>
                <th>Debit</th>
                <th>Credit</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Section -->
  <div id="reports-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Financial Reports</h3>
        <div class="actions">
          <button class="btn btn-secondary" onclick="generateProfitLossReport()">Profit & Loss</button>
          <button class="btn btn-secondary" onclick="generateBalanceSheet()">Balance Sheet</button>
          <button class="btn btn-secondary" onclick="generateLedgerReport()">General Ledger</button>
        </div>
      </div>
      <div class="card-content">
        <div id="reportContainer"></div>
      </div>
    </div>
  </div>

  <!-- Settings Section -->
  <div id="settings-section" class="section hidden">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">System Settings</h3>
      </div>
      <div class="card-content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h4 class="font-medium mb-4">Company Information</h4>
            <div class="form-group">
              <label class="label">Company Name</label>
              <input type="text" class="input" id="companyName" value="Aditya Fertilizers">
            </div>
            <div class="form-group">
              <label class="label">Address</label>
              <textarea class="textarea" id="companyAddress">123 Main Street, City, State, PIN</textarea>
            </div>
            <div class="form-group">
              <label class="label">GSTIN</label>
              <input type="text" class="input" id="companyGST" value="GSTIN123456789">
            </div>
            <button class="btn btn-primary" onclick="saveCompanyInfo()">Save Company Info</button>
          </div>
          <div>
            <h4 class="font-medium mb-4">System Maintenance</h4>
            <p class="text-sm text-muted mb-4">These actions require administrator privileges.</p>
            <div class="form-group">
              <label class="label">Admin Password</label>
              <input type="password" class="input" id="adminPassword" placeholder="Enter password to enable admin functions">
            </div>
            <div class="actions">
              <button class="btn btn-warning" onclick="clearDuplicates()" id="clearDuplicatesBtn" disabled>Clear Duplicates</button>
              <button class="btn btn-warning" onclick="clearCache()" id="clearCacheBtn" disabled>Clear Cache</button>
              <button class="btn btn-danger" onclick="resetSystem()" id="resetSystemBtn" disabled>Reset System</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Add Account Modal -->
<div class="modal-backdrop hidden" id="addAccountModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Add New Account</h3>
      <button class="btn btn-secondary btn-sm" onclick="closeModal('addAccountModal')">Close</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="label">Account Name</label>
        <input type="text" class="input" id="accountName">
      </div>
      <div class="form-group">
        <label class="label">Account Type</label>
        <select class="select" id="accountType">
          <option value="customer">Customer</option>
          <option value="supplier">Supplier</option>
          <option value="bank">Bank Account</option>
          <option value="cash">Cash Account</option>
          <option value="income">Income Account</option>
          <option value="expense">Expense Account</option>
          <option value="asset">Asset Account</option>
          <option value="liability">Liability Account</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Opening Balance</label>
        <input type="number" class="input" id="accountBalance" value="0">
      </div>
      <div class="form-group">
        <label class="label">Contact Information</label>
        <textarea class="textarea" id="accountContact"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addAccountModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAccount()">Save Account</button>
    </div>
  </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal-backdrop hidden" id="addTransactionModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Add New Transaction</h3>
      <button class="btn btn-secondary btn-sm" onclick="closeModal('addTransactionModal')">Close</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="label">Transaction Type</label>
        <select class="select" id="transactionType" onchange="toggleTransactionFields()">
          <option value="sale">Sale</option>
          <option value="purchase">Purchase</option>
          <option value="payment">Payment</option>
          <option value="receipt">Receipt</option>
          <option value="journal">Journal Entry</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Date</label>
        <input type="date" class="input" id="transactionDate">
      </div>
      <div class="form-group" id="fromAccountGroup">
        <label class="label" id="fromAccountLabel">From Account</label>
        <select class="select" id="fromAccount"></select>
      </div>
      <div class="form-group" id="toAccountGroup">
        <label class="label" id="toAccountLabel">To Account</label>
        <select class="select" id="toAccount"></select>
      </div>
      <div class="form-group">
        <label class="label">Amount (₹)</label>
        <input type="number" class="input" id="transactionAmount" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="label">Description</label>
        <textarea class="textarea" id="transactionDescription"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addTransactionModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTransaction()">Save Transaction</button>
    </div>
  </div>
</div>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDummyAPIKeyForDemoPurposesOnly",
  authDomain: "aditya-fertilizers-ledger.firebaseapp.com",
  projectId: "aditya-fertilizers-ledger",
  storageBucket: "aditya-fertilizers-ledger.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:dummyappidforfertilizersledger"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global variables
let accounts = [];
let transactions = [];
let companyInfo = {};

// Initialize the application
async function initApp() {
  showLoader();
  try {
    await loadCompanyInfo();
    await loadAccounts();
    await loadTransactions();
    updateDashboard();
    hideLoader();
  } catch (error) {
    console.error("Error initializing app:", error);
    hideLoader();
    alert("Failed to load application data. Please refresh the page.");
  }
}

// Load company information
async function loadCompanyInfo() {
  try {
    const doc = await db.collection('settings').doc('companyInfo').get();
    if (doc.exists) {
      companyInfo = doc.data();
      document.getElementById('companyName').value = companyInfo.name || 'Aditya Fertilizers';
      document.getElementById('companyAddress').value = companyInfo.address || '123 Main Street, City, State, PIN';
      document.getElementById('companyGST').value = companyInfo.gst || 'GSTIN123456789';
    }
  } catch (error) {
    console.error("Error loading company info:", error);
  }
}

// Save company information
async function saveCompanyInfo() {
  try {
    companyInfo = {
      name: document.getElementById('companyName').value,
      address: document.getElementById('companyAddress').value,
      gst: document.getElementById('companyGST').value,
      updatedAt: new Date()
    };
    
    await db.collection('settings').doc('companyInfo').set(companyInfo);
    alert('Company information saved successfully!');
  } catch (error) {
    console.error("Error saving company info:", error);
    alert('Failed to save company information.');
  }
}

// Load accounts from Firestore
async function loadAccounts() {
  try {
    const snapshot = await db.collection('accounts').orderBy('name').get();
    accounts = [];
    snapshot.forEach(doc => {
      accounts.push({ id: doc.id, ...doc.data() });
    });
    populateAccountDropdowns();
    renderAccountsTable();
  } catch (error) {
    console.error("Error loading accounts:", error);
  }
}

// Load transactions from Firestore
async function loadTransactions() {
  try {
    const snapshot = await db.collection('transactions').orderBy('date', 'desc').get();
    transactions = [];
    snapshot.forEach(doc => {
      transactions.push({ id: doc.id, ...doc.data() });
    });
    renderTransactionsTable();
    updateRecentTransactions();
    updateOutstandingPayments();
  } catch (error) {
    console.error("Error loading transactions:", error);
  }
}

// Populate account dropdowns in transaction form
function populateAccountDropdowns() {
  const fromAccount = document.getElementById('fromAccount');
  const toAccount = document.getElementById('toAccount');
  
  fromAccount.innerHTML = '';
  toAccount.innerHTML = '';
  
  accounts.forEach(account => {
    const option1 = document.createElement('option');
    option1.value = account.id;
    option1.textContent = account.name;
    fromAccount.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = account.id;
    option2.textContent = account.name;
    toAccount.appendChild(option2);
  });
}

// Toggle transaction fields based on type
function toggleTransactionFields() {
  const type = document.getElementById('transactionType').value;
  const fromAccountGroup = document.getElementById('fromAccountGroup');
  const toAccountGroup = document.getElementById('toAccountGroup');
  const fromAccountLabel = document.getElementById('fromAccountLabel');
  const toAccountLabel = document.getElementById('toAccountLabel');
  
  switch(type) {
    case 'sale':
      fromAccountLabel.textContent = 'Customer';
      toAccountLabel.textContent = 'Income Account';
      fromAccountGroup.style.display = 'block';
      toAccountGroup.style.display = 'block';
      break;
    case 'purchase':
      fromAccountLabel.textContent = 'Expense Account';
      toAccountLabel.textContent = 'Supplier';
      fromAccountGroup.style.display = 'block';
      toAccountGroup.style.display = 'block';
      break;
    case 'payment':
      fromAccountLabel.textContent = 'From Account';
      toAccountLabel.textContent = 'To Supplier';
      fromAccountGroup.style.display = 'block';
      toAccountGroup.style.display = 'block';
      break;
    case 'receipt':
      fromAccountLabel.textContent = 'From Customer';
      toAccountLabel.textContent = 'To Account';
      fromAccountGroup.style.display = 'block';
      toAccountGroup.style.display = 'block';
      break;
    case 'journal':
      fromAccountLabel.textContent = 'From Account';
      toAccountLabel.textContent = 'To Account';
      fromAccountGroup.style.display = 'block';
      toAccountGroup.style.display = 'block';
      break;
    default:
      fromAccountGroup.style.display = 'block';
      toAccountGroup.style.display = 'block';
  }
}

// Save account to Firestore
async function saveAccount() {
  const name = document.getElementById('accountName').value;
  const type = document.getElementById('accountType').value;
  const balance = parseFloat(document.getElementById('accountBalance').value) || 0;
  const contact = document.getElementById('accountContact').value;
  
  if (!name) {
    alert('Please enter an account name');
    return;
  }
  
  try {
    const accountData = {
      name,
      type,
      balance,
      contact,
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    await db.collection('accounts').add(accountData);
    closeModal('addAccountModal');
    await loadAccounts();
    alert('Account added successfully!');
  } catch (error) {
    console.error("Error adding account:", error);
    alert('Failed to add account.');
  }
}

// Save transaction to Firestore
async function saveTransaction() {
  const type = document.getElementById('transactionType').value;
  const date = document.getElementById('transactionDate').value;
  const fromAccountId = document.getElementById('fromAccount').value;
  const toAccountId = document.getElementById('toAccount').value;
  const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
  const description = document.getElementById('transactionDescription').value;
  
  if (!date || !fromAccountId || !toAccountId || amount <= 0) {
    alert('Please fill all required fields with valid values');
    return;
  }
  
  try {
    const transactionData = {
      type,
      date: new Date(date),
      fromAccountId,
      toAccountId,
      amount,
      description,
      createdAt: new Date(),
      updatedAt: new Date()
    };
    
    await db.collection('transactions').add(transactionData);
    closeModal('addTransactionModal');
    await loadTransactions();
    await loadAccounts();
    updateDashboard();
    alert('Transaction added successfully!');
  } catch (error) {
    console.error("Error adding transaction:", error);
    alert('Failed to add transaction.');
  }
}

// Update dashboard with current data
function updateDashboard() {
  // Calculate total receivables (from customers with positive balances)
  const totalReceivables = accounts
    .filter(acc => acc.type === 'customer' && acc.balance > 0)
    .reduce((sum, acc) => sum + acc.balance, 0);
  
  // Calculate total payables (to suppliers with negative balances)
  const totalPayables = accounts
    .filter(acc => acc.type === 'supplier' && acc.balance < 0)
    .reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
  
  // Calculate net position (assets - liabilities)
  const assets = accounts
    .filter(acc => ['bank', 'cash', 'asset'].includes(acc.type) && acc.balance > 0)
    .reduce((sum, acc) => sum + acc.balance, 0);
  
  const liabilities = accounts
    .filter(acc => ['liability'].includes(acc.type) && acc.balance < 0)
    .reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
  
  const netPosition = assets - liabilities;
  
  // Calculate this month's sales
  const now = new Date();
  const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthSales = transactions
    .filter(t => t.type === 'sale' && new Date(t.date) >= firstDayOfMonth)
    .reduce((sum, t) => sum + t.amount, 0);
  
  // Update dashboard elements
  document.getElementById('totalReceivables').textContent = `₹${totalReceivables.toLocaleString()}`;
  document.getElementById('totalPayables').textContent = `₹${totalPayables.toLocaleString()}`;
  document.getElementById('netPosition').textContent = `₹${netPosition.toLocaleString()}`;
  document.getElementById('monthSales').textContent = `₹${monthSales.toLocaleString()}`;
  
  // Set appropriate color for net position
  const netPositionChange = document.getElementById('netPositionChange');
  netPositionChange.className = netPosition >= 0 ? 'stat-change positive' : 'stat-change negative';
}

// Render accounts table
function renderAccountsTable() {
  const tableBody = document.getElementById('accountsTableBody');
  tableBody.innerHTML = '';
  
  accounts.forEach(account => {
    const row = document.createElement('tr');
    
    // Format balance with appropriate color
    let balanceClass = '';
    let formattedBalance = account.balance.toLocaleString('en-IN', {
      style: 'currency',
      currency: 'INR'
    });
    
    if (account.balance > 0) {
      balanceClass = 'positive';
    } else if (account.balance < 0) {
      balanceClass = 'negative';
      formattedBalance = `(${Math.abs(account.balance).toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR'
      })})`;
    }
    
    // Determine status badge
    let statusBadge = '';
    if (account.balance > 0 && account.type === 'customer') {
      statusBadge = '<span class="badge badge-success">Receivable</span>';
    } else if (account.balance < 0 && account.type === 'supplier') {
      statusBadge = '<span class="badge badge-danger">Payable</span>';
    } else if (account.balance === 0) {
      statusBadge = '<span class="badge badge-secondary">Settled</span>';
    } else {
      statusBadge = '<span class="badge badge-warning">Active</span>';
    }
    
    row.innerHTML = `
      <td>${account.name}</td>
      <td>${account.type}</td>
      <td class="${balanceClass}">${formattedBalance}</td>
      <td>${statusBadge}</td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="viewAccount('${account.id}')">View</button>
        <button class="btn btn-primary btn-sm" onclick="editAccount('${account.id}')">Edit</button>
      </td>
    `;
    
    tableBody.appendChild(row);
  });
}

// Render transactions table
function renderTransactionsTable() {
  const tableBody = document.getElementById('transactionsTableBody');
  tableBody.innerHTML = '';
  
  // Get filter values
  const typeFilter = document.getElementById('transactionTypeFilter').value;
  const startDate = document.getElementById('startDateFilter').value;
  const endDate = document.getElementById('endDateFilter').value;
  
  // Filter transactions
  let filteredTransactions = transactions;
  
  if (typeFilter !== 'all') {
    filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
  }
  
  if (startDate) {
    const startDateObj = new Date(startDate);
    filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= startDateObj);
  }
  
  if (endDate) {
    const endDateObj = new Date(endDate);
    endDateObj.setHours(23, 59, 59, 999); // End of the day
    filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= endDateObj);
  }
  
  // Render transactions
  filteredTransactions.forEach(transaction => {
    const fromAccount = accounts.find(acc => acc.id === transaction.fromAccountId);
    const toAccount = accounts.find(acc => acc.id === transaction.toAccountId);
    
    const row = document.createElement('tr');
    const date = new Date(transaction.date).toLocaleDateString();
    
    let debit = '';
    let credit = '';
    
    if (transaction.type === 'sale') {
      debit = transaction.amount.toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR'
      });
    } else if (transaction.type === 'purchase') {
      credit = transaction.amount.toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR'
      });
    } else if (transaction.type === 'payment') {
      credit = transaction.amount.toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR'
      });
    } else if (transaction.type === 'receipt') {
      debit = transaction.amount.toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR'
      });
    } else if (transaction.type === 'journal') {
      // For journal entries, we need to determine which account is debited/credited
      // This is a simplified approach - in a real system, you'd have proper double-entry bookkeeping
      debit = transaction.amount.toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR'
      });
    }
    
    row.innerHTML = `
      <td>${date}</td>
      <td>${fromAccount ? fromAccount.name : 'N/A'} → ${toAccount ? toAccount.name : 'N/A'}</td>
      <td><span class="badge badge-secondary">${transaction.type}</span></td>
      <td>${transaction.description || 'No description'}</td>
      <td class="text-right">${debit}</td>
      <td class="text-right">${credit}</td>
      <td class="text-right">
        ${fromAccount ? fromAccount.balance.toLocaleString('en-IN', {
          style: 'currency',
          currency: 'INR'
        }) : 'N/A'}
      </td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="viewTransaction('${transaction.id}')">View</button>
        <button class="btn btn-primary btn-sm" onclick="editTransaction('${transaction.id}')">Edit</button>
      </td>
    `;
    
    tableBody.appendChild(row);
  });
}

// Update recent transactions on dashboard
function updateRecentTransactions() {
  const container = document.getElementById('recentTransactions');
  const recent = transactions.slice(0, 5);
  
  if (recent.length === 0) {
    container.innerHTML = '<p class="text-center text-muted">No transactions yet</p>';
    return;
  }
  
  let html = '<div class="grid grid-cols-1 gap-2">';
  
  recent.forEach(transaction => {
    const fromAccount = accounts.find(acc => acc.id === transaction.fromAccountId);
    const toAccount = accounts.find(acc => acc.id === transaction.toAccountId);
    const date = new Date(transaction.date).toLocaleDateString();
    
    html += `
      <div class="flex justify-between items-center p-2 border-b border-gray-100">
        <div>
          <div class="font-medium">${fromAccount ? fromAccount.name : 'N/A'} → ${toAccount ? toAccount.name : 'N/A'}</div>
          <div class="text-sm text-muted">${date} - ${transaction.description || 'No description'}</div>
        </div>
        <div class="text-right">
          <div class="font-medium">₹${transaction.amount.toLocaleString()}</div>
          <div class="text-xs badge badge-secondary">${transaction.type}</div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// Update outstanding payments on dashboard
function updateOutstandingPayments() {
  const container = document.getElementById('outstandingPayments');
  const outstanding = accounts.filter(acc => 
    (acc.type === 'customer' && acc.balance > 0) || 
    (acc.type === 'supplier' && acc.balance < 0)
  ).slice(0, 5);
  
  if (outstanding.length === 0) {
    container.innerHTML = '<p class="text-center text-muted">No outstanding payments</p>';
    return;
  }
  
  let html = '<div class="grid grid-cols-1 gap-2">';
  
  outstanding.forEach(account => {
    const amount = Math.abs(account.balance);
    const isReceivable = account.balance > 0;
    
    html += `
      <div class="flex justify-between items-center p-2 border-b border-gray-100">
        <div>
          <div class="font-medium">${account.name}</div>
          <div class="text-sm text-muted">${account.type}</div>
        </div>
        <div class="text-right">
          <div class="font-medium ${isReceivable ? 'positive' : 'negative'}">₹${amount.toLocaleString()}</div>
          <div class="text-xs badge ${isReceivable ? 'badge-success' : 'badge-danger'}">${isReceivable ? 'Receivable' : 'Payable'}</div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// Filter transactions based on selected filters
function filterTransactions() {
  renderTransactionsTable();
}

// Show modal function
function showModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
}

// Close modal function
function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// Show add account modal
function showAddAccountModal() {
  // Reset form
  document.getElementById('accountName').value = '';
  document.getElementById('accountType').value = 'customer';
  document.getElementById('accountBalance').value = '0';
  document.getElementById('accountContact').value = '';
  
  showModal('addAccountModal');
}

// Show add transaction modal
function showAddTransactionModal() {
  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('transactionDate').value = today;
  
  // Reset form
  document.getElementById('transactionType').value = 'sale';
  document.getElementById('transactionAmount').value = '';
  document.getElementById('transactionDescription').value = '';
  
  toggleTransactionFields();
  showModal('addTransactionModal');
}

// View account details
function viewAccount(accountId) {
  const account = accounts.find(acc => acc.id === accountId);
  if (account) {
    alert(`Account Details:\nName: ${account.name}\nType: ${account.type}\nBalance: ₹${account.balance.toLocaleString()}\nContact: ${account.contact || 'N/A'}`);
  }
}

// Edit account
function editAccount(accountId) {
  const account = accounts.find(acc => acc.id === accountId);
  if (account) {
    document.getElementById('accountName').value = account.name;
    document.getElementById('accountType').value = account.type;
    document.getElementById('accountBalance').value = account.balance;
    document.getElementById('accountContact').value = account.contact || '';
    
    // In a real application, you would set up the modal for editing
    // and handle the update process differently
    showModal('addAccountModal');
    alert('Edit functionality would be implemented here.');
  }
}

// View transaction details
function viewTransaction(transactionId) {
  const transaction = transactions.find(t => t.id === transactionId);
  if (transaction) {
    const fromAccount = accounts.find(acc => acc.id === transaction.fromAccountId);
    const toAccount = accounts.find(acc => acc.id === transaction.toAccountId);
    const date = new Date(transaction.date).toLocaleDateString();
    
    alert(`Transaction Details:\nDate: ${date}\nType: ${transaction.type}\nFrom: ${fromAccount ? fromAccount.name : 'N/A'}\nTo: ${toAccount ? toAccount.name : 'N/A'}\nAmount: ₹${transaction.amount.toLocaleString()}\nDescription: ${transaction.description || 'N/A'}`);
  }
}

// Edit transaction
function editTransaction(transactionId) {
  const transaction = transactions.find(t => t.id === transactionId);
  if (transaction) {
    const date = new Date(transaction.date).toISOString().split('T')[0];
    
    document.getElementById('transactionDate').value = date;
    document.getElementById('transactionType').value = transaction.type;
    document.getElementById('transactionAmount').value = transaction.amount;
    document.getElementById('transactionDescription').value = transaction.description || '';
    
    // In a real application, you would set the account dropdowns
    // and handle the update process differently
    showModal('addTransactionModal');
    alert('Edit functionality would be implemented here.');
  }
}

// Generate profit and loss report
function generateProfitLossReport() {
  const now = new Date();
  const startOfYear = new Date(now.getFullYear(), 0, 1);
  
  // Calculate total income (sales)
  const income = transactions
    .filter(t => t.type === 'sale' && new Date(t.date) >= startOfYear)
    .reduce((sum, t) => sum + t.amount, 0);
  
  // Calculate total expenses (purchases)
  const expenses = transactions
    .filter(t => t.type === 'purchase' && new Date(t.date) >= startOfYear)
    .reduce((sum, t) => sum + t.amount, 0);
  
  const netProfit = income - expenses;
  
  const reportContainer = document.getElementById('reportContainer');
  reportContainer.innerHTML = `
    <h4 class="font-medium mb-4">Profit & Loss Statement (${now.getFullYear()})</h4>
    <div class="grid grid-cols-1 gap-4">
      <div class="flex justify-between p-3 bg-gray-50 rounded">
        <span>Total Income:</span>
        <span class="font-medium">₹${income.toLocaleString()}</span>
      </div>
      <div class="flex justify-between p-3 bg-gray-50 rounded">
        <span>Total Expenses:</span>
        <span class="font-medium">₹${expenses.toLocaleString()}</span>
      </div>
      <div class="flex justify-between p-3 ${netProfit >= 0 ? 'bg-green-50' : 'bg-red-50'} rounded">
        <span>Net Profit/Loss:</span>
        <span class="font-medium ${netProfit >= 0 ? 'positive' : 'negative'}">₹${Math.abs(netProfit).toLocaleString()}</span>
      </div>
    </div>
  `;
}

// Generate balance sheet report
function generateBalanceSheet() {
  // Calculate total assets
  const assets = accounts
    .filter(acc => ['bank', 'cash', 'asset'].includes(acc.type) && acc.balance > 0)
    .reduce((sum, acc) => sum + acc.balance, 0);
  
  // Calculate total liabilities
  const liabilities = accounts
    .filter(acc => ['liability'].includes(acc.type) && acc.balance < 0)
    .reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
  
  // Calculate equity (assets - liabilities)
  const equity = assets - liabilities;
  
  const reportContainer = document.getElementById('reportContainer');
  reportContainer.innerHTML = `
    <h4 class="font-medium mb-4">Balance Sheet</h4>
    <div class="grid grid-cols-1 gap-4">
      <div class="p-3 bg-gray-50 rounded">
        <h5 class="font-medium mb-2">Assets</h5>
        <div class="flex justify-between">
          <span>Total Assets:</span>
          <span class="font-medium">₹${assets.toLocaleString()}</span>
        </div>
      </div>
      <div class="p-3 bg-gray-50 rounded">
        <h5 class="font-medium mb-2">Liabilities</h5>
        <div class="flex justify-between">
          <span>Total Liabilities:</span>
          <span class="font-medium">₹${liabilities.toLocaleString()}</span>
        </div>
      </div>
      <div class="p-3 bg-green-50 rounded">
        <h5 class="font-medium mb-2">Equity</h5>
        <div class="flex justify-between">
          <span>Owner's Equity:</span>
          <span class="font-medium positive">₹${equity.toLocaleString()}</span>
        </div>
      </div>
    </div>
  `;
}

// Generate ledger report
function generateLedgerReport() {
  let html = `
    <h4 class="font-medium mb-4">General Ledger</h4>
    <div class="grid grid-cols-1 gap-4">
  `;
  
  accounts.forEach(account => {
    const accountTransactions = transactions.filter(t => 
      t.fromAccountId === account.id || t.toAccountId === account.id
    );
    
    if (accountTransactions.length > 0) {
      html += `
        <div class="p-3 bg-gray-50 rounded">
          <h5 class="font-medium mb-2">${account.name} (${account.type})</h5>
          <div class="text-sm text-muted mb-2">Balance: ₹${account.balance.toLocaleString()}</div>
          <div class="grid grid-cols-1 gap-1">
      `;
      
      accountTransactions.forEach(transaction => {
        const date = new Date(transaction.date).toLocaleDateString();
        const isDebit = transaction.toAccountId === account.id;
        const amount = isDebit ? transaction.amount : -transaction.amount;
        
        html += `
          <div class="flex justify-between text-sm">
            <span>${date} - ${transaction.description || 'No description'}</span>
            <span class="${amount >= 0 ? 'positive' : 'negative'}">${amount >= 0 ? '+' : ''}₹${Math.abs(amount).toLocaleString()}</span>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    }
  });
  
  html += `</div>`;
  document.getElementById('reportContainer').innerHTML = html;
}

// Clear duplicates
async function clearDuplicates() {
  if (!validateAdminPassword()) return;
  
  if (confirm('Are you sure you want to clear duplicate transactions? This action cannot be undone.')) {
    showLoader();
    // In a real application, you would implement duplicate detection and removal
    setTimeout(() => {
      hideLoader();
      alert('Duplicate clearing functionality would be implemented here.');
    }, 1000);
  }
}

// Clear cache
async function clearCache() {
  if (!validateAdminPassword()) return;
  
  if (confirm('Are you sure you want to clear the cache? This will force reload all data.')) {
    showLoader();
    setTimeout(async () => {
      await loadAccounts();
      await loadTransactions();
      hideLoader();
      alert('Cache cleared successfully!');
    }, 1000);
  }
}

// Reset system
async function resetSystem() {
  if (!validateAdminPassword()) return;
  
  if (confirm('WARNING: Are you sure you want to reset the system? This will delete all data and cannot be undone!')) {
    showLoader();
    // In a real application, you would implement a proper reset function
    setTimeout(() => {
      hideLoader();
      alert('System reset functionality would be implemented here.');
    }, 1000);
  }
}

// Validate admin password
function validateAdminPassword() {
  const password = document.getElementById('adminPassword').value;
  if (password === '1234') {
    return true;
  } else {
    alert('Incorrect admin password!');
    return false;
  }
}

// Enable admin buttons when correct password is entered
document.getElementById('adminPassword').addEventListener('input', function() {
  const password = this.value;
  const isEnabled = password === '1234';
  
  document.getElementById('clearDuplicatesBtn').disabled = !isEnabled;
  document.getElementById('clearCacheBtn').disabled = !isEnabled;
  document.getElementById('resetSystemBtn').disabled = !isEnabled;
});

// Show loader
function showLoader() {
  document.getElementById('loader').style.display = 'flex';
}

// Hide loader
function hideLoader() {
  document.getElementById('loader').style.display = 'none';
}

// Navigation functionality
document.querySelectorAll('.nav-btn').forEach(button => {
  button.addEventListener('click', function() {
    // Update active button
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    
    // Show corresponding section
    const sectionId = this.getAttribute('data-section') + '-section';
    document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
    document.getElementById(sectionId).classList.remove('hidden');
  });
});

// Initialize the application when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Set default date filters to current month
  const now = new Date();
  const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  document.getElementById('startDateFilter').value = firstDayOfMonth.toISOString().split('T')[0];
  document.getElementById('endDateFilter').value = lastDayOfMonth.toISOString().split('T')[0];
  
  // Initialize the app
  initApp();
});
</script>
</body>
</html>
