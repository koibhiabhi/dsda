<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aditya Ledger — Accounting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    :root{--bg:#f6faf9;--card:#fff;--muted:#5b6b73;--accent:#0f766e;--danger:#b91c1c;--ok:#047857}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#07223b}
    header{display:flex;align-items:center;padding:12px 16px;background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    header .title{font-weight:700}
    main{display:flex;gap:18px;padding:18px}
    aside{width:320px;background:var(--card);border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    section{flex:1}
    .card{background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 6px 18px rgba(2,6,23,0.03)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e9f0ef;margin-bottom:8px}
    button{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #e6efed}
    .row{display:flex;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f1f5f4;text-align:left}
    .badge{padding:6px 8px;border-radius:8px;font-weight:700;color:#fff}
    .badge.pending{background:#f59e0b}
    .badge.received{background:var(--ok)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .search{display:flex;gap:8px;margin-bottom:8px}
    .small{font-size:12px;color:var(--muted)}
    footer{padding:12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>

<header>
  <div class="title">Aditya Ledger</div>
  <div style="margin-left:auto" class="muted">Status: <span id="status">Initializing…</span></div>
</header>

<main>
  <aside>
    <div class="card">
      <label>Company</label>
      <select id="companySelect"></select>
      <div class="row" style="margin-top:8px">
        <input id="newCompanyName" placeholder="New company name" />
        <button id="addCompanyBtn" class="ghost">Add</button>
      </div>
      <hr/>
      <div class="small">Quick actions</div>
      <div class="controls" style="margin-top:8px">
        <button id="openAddEntry">Add Entry</button>
        <button id="openSearch">Search</button>
        <button id="exportCSV" class="ghost">Export CSV</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700">Outstanding summary</div>
      <div id="outstandingList" class="small" style="margin-top:8px">Loading…</div>
    </div>

    <div class="card">
      <div style="font-weight:700">Admin</div>
      <div class="small" id="adminEmail">—</div>
      <div style="margin-top:8px"><button id="signOutBtn" class="ghost">Sign out</button></div>
    </div>
  </aside>

  <section>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Ledger — <span id="companyNameLabel">Select company</span></div>
        <div class="small">Entries: <span id="entryCount">0</span></div>
      </div>
      <div style="margin-top:10px">
        <div class="search">
          <input id="searchInput" placeholder="Search by party / material / note / entry id" />
          <select id="typeFilter"><option value="">All types</option><option value="purchase">Purchase</option><option value="sale">Sale</option></select>
          <select id="paymentFilter"><option value="">All payments</option><option value="pending">Pending</option><option value="received">Received</option></select>
          <button id="applyFilters" class="ghost">Apply</button>
        </div>
        <div id="ledgerTableWrap"></div>
      </div>
    </div>

    <div id="modalRoot"></div>
  </section>
</main>

<footer>© Ledger built from your fertilizer portal code.</footer>

<script>
/* ========== Config (extracted from your file) ========== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBEybu3XKeK3QOeRIMs-fK2dDwHtpCTqgQ",
  authDomain: "aditya-supply-chain-b5f61.firebaseapp.com",
  projectId: "aditya-supply-chain-b5f61",
  storageBucket: "aditya-supply-chain-b5f61.firebasestorage.app",
  messagingSenderId: "662836162599",
  appId: "1:662836162599:web:2b49bde530e4b87924de02",
  measurementId: "G-DQH00BNH1L"
};
// Admin credentials (extracted). Use responsibly.
const AUTO_SIGNIN = true;
const ADMIN_EMAIL = 'adityajainaas@gmail.com';
const ADMIN_PWD = 'Aditya@1609';
/* ======================================================= */

firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.firestore();

let currentCompanyId = null;
let lastEntries = [];
let lastMaterials = [];

/* UI helpers */
const statusEl = document.getElementById('status');
const adminEmailEl = document.getElementById('adminEmail');
const companySelect = document.getElementById('companySelect');
const companyNameLabel = document.getElementById('companyNameLabel');
const entryCountEl = document.getElementById('entryCount');
const ledgerWrap = document.getElementById('ledgerTableWrap');
const outstandingList = document.getElementById('outstandingList');

function showStatus(t){ statusEl.textContent = t; }
function showModal(html){ document.getElementById('modalRoot').innerHTML = `<div style="position:fixed;inset:0;background:rgba(2,6,23,0.35);display:flex;align-items:center;justify-content:center;z-index:999"><div style="background:#fff;padding:16px;border-radius:8px;max-width:900px;width:94%;max-height:90vh;overflow:auto">${html}</div></div>`; }
function closeModal(){ document.getElementById('modalRoot').innerHTML = ''; }
function toINR(x){ return x===undefined||x===null||x===''? '-' : '₹' + Number(x).toLocaleString('en-IN',{maximumFractionDigits:2}); }
function fmtDate(ts){ if(!ts) return '-'; if(ts.toDate) return ts.toDate().toLocaleString('en-IN'); return new Date(ts).toLocaleString('en-IN'); }

/* Auto sign-in */
auth.onAuthStateChanged(u=>{
  if(u){ adminEmailEl.textContent = u.email || u.uid; showStatus('Signed in'); loadCompanies(); }
  else { adminEmailEl.textContent = 'Not signed'; showStatus('Signed out'); }
});

async function autoSignIn(){ if(!AUTO_SIGNIN) return; try{ showStatus('Signing in…'); await auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PWD); }catch(e){ alert('Auto sign-in failed: '+e.message); showStatus('Sign-in error'); } }

/* Load companies into menu */
async function loadCompanies(){
  companySelect.innerHTML = '';
  const snap = await db.collection('companies').orderBy('name').get();
  snap.forEach(doc=>{
    const opt = document.createElement('option');
    opt.value = doc.id; opt.textContent = doc.data().name;
    companySelect.appendChild(opt);
  });
  if(companySelect.options.length){
    if(!currentCompanyId) currentCompanyId = companySelect.options[0].value;
    companySelect.value = currentCompanyId;
    companyNameLabel.textContent = companySelect.options[companySelect.selectedIndex].textContent;
    startCompanyListeners(currentCompanyId);
  } else {
    companyNameLabel.textContent = 'No company';
    ledgerWrap.innerHTML = '<div class="small muted">No companies found. Add one in the left panel.</div>';
  }
}

/* Add company */
document.getElementById('addCompanyBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('newCompanyName').value.trim();
  if(!name) return alert('Enter name');
  const nameNorm = name.trim().toLowerCase();
  try{
    const existing = await db.collection('companies').where('name_lower','==',nameNorm).get();
    if(!existing.empty) return alert('Company exists');
    const docRef = db.collection('companies').doc();
    await docRef.set({ name, name_lower:nameNorm, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    document.getElementById('newCompanyName').value='';
    await loadCompanies();
  }catch(e){ alert('Create failed: '+e.message) }
});

/* When user picks a company */
companySelect.addEventListener('change', ()=>{
  if(companySelect.value === currentCompanyId) return;
  currentCompanyId = companySelect.value;
  companyNameLabel.textContent = companySelect.options[companySelect.selectedIndex].textContent;
  startCompanyListeners(currentCompanyId);
});

/* Listeners for materials & entries for chosen company */
let matsUnsub = null, entsUnsub = null;
function clearUnsubs(){ if(typeof matsUnsub === 'function') matsUnsub(); if(typeof entsUnsub === 'function') entsUnsub(); matsUnsub = entsUnsub = null; lastEntries=[]; lastMaterials=[]; }

function startCompanyListeners(companyId){
  if(!companyId) return;
  clearUnsubs();
  const matsRef = db.collection('companies').doc(companyId).collection('materials').orderBy('name');
  matsUnsub = matsRef.onSnapshot(snap=>{ lastMaterials = snap.docs.map(d=>({id:d.id,...d.data()})); renderLedger(); }, err=>console.error(err));

  const entriesRef = db.collection('companies').doc(companyId).collection('entries').orderBy('createdAt','desc').limit(5000);
  entsUnsub = entriesRef.onSnapshot(snap=>{ lastEntries = snap.docs.map(d=>({id:d.id,...d.data()})); renderLedger(); }, err=>console.error(err));

  // company doc for metadata
  db.collection('companies').doc(companyId).onSnapshot(d=>{
    const dd=d.data()||{}; document.getElementById('companyNameLabel').textContent = dd.name || '—';
  });
}

/* Core: render ledger table with filters */
function renderLedger(){
  const q = document.getElementById('searchInput')?.value?.toLowerCase() || '';
  const typeFilter = document.getElementById('typeFilter')?.value || '';
  const paymentFilter = document.getElementById('paymentFilter')?.value || '';

  let rows = lastEntries.slice();
  if(typeFilter) rows = rows.filter(r=>r.type===typeFilter);
  if(paymentFilter) rows = rows.filter(r=> (r.paymentStatus||'pending') === paymentFilter);
  if(q){
    rows = rows.filter(r=>{
      return (r.party||'').toLowerCase().includes(q) ||
             (r.note||'').toLowerCase().includes(q) ||
             (r.materialId||'').toLowerCase().includes(q) ||
             (r.id||'').toLowerCase().includes(q);
    });
  }

  entryCountEl.textContent = rows.length;
  // build table
  if(rows.length===0){ ledgerWrap.innerHTML = '<div class="small muted">No entries for the selected filters.</div>'; updateOutstanding(); return; }

  const html = ['<table><thead><tr>',
    '<th>Date</th><th>Type</th><th>Material/Item</th><th>Qty</th><th>Amount</th><th>Party</th><th>Payment</th><th>Actions</th>',
    '</tr></thead><tbody>'];

  for(const e of rows){
    const mat = lastMaterials.find(m=>m.id===e.materialId);
    const matName = mat ? mat.name : (e.material || e.materialId || '—');
    const payment = e.paymentStatus || 'pending';
    const badge = `<span class="badge ${payment==='received'?'received':'pending'}">${payment==='received'?'Received':'Pending'}</span>`;
    const date = fmtDate(e.createdAt) || '-';
    html.push(`<tr>
      <td class="small">${date}</td>
      <td class="small">${e.type||'—'}</td>
      <td>${escapeHtml(matName)}</td>
      <td class="small">${Number(e.bags||0)} ${e.unit||''}</td>
      <td>${toINR(e.totalValue||0)}</td>
      <td class="small">${escapeHtml(e.party||'—')}</td>
      <td class="small">${badge}${e.amountPaid?('<div class="small">Paid: '+toINR(e.amountPaid)+'</div>'):''}</td>
      <td class="small">
        <button class="ghost" onclick="openEditEntry('${e.id}')">Edit</button>
        <button class="ghost" onclick="openTogglePayment('${e.id}')">${payment==='pending'?'Mark Received':'Mark Pending'}</button>
        <button class="ghost" onclick="openDeleteEntry('${e.id}')">Delete</button>
      </td>
    </tr>`);
  }

  html.push('</tbody></table>');
  ledgerWrap.innerHTML = html.join('');
  updateOutstanding();
}

/* Outstanding summary: group by party net pending amounts */
function updateOutstanding(){
  const pending = lastEntries.filter(e=> (e.paymentStatus||'pending') === 'pending');
  const map = {};
  pending.forEach(p=>{
    const key = (p.party || 'Unknown').trim() || 'Unknown';
    map[key] = (map[key]||0) + Number(p.totalValue||0);
  });
  const items = Object.keys(map).sort((a,b)=>map[b]-map[a]).slice(0,10);
  if(items.length===0){ outstandingList.innerHTML = '<div class="small muted">No pending payments</div>'; return; }
  outstandingList.innerHTML = items.map(k=>`<div style="display:flex;justify-content:space-between;padding:6px 0"><div>${escapeHtml(k)}</div><div style="font-weight:700">${toINR(map[k])}</div></div>`).join('');
}

/* Escape helper */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Add Entry modal */
document.getElementById('openAddEntry').addEventListener('click', ()=> openAddEntryModal());

function openAddEntryModal(pref){
  if(!currentCompanyId) return alert('Select company first');
  const matOptions = lastMaterials.map(m=>`<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
  showModal(`
    <div style="font-weight:700">Add ledger entry</div><hr>
    <label>Type</label><select id="ae_type"><option value="purchase">Purchase</option><option value="sale">Sale</option></select>
    <label>Material / Item</label><select id="ae_mat">${matOptions}</select>
    <label>Qty (bags)</label><input id="ae_qty" type="number" step="0.01" value="1" />
    <label>Price per bag</label><input id="ae_price" type="number" step="0.01" value="" />
    <label>Total value</label><input id="ae_total" type="number" step="0.01" />
    <label>Party (Supplier / Customer)</label><input id="ae_party" />
    <label>Note</label><input id="ae_note" />
    <label>Payment status</label><select id="ae_payment"><option value="pending">Pending</option><option value="received">Received</option></select>
    <label>Amount Paid (if any)</label><input id="ae_amountPaid" type="number" step="0.01" />
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button class="ghost" id="ae_cancel">Cancel</button>
      <button id="ae_save">Save</button>
    </div>
  `);
  document.getElementById('ae_cancel').onclick = closeModal;
  document.getElementById('ae_save').onclick = async ()=>{
    const type = document.getElementById('ae_type').value;
    const matId = document.getElementById('ae_mat').value;
    const qty = Number(document.getElementById('ae_qty').value) || 0;
    const price = document.getElementById('ae_price').value ? Number(document.getElementById('ae_price').value) : null;
    const total = document.getElementById('ae_total').value ? Number(document.getElementById('ae_total').value) : (qty*(price||0));
    const party = document.getElementById('ae_party').value || '';
    const note = document.getElementById('ae_note').value || '';
    const paymentStatus = document.getElementById('ae_payment').value || 'pending';
    const amountPaid = document.getElementById('ae_amountPaid').value ? Number(document.getElementById('ae_amountPaid').value) : 0;
    await addEntryTransaction(matId,type,qty,price,party,note,total,paymentStatus,amountPaid);
    closeModal();
  };
}

/* Add entry using transaction (keeps stock and avg correct) */
async function addEntryTransaction(materialId,type,bagsCount,pricePerBag,party,note,totalValue,paymentStatus,amountPaid){
  if(!currentCompanyId) return alert('Select company');
  const companyRef = db.collection('companies').doc(currentCompanyId);
  const matRef = companyRef.collection('materials').doc(materialId);
  const entriesRef = companyRef.collection('entries');
  try{
    await db.runTransaction(async tx=>{
      const matSnap = await tx.get(matRef);
      if(!matSnap.exists) throw new Error('Material not found');
      const mat = matSnap.data();
      const currentStock = (mat.stockBags!==undefined && mat.stockBags!==null) ? Number(mat.stockBags||0) : 0;
      const currentAvg = (mat.pricePerBag!==undefined && mat.pricePerBag!==null) ? Number(mat.pricePerBag) : null;
      const entryRef = entriesRef.doc();
      const totalVal = Number(totalValue|| (bagsCount*(pricePerBag||0)));
      if(type==='purchase'){
        let newAvg = currentAvg;
        if(currentStock<=0 || currentAvg===null){
          if(pricePerBag!==null) newAvg = pricePerBag;
        } else {
          if(pricePerBag!==null){
            const numerator = (currentStock*currentAvg) + (bagsCount*pricePerBag);
            const denominator = (currentStock + bagsCount);
            newAvg = denominator>0 ? (numerator/denominator) : currentAvg;
          }
        }
        const newStock = currentStock + bagsCount;
        tx.set(entryRef,{
          type:'purchase', materialId, bags:bagsCount, unit:'bags', pricePerBag: pricePerBag||null, totalValue: totalVal,
          party:party, note:note, paymentStatus: paymentStatus || 'pending', amountPaid: amountPaid || 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        tx.update(matRef, { stockBags: Math.round(newStock*100)/100, pricePerBag: (newAvg!==null?Math.round(newAvg*100)/100:null), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } else if(type==='sale'){
        const costPerBag = (currentAvg!==null)?currentAvg:0;
        const costTotal = Math.round((bagsCount*costPerBag)*100)/100;
        const newStock = currentStock - bagsCount;
        if(newStock < -0.0001) throw new Error('Not enough stock');
        tx.set(entryRef,{
          type:'sale', materialId, bags:bagsCount, unit:'bags', pricePerBag: pricePerBag||null, totalValue: totalVal,
          costPerBag: Math.round(costPerBag*100)/100, costTotal,
          party:party, note:note, paymentStatus: paymentStatus || 'pending', amountPaid: amountPaid || 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        tx.update(matRef, { stockBags: Math.round(newStock*100)/100, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      } else throw new Error('Unknown type');
      tx.update(companyRef, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
  }catch(err){ alert('Save failed: '+err.message); console.error(err); }
}

/* Edit entry (open modal) */
window.openEditEntry = async function(entryId){
  if(!currentCompanyId) return;
  const doc = await db.collection('companies').doc(currentCompanyId).collection('entries').doc(entryId).get();
  if(!doc.exists) return alert('Entry not found');
  const e = doc.data();
  const matOptions = lastMaterials.map(m=>`<option value="${m.id}" ${m.id===e.materialId?'selected':''}>${escapeHtml(m.name)}</option>`).join('');
  showModal(`
    <div style="font-weight:700">Edit entry</div><hr>
    <label>Type</label><select id="ee_type"><option value="purchase">Purchase</option><option value="sale">Sale</option></select>
    <label>Material</label><select id="ee_mat">${matOptions}</select>
    <label>Qty</label><input id="ee_qty" type="number" value="${e.bags||0}" />
    <label>Price per bag</label><input id="ee_price" type="number" value="${e.pricePerBag||''}" />
    <label>Total value</label><input id="ee_total" type="number" value="${e.totalValue||''}" />
    <label>Party</label><input id="ee_party" value="${escapeHtml(e.party||'')}" />
    <label>Note</label><input id="ee_note" value="${escapeHtml(e.note||'')}" />
    <label>Payment status</label><select id="ee_payment"><option value="pending">Pending</option><option value="received">Received</option></select>
    <label>Amount Paid</label><input id="ee_amountPaid" type="number" value="${e.amountPaid||0}" />
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button class="ghost" id="ee_cancel">Cancel</button>
      <button id="ee_save">Save</button>
    </div>
  `);
  document.getElementById('ee_type').value = e.type;
  document.getElementById('ee_payment').value = e.paymentStatus || 'pending';
  document.getElementById('ee_cancel').onclick = closeModal;
  document.getElementById('ee_save').onclick = async ()=>{
    const newType = document.getElementById('ee_type').value;
    const newMat = document.getElementById('ee_mat').value;
    const newQty = Number(document.getElementById('ee_qty').value) || 0;
    const newPrice = document.getElementById('ee_price').value ? Number(document.getElementById('ee_price').value) : null;
    const newTotal = document.getElementById('ee_total').value ? Number(document.getElementById('ee_total').value) : (newQty*(newPrice||0));
    const newParty = document.getElementById('ee_party').value || '';
    const newNote = document.getElementById('ee_note').value || '';
    const newPayment = document.getElementById('ee_payment').value || 'pending';
    const newAmountPaid = document.getElementById('ee_amountPaid').value ? Number(document.getElementById('ee_amountPaid').value) : 0;
    try{
      const entryRef = db.collection('companies').doc(currentCompanyId).collection('entries').doc(entryId);
      const old = (await entryRef.get()).data();
      await entryRef.update({
        type:newType, materialId:newMat, bags:newQty, pricePerBag:newPrice||null, totalValue:newTotal,
        party:newParty, note:newNote, paymentStatus:newPayment, amountPaid:newAmountPaid, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      // rebuild affected materials to fix cost basis
      await rebuildMaterialFromEntries(newMat);
      if(newMat !== old.materialId) await rebuildMaterialFromEntries(old.materialId);
      alert('Updated');
      closeModal();
    }catch(e){ alert('Update failed: '+e.message); console.error(e); }
  };
}

/* Toggle payment status (quick) */
window.openTogglePayment = async function(entryId){
  if(!currentCompanyId) return;
  const ref = db.collection('companies').doc(currentCompanyId).collection('entries').doc(entryId);
  const d = (await ref.get()).data();
  if(!d) return alert('Not found');
  const newStatus = (d.paymentStatus||'pending') === 'pending' ? 'received' : 'pending';
  const amountPaid = newStatus==='received' ? (d.totalValue || 0) : (d.amountPaid || 0);
  await ref.update({ paymentStatus: newStatus, amountPaid, paymentDate: newStatus==='received' ? firebase.firestore.FieldValue.serverTimestamp() : null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
  alert('Payment status updated');
};

/* Delete entry */
window.openDeleteEntry = async function(entryId){
  if(!currentCompanyId) return;
  if(!confirm('Delete this entry? This will adjust stock & cost basis.')) return;
  try{
    const entryRef = db.collection('companies').doc(currentCompanyId).collection('entries').doc(entryId);
    const doc = await entryRef.get();
    if(!doc.exists) throw new Error('Entry not found');
    const e = doc.data();
    await entryRef.delete();
    await rebuildMaterialFromEntries(e.materialId);
    alert('Deleted and stock adjusted');
  }catch(e){ alert('Delete failed: '+e.message) }
}

/* Rebuild material from entries (same logic as original) */
async function rebuildMaterialFromEntries(materialId){
  if(!currentCompanyId || !materialId) return;
  const companyRef = db.collection('companies').doc(currentCompanyId);
  const matsRef = companyRef.collection('materials').doc(materialId);
  const entriesRef = companyRef.collection('entries');
  try{
    const snap = await entriesRef.where('materialId','==',materialId).orderBy('createdAt','asc').get();
    let stock=0, avg=null;
    const batch = db.batch();
    for(const doc of snap.docs){
      const e = doc.data(); const id = doc.id;
      const bags = Number(e.bags||0); const price = (e.pricePerBag!==undefined && e.pricePerBag!==null) ? Number(e.pricePerBag) : null;
      if(e.type==='purchase'){
        if(stock<=0 || avg===null){ if(price!==null) avg=price; }
        else { if(price!==null){ const numerator=(stock*avg)+(bags*price); const denom=(stock+bags); avg = denom>0 ? (numerator/denom) : avg; } }
        stock += bags;
        batch.update(entriesRef.doc(id), { totalValue: bags*(price||0), pricePerBag: price||null });
      } else if(e.type==='sale'){
        const costPerBag = (avg!==null)?avg:0;
        const costTotal = Math.round((bags*costPerBag)*100)/100;
        batch.update(entriesRef.doc(id), { costPerBag: Math.round(costPerBag*100)/100, costTotal, pricePerBag: e.pricePerBag||null, totalValue: e.totalValue || (bags*(e.pricePerBag||0)) });
        stock -= bags;
      }
    }
    if(!snap.empty) await batch.commit();
    await matsRef.update({ stockBags: Math.round(stock*100)/100, pricePerBag: (avg!==null?Math.round(avg*100)/100:null), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
  }catch(e){ console.error('rebuild failed', e); }
}

/* Filters apply */
document.getElementById('applyFilters').addEventListener('click', renderLedger);

/* Search button (opens small modal for advanced search) */
document.getElementById('openSearch').addEventListener('click', ()=> showModal(`
  <div style="font-weight:700">Search ledger</div><hr>
  <label>Query</label><input id="ms_q" placeholder="party / material / note / id" />
  <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
    <button class="ghost" id="ms_cancel">Close</button>
    <button id="ms_go">Search</button>
  </div>
`), () => {});
document.body.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'ms_cancel') closeModal();
  if(e.target && e.target.id === 'ms_go'){ const q = document.getElementById('ms_q').value; document.getElementById('searchInput').value = q; closeModal(); renderLedger(); }
});

/* Export CSV */
document.getElementById('exportCSV').addEventListener('click', async ()=>{
  showStatus('Preparing CSV…');
  try{
    const rows = [];
    rows.push(['companyId','companyName','entryId','type','materialId','bags','pricePerBag','totalValue','costPerBag','costTotal','party','note','paymentStatus','amountPaid','createdAt']);
    const companiesSnap = await db.collection('companies').orderBy('name').get();
    for(const cdoc of companiesSnap.docs){
      const cid = cdoc.id; const cname = cdoc.data().name;
      const entSnap = await cdoc.ref.collection('entries').orderBy('createdAt','desc').get();
      if(entSnap.empty) continue;
      entSnap.forEach(e=>{
        const ed = e.data();
        rows.push([cid,cname,e.id,ed.type||'',ed.materialId||'',ed.bags||'',ed.pricePerBag||'',ed.totalValue||'',ed.costPerBag||'',ed.costTotal||'',ed.party||'',(ed.note||'').replace(/\r?\n|\r/g,' '),ed.paymentStatus||'pending',ed.amountPaid||0,ed.createdAt? (ed.createdAt.toDate?ed.createdAt.toDate().toLocaleString('en-IN'):ed.createdAt):'']);
      });
    }
    const csv = rows.map(r=> r.map(cell=>{
      if(cell===null||cell===undefined) return '';
      const s = String(cell);
      if(s.includes('"')) return `"${s.replace(/"/g,'""')}"`;
      if(s.includes(',') || s.includes('\n')) return `"${s}"`; return s;
    }).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ledger_export.csv'; document.body.appendChild(a); a.click(); a.remove();
    alert('CSV exported');
  }catch(e){ alert('Export failed: '+e.message); console.error(e); }
  finally{ showStatus('Ready'); }
});

/* Sign out */
document.getElementById('signOutBtn').addEventListener('click', ()=> auth.signOut());

/* Helpers to seed sample behavior if needed (not used automatically) */
async function ensureCompanyExists(name='Default Co'){ const snap = await db.collection('companies').where('name_lower','==',name.toLowerCase()).get(); if(!snap.empty) return snap.docs[0].id; const d=db.collection('companies').doc(); await d.set({name, name_lower:name.toLowerCase(), createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp()}); return d.id; }

/* Kick off */
(async function init(){
  showStatus('Initializing ledger…');
  try{ await autoSignIn(); await loadCompanies(); showStatus('Ready'); }catch(e){ console.error('init error',e); showStatus('Error'); }
})();
</script>
</body>
</html>
